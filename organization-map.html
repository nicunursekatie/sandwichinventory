<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recipient Organization Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #236383 0%, #007E8C 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            border-radius: 12px 12px 0 0;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        h1 {
            color: #236383;
            margin-bottom: 10px;
        }

        .filters {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-group label {
            font-size: 14px;
            font-weight: 600;
            color: #2d3748;
        }

        select, input[type="text"] {
            padding: 8px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #e2e8f0;
        }

        .stat {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 600;
            color: #236383;
        }

        .stat-label {
            font-size: 13px;
            color: #666;
        }

        #map {
            height: 700px;
            border-radius: 0 0 12px 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .legend {
            position: absolute;
            bottom: 30px;
            right: 30px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
        }

        .legend-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #236383;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
            font-size: 13px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid #333;
        }

        .popup-content h3 {
            color: #236383;
            margin-bottom: 10px;
        }

        .popup-field {
            margin-bottom: 8px;
            font-size: 13px;
        }

        .popup-field strong {
            color: #2d3748;
        }

        .loading {
            text-align: center;
            padding: 40px;
            background: white;
            border-radius: 12px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üó∫Ô∏è Recipient Organization Map</h1>
            <p style="color: #666; margin-top: 5px;">Visual directory of partner organizations</p>

            <div class="filters">
                <div class="filter-group">
                    <label>Partnership Length:</label>
                    <select id="filterPartnership">
                        <option value="all">All</option>
                        <option value="Less than 1 year">Less than 1 year</option>
                        <option value="1 year">1 year</option>
                        <option value="2 years">2 years</option>
                        <option value="3 years">3 years</option>
                        <option value="4 years">4 years</option>
                        <option value="5 years">5 years</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label>Seasonal Needs:</label>
                    <select id="filterSeasonal">
                        <option value="all">All</option>
                        <option value="Yes">Yes</option>
                        <option value="No">No</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label>Search:</label>
                    <input type="text" id="searchBox" placeholder="Organization name...">
                </div>

                <button onclick="resetFilters()" style="background: #FBAD3F; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">Reset</button>
            </div>

            <div class="stats">
                <div class="stat">
                    <div>
                        <div class="stat-value" id="totalOrgs">0</div>
                        <div class="stat-label">Organizations</div>
                    </div>
                </div>
                <div class="stat">
                    <div>
                        <div class="stat-value" id="avgRating">-</div>
                        <div class="stat-label">Avg Delivery Rating</div>
                    </div>
                </div>
                <div class="stat">
                    <div>
                        <div class="stat-value" id="totalPeople">0</div>
                        <div class="stat-label">People Served</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="map"></div>

        <div class="legend">
            <div class="legend-title">Partnership Length</div>
            <div class="legend-item">
                <div class="legend-color" style="background: #236383;"></div>
                <span>5 years</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #007E8C;"></div>
                <span>3-4 years</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #FBAD3F;"></div>
                <span>1-2 years</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #A31C41;"></div>
                <span>Less than 1 year</span>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBJ9sUwY_gw2bYWXCffV0RKuQkXqRq-hTU",
            authDomain: "recipient-survey.firebaseapp.com",
            databaseURL: "https://recipient-survey-default-rtdb.firebaseio.com",
            projectId: "recipient-survey",
            storageBucket: "recipient-survey.firebasestorage.app",
            messagingSenderId: "1023665626622",
            appId: "1:1023665626622:web:6c9be3dcaddeec30d674af",
            measurementId: "G-CQY41G3NW6"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let map;
        let markers = [];
        let allOrganizations = [];

        // Initialize map centered on Atlanta
        function initMap() {
            map = L.map('map').setView([33.7490, -84.3880], 10);

            // Use CartoDB Positron - clean, minimal grayscale style
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '¬© OpenStreetMap contributors ¬© CARTO',
                maxZoom: 18
            }).addTo(map);
        }

        // Get marker color based on partnership length (using TSP brand colors)
        function getMarkerColor(years) {
            if (!years) return '#47B3CB';
            if (years.includes('5')) return '#236383';      // Dark blue - longest partnership
            if (years.includes('3') || years.includes('4')) return '#007E8C';  // Teal - established
            if (years.includes('1') || years.includes('2')) return '#FBAD3F';  // Orange - growing
            return '#A31C41';  // Burgundy - new partnership
        }

        // Geocode address using Nominatim (free, no API key needed)
        async function geocodeAddress(address, city, state, zip) {
            const fullAddress = `${address}, ${city}, ${state} ${zip}`;
            const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(fullAddress)}`;

            try {
                const response = await fetch(url);
                const data = await response.json();
                if (data && data.length > 0) {
                    return {
                        lat: parseFloat(data[0].lat),
                        lng: parseFloat(data[0].lon)
                    };
                }
            } catch (error) {
                console.error('Geocoding error:', error);
            }
            return null;
        }

        // Create marker for organization
        function createMarker(org) {
            if (!org.coordinates) return null;

            const color = getMarkerColor(org.yearsReceivingSandwiches);

            const icon = L.divIcon({
                className: 'custom-marker',
                html: `<div style="background: ${color}; width: 24px; height: 24px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"></div>`,
                iconSize: [24, 24],
                iconAnchor: [12, 12]
            });

            const marker = L.marker([org.coordinates.lat, org.coordinates.lng], { icon })
                .bindPopup(createPopupContent(org));

            marker.orgData = org;
            return marker;
        }

        // Create popup content
        function createPopupContent(org) {
            return `
                <div class="popup-content">
                    <h3>${org.orgName}</h3>
                    <div class="popup-field"><strong>Contact:</strong> ${org.contactName}</div>
                    <div class="popup-field"><strong>Email:</strong> ${org.contactEmail}</div>
                    <div class="popup-field"><strong>Phone:</strong> ${org.contactPhone}</div>
                    <div class="popup-field"><strong>Service Area:</strong> ${org.serviceArea || 'Not provided'}</div>
                    <div class="popup-field"><strong>People Served:</strong> ${org.avgPeopleServed || '?'} ${org.frequency || ''}</div>
                    <div class="popup-field"><strong>Partnership:</strong> ${org.yearsReceivingSandwiches || 'Not provided'}</div>
                    <div class="popup-field"><strong>Delivery Rating:</strong> ${org.deliveryRating || '?'}/5</div>
                    ${org.seasonalNeeds === 'Yes' ? `<div class="popup-field" style="color: #007E8C;"><strong>üìÖ Has Seasonal Needs</strong></div>` : ''}
                </div>
            `;
        }

        // Load and display organizations
        async function loadOrganizations() {
            const snapshot = await database.ref('survey-responses').once('value');
            const data = snapshot.val();

            if (!data) {
                document.getElementById('totalOrgs').textContent = '0';
                return;
            }

            // Process each organization
            for (const [id, org] of Object.entries(data)) {
                org.id = id;

                // Try to geocode if we have address
                if (org.streetAddress && org.city && org.state && org.zipCode) {
                    org.coordinates = await geocodeAddress(
                        org.streetAddress,
                        org.city,
                        org.state,
                        org.zipCode
                    );
                }

                allOrganizations.push(org);
            }

            displayOrganizations(allOrganizations);
            updateStats(allOrganizations);
        }

        // Display organizations on map
        function displayOrganizations(orgs) {
            // Clear existing markers
            markers.forEach(m => map.removeLayer(m));
            markers = [];

            // Add new markers
            orgs.forEach(org => {
                const marker = createMarker(org);
                if (marker) {
                    marker.addTo(map);
                    markers.push(marker);
                }
            });

            // Fit bounds if we have markers
            if (markers.length > 0) {
                const group = L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }

        // Update statistics
        function updateStats(orgs) {
            document.getElementById('totalOrgs').textContent = orgs.length;

            // Calculate average rating
            const ratings = orgs.filter(o => o.deliveryRating).map(o => parseInt(o.deliveryRating));
            const avgRating = ratings.length > 0
                ? (ratings.reduce((a, b) => a + b, 0) / ratings.length).toFixed(1)
                : '-';
            document.getElementById('avgRating').textContent = avgRating;

            // Calculate total people served (approximate)
            const totalPeople = orgs.reduce((sum, org) => {
                const count = parseInt(org.avgPeopleServed) || 0;
                const multiplier = org.frequency === 'Per Week' ? 52 :
                                 org.frequency === 'Per Month' ? 12 : 365;
                return sum + (count * multiplier);
            }, 0);
            document.getElementById('totalPeople').textContent = totalPeople.toLocaleString();
        }

        // Filter organizations
        function filterOrganizations() {
            const partnershipFilter = document.getElementById('filterPartnership').value;
            const seasonalFilter = document.getElementById('filterSeasonal').value;
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();

            const filtered = allOrganizations.filter(org => {
                if (partnershipFilter !== 'all' && org.yearsReceivingSandwiches !== partnershipFilter) {
                    return false;
                }
                if (seasonalFilter !== 'all' && org.seasonalNeeds !== seasonalFilter) {
                    return false;
                }
                if (searchTerm && !org.orgName.toLowerCase().includes(searchTerm)) {
                    return false;
                }
                return true;
            });

            displayOrganizations(filtered);
            updateStats(filtered);
        }

        function resetFilters() {
            document.getElementById('filterPartnership').value = 'all';
            document.getElementById('filterSeasonal').value = 'all';
            document.getElementById('searchBox').value = '';
            filterOrganizations();
        }

        // Add event listeners
        document.getElementById('filterPartnership').addEventListener('change', filterOrganizations);
        document.getElementById('filterSeasonal').addEventListener('change', filterOrganizations);
        document.getElementById('searchBox').addEventListener('input', filterOrganizations);

        // Initialize
        initMap();
        loadOrganizations();
    </script>
</body>
</html>
