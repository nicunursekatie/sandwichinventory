<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Donation Receipt Generator - The Sandwich Project</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #236383 0%, #007e8c 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            max-width: 700px;
            width: 100%;
            padding: 40px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #fbad3f;
        }

        .logo {
            max-width: 200px;
            margin-bottom: 15px;
        }

        h1 {
            color: #236383;
            font-size: 28px;
            margin-bottom: 8px;
        }

        .subtitle {
            color: #007e8c;
            font-size: 16px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            color: #236383;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }

        input, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #47b3cb;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus, textarea:focus {
            outline: none;
            border-color: #007e8c;
        }

        textarea {
            resize: vertical;
            min-height: 60px;
            font-family: inherit;
        }

        .row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .btn {
            background: linear-gradient(135deg, #fbad3f 0%, #a31c41 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 6px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(163, 28, 65, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .info-text {
            background: #f0f8ff;
            border-left: 4px solid #47b3cb;
            padding: 15px;
            margin-bottom: 25px;
            border-radius: 4px;
            color: #236383;
            font-size: 13px;
            line-height: 1.5;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
        }

        .tab:hover {
            color: #236383;
        }

        .tab.active {
            color: #236383;
            border-bottom-color: #fbad3f;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .file-upload {
            border: 2px dashed #47b3cb;
            border-radius: 6px;
            padding: 30px;
            text-align: center;
            background: #f9f9f9;
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-upload:hover {
            border-color: #007e8c;
            background: #f0f8ff;
        }

        .file-upload input[type="file"] {
            display: none;
        }

        .file-upload-label {
            display: block;
            cursor: pointer;
            color: #236383;
            font-weight: 600;
        }

        .file-info {
            margin-top: 15px;
            padding: 15px;
            background: #e8f5e9;
            border-radius: 6px;
            display: none;
        }

        .file-info.show {
            display: block;
        }

        .batch-preview {
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            background: #fafafa;
        }

        .batch-preview table {
            width: 100%;
            border-collapse: collapse;
        }

        .batch-preview th,
        .batch-preview td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
            font-size: 13px;
        }

        .batch-preview th {
            background: #236383;
            color: white;
            font-weight: 600;
        }

        .batch-preview tr:hover {
            background: #f0f0f0;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #47b3cb 0%, #007e8c 100%);
        }

        .donation-type-group {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 6px;
            border: 2px solid #47b3cb;
        }

        .donation-type-option {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .donation-type-option input[type="radio"] {
            width: auto;
            margin: 0;
            cursor: pointer;
        }

        .donation-type-option label {
            margin: 0;
            cursor: pointer;
            font-weight: 600;
            color: #236383;
        }

        @media (max-width: 600px) {
            .row {
                grid-template-columns: 1fr;
            }

            .container {
                padding: 25px;
            }

            h1 {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="sandwich logo.png" alt="The Sandwich Project" class="logo">
            <h1>Donation Receipt Generator</h1>
            <p class="subtitle">Official Acknowledgment Letter for Corporate Matching</p>
        </div>

        <div class="info-text">
            <strong>For Benevity & Corporate Matching:</strong> This generator creates official donation acknowledgment letters with all required elements including EIN, donation details, and the required "no goods or services" statement.
        </div>

        <div class="tabs">
            <button type="button" class="tab active" onclick="switchTab('single')">Single Receipt</button>
            <button type="button" class="tab" onclick="switchTab('batch')">Batch Process</button>
        </div>

        <!-- Single Receipt Form -->
        <div id="single-tab" class="tab-content active">
            <form id="receiptForm">
            <div class="row">
                <div class="form-group">
                    <label for="donorName">Donor Name *</label>
                    <input type="text" id="donorName" required>
                </div>
                <div class="form-group">
                    <label for="donationDate">Donation Date *</label>
                    <input type="date" id="donationDate" required>
                </div>
            </div>

            <div class="form-group">
                <label>Donation Type *</label>
                <div class="donation-type-group">
                    <div class="donation-type-option">
                        <input type="radio" id="donationTypeInKind" name="donationType" value="in-kind" checked>
                        <label for="donationTypeInKind">In-Kind Donation</label>
                    </div>
                    <div class="donation-type-option">
                        <input type="radio" id="donationTypeCash" name="donationType" value="cash">
                        <label for="donationTypeCash">Cash Donation</label>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label for="donationDescription">Donation Description</label>
                <input type="text" id="donationDescription"
                       value="Prepared sandwiches made from groceries" placeholder="e.g., Prepared sandwiches made from groceries">
            </div>

            <div class="row">
                <div class="form-group">
                    <label for="donationValue">Donation Value ($) *</label>
                    <input type="number" id="donationValue" step="0.01" min="0"
                           value="122.00" required>
                </div>
                <div class="form-group">
                    <label for="letterDate">Letter Date *</label>
                    <input type="date" id="letterDate" required>
                </div>
            </div>

            <div class="form-group">
                <label for="organizationEIN">Organization EIN *</label>
                <input type="text" id="organizationEIN"
                       value="87-0939484" required>
            </div>

            <div class="form-group">
                <label for="organizationAddress">Organization Address *</label>
                <textarea id="organizationAddress" rows="2" required>5074 Wickford Way, Dunwoody, GA 30338</textarea>
            </div>

            <div class="row">
                <div class="form-group">
                    <label for="signerName">Signer Name *</label>
                    <input type="text" id="signerName" required>
                </div>
                <div class="form-group">
                    <label for="signerTitle">Signer Title *</label>
                    <input type="text" id="signerTitle"
                           placeholder="e.g., Executive Director" required>
                </div>
            </div>

            <div class="form-group">
                <label for="signatureSelector">Signature Image (Optional)</label>
                <select id="signatureSelector" style="width: 100%; padding: 12px; border: 2px solid #47b3cb; border-radius: 6px; font-size: 14px; margin-bottom: 10px;">
                    <option value="">No signature (use signature line)</option>
                    <option value="Katie Long.png">Katie Long</option>
                    <option value="Christine Cooper Nowicki.png">Christine Cooper Nowicki</option>
                    <option value="custom">Upload custom signature...</option>
                </select>
                <input type="file" id="signatureImage" accept="image/*" style="display: none;">
                <div style="font-size: 12px; color: #666; margin-top: 5px;">Select a saved signature or upload your own</div>
                <div id="signaturePreview" style="margin-top: 10px; display: none;">
                    <img id="signaturePreviewImg" style="max-width: 200px; max-height: 80px; border: 1px solid #ddd; border-radius: 4px;" alt="Signature preview">
                </div>
            </div>

                <button type="submit" class="btn">Generate PDF Receipt</button>
            </form>
        </div>

        <!-- Batch Processing Form -->
        <div id="batch-tab" class="tab-content">
            <form id="batchForm">
                <div class="info-text" style="margin-bottom: 20px;">
                    <strong>Excel Format Required:</strong> Your Excel file should have headers in the first row: <strong>date</strong>, <strong>person</strong>, <strong>email</strong>, <strong>amount</strong>
                </div>

                <div class="form-group">
                    <label>Upload Excel File (.xlsx or .xls) *</label>
                    <div class="file-upload" onclick="document.getElementById('excelFile').click()">
                        <input type="file" id="excelFile" accept=".xlsx,.xls" required>
                        <label for="excelFile" class="file-upload-label">
                            <div style="font-size: 48px; margin-bottom: 10px;">üìÅ</div>
                            Click to upload Excel file
                            <div style="font-size: 12px; color: #666; margin-top: 5px;">Supports .xlsx and .xls files</div>
                        </label>
                    </div>
                    <div id="fileInfo" class="file-info">
                        <strong>File loaded:</strong> <span id="fileName"></span><br>
                        <strong>Rows found:</strong> <span id="rowCount"></span>
                    </div>
                </div>

                <div id="batchPreview" class="batch-preview" style="display: none;">
                    <h3 style="margin-bottom: 10px; color: #236383; font-size: 16px;">Preview (first 10 rows):</h3>
                    <table id="previewTable"></table>
                </div>

                <div class="row">
                    <div class="form-group">
                        <label for="batchSignerName">Signer Name *</label>
                        <input type="text" id="batchSignerName" required>
                    </div>
                    <div class="form-group">
                        <label for="batchSignerTitle">Signer Title *</label>
                        <input type="text" id="batchSignerTitle" placeholder="e.g., Executive Director" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="batchSignatureSelector">Signature Image (Optional)</label>
                    <select id="batchSignatureSelector" style="width: 100%; padding: 12px; border: 2px solid #47b3cb; border-radius: 6px; font-size: 14px; margin-bottom: 10px;">
                        <option value="">No signature (use signature line)</option>
                        <option value="Katie Long.png">Katie Long</option>
                        <option value="Christine Cooper Nowicki.png">Christine Cooper Nowicki</option>
                        <option value="custom">Upload custom signature...</option>
                    </select>
                    <input type="file" id="batchSignatureImage" accept="image/*" style="display: none;">
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">Select a saved signature or upload your own</div>
                    <div id="batchSignaturePreview" style="margin-top: 10px; display: none;">
                        <img id="batchSignaturePreviewImg" style="max-width: 200px; max-height: 80px; border: 1px solid #ddd; border-radius: 4px;" alt="Signature preview">
                    </div>
                </div>

                <div class="form-group">
                    <label for="batchOrganizationEIN">Organization EIN *</label>
                    <input type="text" id="batchOrganizationEIN" value="87-0939484" required>
                </div>

                <div class="form-group">
                    <label for="batchOrganizationAddress">Organization Address *</label>
                    <textarea id="batchOrganizationAddress" rows="2" required>5074 Wickford Way, Dunwoody, GA 30338</textarea>
                </div>

                <div class="form-group">
                    <label>Donation Type *</label>
                    <div class="donation-type-group">
                        <div class="donation-type-option">
                            <input type="radio" id="batchDonationTypeInKind" name="batchDonationType" value="in-kind" checked>
                            <label for="batchDonationTypeInKind">In-Kind Donation</label>
                        </div>
                        <div class="donation-type-option">
                            <input type="radio" id="batchDonationTypeCash" name="batchDonationType" value="cash">
                            <label for="batchDonationTypeCash">Cash Donation</label>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="batchDonationDescription">Donation Description</label>
                    <input type="text" id="batchDonationDescription" value="Prepared sandwiches made from groceries" placeholder="e.g., Prepared sandwiches made from groceries">
                </div>

                <div class="form-group">
                    <label for="batchLetterDate">Letter Date *</label>
                    <input type="date" id="batchLetterDate" required>
                </div>

                <div class="info-text" style="margin-top: 10px; margin-bottom: 15px;">
                    <strong>Optional: Email receipts instead of downloading</strong><br>
                    To enable email sending, deploy the Firebase Function and paste the Function URL + token below. Use <strong>Send Test Email</strong> before sending all.
                </div>

                <div class="row">
                    <div class="form-group">
                        <label for="receiptFunctionUrl">Receipt Email Function URL</label>
                        <input type="text" id="receiptFunctionUrl" placeholder="https://us-central1-YOUR_PROJECT.cloudfunctions.net/sendDonationReceiptEmail" value="https://us-central1-donation-receipt-generator.cloudfunctions.net/sendDonationReceiptEmail">
                    </div>
                    <div class="form-group">
                        <label for="receiptFunctionToken">Receipt Function Token</label>
                        <input type="password" id="receiptFunctionToken" placeholder="(set in Firebase functions config)">
                    </div>
                </div>

                <div class="row">
                    <div class="form-group">
                        <label for="testEmailOverride">Test Email Override (recommended)</label>
                        <input type="email" id="testEmailOverride" placeholder="your.email@domain.com">
                    </div>
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <div style="font-size: 12px; color: #666; line-height: 1.4; padding-top: 4px;">
                            Test send will email the <strong>first row</strong> receipt to this address (or the row email if left blank).
                        </div>
                    </div>
                </div>

                <div style="display: flex; gap: 10px;">
                    <button type="button" class="btn" id="batchTestBtn" disabled style="flex: 1; background: linear-gradient(135deg, #47b3cb 0%, #007e8c 100%);">Generate Test Receipt (First Row)</button>
                    <button type="button" class="btn" id="batchTestSendBtn" disabled style="flex: 1; background: linear-gradient(135deg, #236383 0%, #007e8c 100%);">Send Test Email (First Row)</button>
                    <button type="submit" class="btn btn-secondary" id="batchGenerateBtn" disabled style="flex: 1;">Generate All PDFs</button>
                </div>

                <button type="button" class="btn btn-secondary" id="batchSendAllBtn" disabled style="margin-top: 10px;">Send All Emails (No Downloads)</button>
            </form>
        </div>
    </div>

    <script>
        // Set today's date as default for letter date
        document.getElementById('letterDate').valueAsDate = new Date();
        document.getElementById('batchLetterDate').valueAsDate = new Date();

        // Persist Email Function settings (so you don't paste every time)
        (function initReceiptEmailSettings() {
            const urlEl = document.getElementById('receiptFunctionUrl');
            const tokenEl = document.getElementById('receiptFunctionToken');
            const testEmailEl = document.getElementById('testEmailOverride');
            if (!urlEl || !tokenEl || !testEmailEl) return;

            const STORAGE_KEY = 'tsp_receipt_email_settings_v1';
            try {
                const saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
                if (saved.url && typeof saved.url === 'string') urlEl.value = saved.url;
                if (saved.token && typeof saved.token === 'string') tokenEl.value = saved.token;
                if (saved.testEmail && typeof saved.testEmail === 'string') testEmailEl.value = saved.testEmail;
            } catch (_) {
                // ignore
            }

            function save() {
                try {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify({
                        url: (urlEl.value || '').trim(),
                        token: (tokenEl.value || '').trim(),
                        testEmail: (testEmailEl.value || '').trim()
                    }));
                } catch (_) {
                    // ignore
                }
            }

            urlEl.addEventListener('change', save);
            tokenEl.addEventListener('change', save);
            testEmailEl.addEventListener('change', save);
        })();

        // Signature image handlers
        let signatureImageData = null;
        let batchSignatureImageData = null;

        // Available signature files
        const availableSignatures = {
            'Katie Long.png': 'Katie Long.png',
            'Christine Cooper Nowicki.png': 'Christine Cooper Nowicki.png'
        };

        // Function to load signature from file
        function loadSignatureFromFile(filename, previewImgId, previewDivId, dataVar) {
            const img = new Image();
            img.onload = function() {
                // Convert to data URL for use in PDF
                const canvas = document.createElement('canvas');
                canvas.width = img.width;
                canvas.height = img.height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0);
                const dataUrl = canvas.toDataURL('image/png');
                
                if (dataVar === 'single') {
                    signatureImageData = dataUrl;
                    document.getElementById(previewImgId).src = dataUrl;
                    document.getElementById(previewDivId).style.display = 'block';
                } else {
                    batchSignatureImageData = dataUrl;
                    document.getElementById(previewImgId).src = dataUrl;
                    document.getElementById(previewDivId).style.display = 'block';
                }
            };
            img.onerror = function() {
                alert('Error loading signature image: ' + filename);
            };
            img.src = filename;
        }

        // Single receipt signature selector
        document.getElementById('signatureSelector').addEventListener('change', function(e) {
            const value = e.target.value;
            if (value === '') {
                signatureImageData = null;
                document.getElementById('signaturePreview').style.display = 'none';
                document.getElementById('signatureImage').style.display = 'none';
            } else if (value === 'custom') {
                document.getElementById('signatureImage').style.display = 'block';
                document.getElementById('signatureImage').click();
            } else if (availableSignatures[value]) {
                document.getElementById('signatureImage').style.display = 'none';
                loadSignatureFromFile(value, 'signaturePreviewImg', 'signaturePreview', 'single');
            }
        });

        document.getElementById('signatureImage').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    signatureImageData = e.target.result;
                    document.getElementById('signaturePreviewImg').src = signatureImageData;
                    document.getElementById('signaturePreview').style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                signatureImageData = null;
                document.getElementById('signaturePreview').style.display = 'none';
            }
        });

        // Batch signature selector
        document.getElementById('batchSignatureSelector').addEventListener('change', function(e) {
            const value = e.target.value;
            if (value === '') {
                batchSignatureImageData = null;
                document.getElementById('batchSignaturePreview').style.display = 'none';
                document.getElementById('batchSignatureImage').style.display = 'none';
            } else if (value === 'custom') {
                document.getElementById('batchSignatureImage').style.display = 'block';
                document.getElementById('batchSignatureImage').click();
            } else if (availableSignatures[value]) {
                document.getElementById('batchSignatureImage').style.display = 'none';
                loadSignatureFromFile(value, 'batchSignaturePreviewImg', 'batchSignaturePreview', 'batch');
            }
        });

        document.getElementById('batchSignatureImage').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    batchSignatureImageData = e.target.result;
                    document.getElementById('batchSignaturePreviewImg').src = batchSignatureImageData;
                    document.getElementById('batchSignaturePreview').style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                batchSignatureImageData = null;
                document.getElementById('batchSignaturePreview').style.display = 'none';
            }
        });

        // Tab switching
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            if (tab === 'single') {
                document.querySelector('.tab:first-child').classList.add('active');
                document.getElementById('single-tab').classList.add('active');
            } else {
                document.querySelector('.tab:last-child').classList.add('active');
                document.getElementById('batch-tab').classList.add('active');
            }
        }

        // Excel file parsing
        let batchData = [];
        
        document.getElementById('excelFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

                    if (jsonData.length < 2) {
                        alert('Excel file must have at least a header row and one data row.');
                        return;
                    }

                    // Get headers and normalize them
                    const headers = jsonData[0].map(h => String(h).toLowerCase().trim());
                    const dateIdx = headers.findIndex(h => h.includes('date'));
                    const personIdx = headers.findIndex(h => h.includes('person') || h.includes('name'));
                    const emailIdx = headers.findIndex(h => h.includes('email'));
                    const amountIdx = headers.findIndex(h => h.includes('amount') || h.includes('value') || h.includes('donation'));

                    if (dateIdx === -1 || personIdx === -1 || amountIdx === -1) {
                        alert('Required columns not found. Please ensure your Excel file has columns: date, person, amount (and optionally email).');
                        return;
                    }

                    // Parse data rows
                    batchData = [];
                    for (let i = 1; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        if (!row[dateIdx] || !row[personIdx] || !row[amountIdx]) continue; // Skip empty rows

                        // Handle date parsing
                        let dateValue = row[dateIdx];
                        if (!dateValue) continue; // Skip if date is empty
                        
                        if (dateValue instanceof Date) {
                            // Already a Date object
                            dateValue = dateValue;
                        } else if (typeof dateValue === 'number') {
                            // Excel date serial number
                            try {
                                const parsed = XLSX.SSF.parse_date_code(dateValue);
                                dateValue = new Date(parsed.y, parsed.m - 1, parsed.d);
                            } catch (e) {
                                // If parsing fails, try treating as timestamp
                                dateValue = new Date((dateValue - 25569) * 86400 * 1000);
                            }
                        } else if (typeof dateValue === 'string') {
                            dateValue = new Date(dateValue);
                        }
                        
                        // Validate date
                        if (isNaN(dateValue.getTime())) {
                            console.warn(`Invalid date in row ${i + 1}: ${row[dateIdx]}`);
                            continue; // Skip invalid dates
                        }

                        batchData.push({
                            date: dateValue,
                            person: String(row[personIdx]).trim(),
                            email: emailIdx !== -1 ? (row[emailIdx] ? String(row[emailIdx]).trim() : '') : '',
                            amount: parseFloat(row[amountIdx]) || 0
                        });
                    }

                    if (batchData.length === 0) {
                        alert('No valid data rows found in the Excel file.');
                        return;
                    }

                    // Show file info
                    document.getElementById('fileName').textContent = file.name;
                    document.getElementById('rowCount').textContent = batchData.length;
                    document.getElementById('fileInfo').classList.add('show');

                    // Show preview
                    showPreview(batchData);
                    document.getElementById('batchGenerateBtn').disabled = false;
                    document.getElementById('batchTestBtn').disabled = false;
                    document.getElementById('batchTestSendBtn').disabled = false;
                    document.getElementById('batchSendAllBtn').disabled = false;
                } catch (error) {
                    alert('Error reading Excel file: ' + error.message);
                    console.error(error);
                }
            };
            reader.readAsArrayBuffer(file);
        });

        function showPreview(data) {
            const preview = document.getElementById('batchPreview');
            const table = document.getElementById('previewTable');
            preview.style.display = 'block';

            const previewData = data.slice(0, 10);
            let html = '<thead><tr><th>Date</th><th>Person</th><th>Email</th><th>Amount</th></tr></thead><tbody>';
            
            previewData.forEach(row => {
                const dateStr = row.date instanceof Date ? row.date.toLocaleDateString() : String(row.date);
                html += `<tr>
                    <td>${dateStr}</td>
                    <td>${row.person}</td>
                    <td>${row.email || '‚Äî'}</td>
                    <td>$${row.amount.toFixed(2)}</td>
                </tr>`;
            });
            
            html += '</tbody>';
            if (data.length > 10) {
                html += `<tfoot><tr><td colspan="4" style="text-align: center; padding: 10px; color: #666;">... and ${data.length - 10} more rows</td></tr></tfoot>`;
            }
            
            table.innerHTML = html;
        }

        // Reusable PDF generation function - returns a Promise
        // options.mode:
        // - "download" (default): triggers browser download
        // - "email": returns { pdfBase64, filename } without downloading
        function generateReceiptPDF(receiptData, options = { mode: 'download' }) {
            return new Promise((resolve) => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                const {
                    donorName,
                    donationDate,
                    letterDate,
                    donationDescription,
                    donationValue,
                    ein,
                    address,
                    signerName,
                    signerTitle,
                    donationType = 'in-kind',
                    signatureImage = null
                } = receiptData;

                const donationDateFormatted = donationDate instanceof Date 
                    ? donationDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })
                    : new Date(donationDate).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                
                const letterDateFormatted = letterDate instanceof Date
                    ? letterDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })
                    : new Date(letterDate).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

                const donationValueFormatted = parseFloat(donationValue).toFixed(2);

                const logoImg = new Image();

                function finalizePdfAndResolve(fileName) {
                    if (options?.mode === 'email') {
                        // data:application/pdf;filename=generated.pdf;base64,....
                        const dataUri = doc.output('datauristring');
                        const base64 = dataUri.split(',')[1] || '';
                        resolve({ pdfBase64: base64, filename: fileName });
                        return;
                    }
                    doc.save(fileName);
                    resolve({ filename: fileName });
                }

                function generatePDFContent(hasLogo, logoWidth, logoHeight, sigImgData) {
                    let yPos = hasLogo ? 15 + logoHeight + 10 : 25;

                    // Add logo if available
                    if (hasLogo) {
                        doc.addImage(logoImg, 'PNG', (210 - logoWidth) / 2, 15, logoWidth, logoHeight);
                    }

                    // Header - Organization name (centered, blue)
                    doc.setFontSize(18);
                    doc.setFont('times', 'bold');
                    doc.setTextColor(35, 99, 131); // #236383
                    doc.text('The Sandwich Project', 105, yPos, { align: 'center' });
                    yPos += 8;

                    // EIN (centered)
                    doc.setFontSize(10);
                    doc.setFont('times', 'normal');
                    doc.text(`EIN: ${ein}`, 105, yPos, { align: 'center' });
                    yPos += 6;

                    // Address (centered, handle multi-line)
                    const addressLines = doc.splitTextToSize(address, 160);
                    addressLines.forEach(line => {
                        doc.text(line, 105, yPos, { align: 'center' });
                        yPos += 5;
                    });

                    yPos += 5;

                    // Horizontal line (orange)
                    doc.setDrawColor(251, 173, 63); // #fbad3f
                    doc.setLineWidth(0.5);
                    doc.line(20, yPos, 190, yPos);
                    yPos += 10;

                    // Letter date
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(11);
                    doc.setFont('times', 'normal');
                    doc.text(`Date: ${letterDateFormatted}`, 20, yPos);
                    yPos += 12;

                    // Salutation
                    doc.setFont('times', 'normal');
                    doc.text(`Dear ${donorName},`, 20, yPos);
                    yPos += 8;

                    // Body paragraph
                    doc.setFontSize(11);
                    doc.setFont('times', 'normal');
                    let bodyText;
                    if (donationType === 'cash') {
                        if (donationDescription && donationDescription.trim()) {
                            bodyText = `This letter acknowledges your monetary contribution of $${donationValueFormatted} to The Sandwich Project on ${donationDateFormatted}. Your contribution was designated for ${donationDescription.trim().toLowerCase()}.`;
                        } else {
                            bodyText = `This letter acknowledges your monetary contribution of $${donationValueFormatted} to The Sandwich Project on ${donationDateFormatted}.`;
                        }
                    } else {
                        // In-kind donation - handle with or without description
                        if (donationDescription && donationDescription.trim()) {
                            // Clean up description if it redundantly mentions "The Sandwich Project"
                            let cleanDescription = donationDescription.trim();
                            if (cleanDescription.toLowerCase().includes('the sandwich project')) {
                                cleanDescription = cleanDescription.replace(/for donation to The Sandwich Project/gi, '');
                                cleanDescription = cleanDescription.replace(/to The Sandwich Project/gi, '');
                                cleanDescription = cleanDescription.trim();
                            }
                            bodyText = `This letter acknowledges your in-kind donation of ${cleanDescription.toLowerCase()} to The Sandwich Project on ${donationDateFormatted}. Your donation is valued at $${donationValueFormatted}.`;
                        } else {
                            // No description provided - use generic wording
                            bodyText = `This letter acknowledges your in-kind contribution to The Sandwich Project on ${donationDateFormatted}, valued at $${donationValueFormatted}.`;
                        }
                    }
                    const bodyLines = doc.splitTextToSize(bodyText, 170);
                    bodyLines.forEach(line => {
                        doc.text(line, 20, yPos);
                        yPos += 6;
                    });

                    yPos += 4;

                    // No goods or services statement (bold, teal)
                    doc.setFont('times', 'bold');
                    doc.setTextColor(0, 126, 140); // #007e8c
                    const noGoodsText = 'No goods or services were provided in exchange for this contribution.';
                    const noGoodsLines = doc.splitTextToSize(noGoodsText, 170);
                    noGoodsLines.forEach(line => {
                        doc.text(line, 20, yPos);
                        yPos += 6;
                    });

                    yPos += 6;

                    // Thank you paragraph
                    doc.setFont('times', 'normal');
                    doc.setTextColor(0, 0, 0);
                    const thankYouText = 'Thank you for your support in fighting food insecurity in our community. Your generosity makes a meaningful difference in the lives of those we serve.';
                    const thankYouLines = doc.splitTextToSize(thankYouText, 170);
                    thankYouLines.forEach(line => {
                        doc.text(line, 20, yPos);
                        yPos += 6;
                    });

                    yPos += 6;

                    // Closing
                    doc.setFont('times', 'normal');
                    doc.text('Sincerely,', 20, yPos);
                    yPos += 6;

                    // Signature - either image or line
                    if (signatureImage) {
                        // Add signature image
                        const sigImg = new Image();
                        
                        sigImg.onload = function() {
                            // Calculate dimensions to fit nicely (max width 60mm, maintain aspect ratio)
                            const maxWidth = 60;
                            const maxHeight = 25;
                            let sigWidth = sigImg.width;
                            let sigHeight = sigImg.height;
                            
                            // Scale to fit
                            const widthRatio = maxWidth / sigWidth;
                            const heightRatio = maxHeight / sigHeight;
                            const ratio = Math.min(widthRatio, heightRatio);
                            
                            sigWidth = sigWidth * ratio;
                            sigHeight = sigHeight * ratio;
                            
                            doc.addImage(sigImg, 'PNG', 20, yPos, sigWidth, sigHeight);
                            
                            // Signer name and title below signature (reduced spacing)
                            yPos += sigHeight + 1;
                            doc.setFont('times', 'normal');
                            doc.setFontSize(11);
                            doc.text(signerName, 20, yPos);
                            yPos += 3;
                            doc.setFontSize(10);
                            doc.setFont('times', 'italic');
                            doc.text(signerTitle, 20, yPos);
                            
                            // Footer note
                            doc.setFontSize(8);
                            doc.setTextColor(71, 179, 203); // #47b3cb
                            doc.text('Please retain this letter for your tax records and corporate matching submission.', 105, 280, { align: 'center' });
                            
                            // Generate filename with identifying information
                            const dateStr = donationDate instanceof Date 
                                ? donationDate.toISOString().split('T')[0]
                                : new Date(donationDate).toISOString().split('T')[0];
                            const cleanDonorName = donorName.replace(/[^a-zA-Z0-9\s]/g, '').replace(/\s+/g, '_');
                            const amountStr = donationValueFormatted.replace('.', '_');
                            const fileName = `Donation_Receipt_${cleanDonorName}_${dateStr}_$${amountStr}.pdf`;
                            
                            finalizePdfAndResolve(fileName);
                        };
                        
                        sigImg.onerror = function() {
                            // Fallback to line if image fails to load
                            doc.setDrawColor(0, 0, 0);
                            doc.setLineWidth(0.3);
                            doc.line(20, yPos, 80, yPos);
                            yPos += 3;
                            
                            doc.setFont('times', 'normal');
                            doc.setFontSize(11);
                            doc.text(signerName, 20, yPos);
                            yPos += 3;
                            doc.setFontSize(10);
                            doc.setFont('times', 'italic');
                            doc.text(signerTitle, 20, yPos);
                            
                            // Footer note
                            doc.setFontSize(8);
                            doc.setTextColor(71, 179, 203); // #47b3cb
                            doc.text('Please retain this letter for your tax records and corporate matching submission.', 105, 280, { align: 'center' });
                            
                            // Generate filename with identifying information
                            const dateStr = donationDate instanceof Date 
                                ? donationDate.toISOString().split('T')[0]
                                : new Date(donationDate).toISOString().split('T')[0];
                            const cleanDonorName = donorName.replace(/[^a-zA-Z0-9\s]/g, '').replace(/\s+/g, '_');
                            const amountStr = donationValueFormatted.replace('.', '_');
                            const fileName = `Donation_Receipt_${cleanDonorName}_${dateStr}_$${amountStr}.pdf`;
                            
                            finalizePdfAndResolve(fileName);
                        };

                        // IMPORTANT: attach handlers before setting src to avoid missing cached/data-url load events
                        sigImg.src = signatureImage;
                    } else {
                        // Signature line (no image)
                        doc.setDrawColor(0, 0, 0);
                        doc.setLineWidth(0.3);
                        doc.line(20, yPos, 80, yPos);
                        yPos += 3;

                        // Signer name and title (reduced spacing)
                        doc.setFont(undefined, 'normal');
                        doc.setFontSize(11);
                        doc.text(signerName, 20, yPos);
                        yPos += 4;
                        doc.setFontSize(10);
                        doc.text(signerTitle, 20, yPos);
                        
                        // Footer note
                        doc.setFontSize(8);
                        doc.setTextColor(71, 179, 203); // #47b3cb
                        doc.text('Please retain this letter for your tax records and corporate matching submission.', 105, 280, { align: 'center' });
                        
                        // Generate filename with identifying information
                        const dateStr = donationDate instanceof Date 
                            ? donationDate.toISOString().split('T')[0]
                            : new Date(donationDate).toISOString().split('T')[0];
                        const cleanDonorName = donorName.replace(/[^a-zA-Z0-9\s]/g, '').replace(/\s+/g, '_');
                        const amountStr = donationValueFormatted.replace('.', '_');
                        const fileName = `Donation_Receipt_${cleanDonorName}_${dateStr}_$${amountStr}.pdf`;
                        
                        finalizePdfAndResolve(fileName);
                    }
                }

                // IMPORTANT: attach handlers before setting src to avoid missing cached load events
                logoImg.onload = function() {
                    const logoWidth = 50;
                    const logoHeight = (logoImg.height / logoImg.width) * logoWidth;
                    generatePDFContent(true, logoWidth, logoHeight, signatureImage);
                };

                logoImg.onerror = function() {
                    generatePDFContent(false, 0, 0, signatureImage);
                };

                logoImg.src = 'sandwich logo.png';
            });
        }

        // Single receipt form handler
        document.getElementById('receiptForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const donationType = document.querySelector('input[name="donationType"]:checked').value;
            
            const receiptData = {
                donorName: document.getElementById('donorName').value,
                donationDate: document.getElementById('donationDate').value,
                letterDate: document.getElementById('letterDate').value,
                donationDescription: document.getElementById('donationDescription').value,
                donationValue: document.getElementById('donationValue').value,
                ein: document.getElementById('organizationEIN').value,
                address: document.getElementById('organizationAddress').value,
                signerName: document.getElementById('signerName').value,
                signerTitle: document.getElementById('signerTitle').value,
                donationType: donationType,
                signatureImage: signatureImageData
            };

            generateReceiptPDF(receiptData);
        });

        // Batch test receipt handler (generates first row only)
        document.getElementById('batchTestBtn').addEventListener('click', async function(e) {
            e.preventDefault();

            if (batchData.length === 0) {
                alert('Please upload an Excel file first.');
                return;
            }

            const signerName = document.getElementById('batchSignerName').value;
            const signerTitle = document.getElementById('batchSignerTitle').value;
            const ein = document.getElementById('batchOrganizationEIN').value;
            const address = document.getElementById('batchOrganizationAddress').value;
            const donationDescription = document.getElementById('batchDonationDescription').value;
            const letterDate = document.getElementById('batchLetterDate').value;
            const donationType = document.querySelector('input[name="batchDonationType"]:checked').value;

            // Validate required fields
            if (!signerName || !signerTitle || !ein || !address || !letterDate) {
                alert('Please fill in all required fields before generating a test receipt.');
                return;
            }

            // Use first row for test
            const testRow = batchData[0];
            
            // Get signature image (check if selector has a value and load if needed)
            let signatureToUse = batchSignatureImageData;
            const signatureSelector = document.getElementById('batchSignatureSelector');
            if (signatureSelector.value && signatureSelector.value !== '' && signatureSelector.value !== 'custom' && !signatureToUse) {
                // Signature was selected but not loaded yet - try to load it
                const sigValue = signatureSelector.value;
                if (availableSignatures[sigValue]) {
                    // Wait a moment for image to load
                    await new Promise((resolve) => {
                        loadSignatureFromFile(sigValue, 'batchSignaturePreviewImg', 'batchSignaturePreview', 'batch');
                        setTimeout(resolve, 500); // Give time for image to load
                    });
                    signatureToUse = batchSignatureImageData;
                }
            }
            
            const receiptData = {
                donorName: testRow.person,
                donationDate: testRow.date,
                letterDate: letterDate,
                donationDescription: donationDescription,
                donationValue: testRow.amount,
                ein: ein,
                address: address,
                signerName: signerName,
                signerTitle: signerTitle,
                donationType: donationType,
                signatureImage: signatureToUse
            };

            // Generate test PDF
            await generateReceiptPDF(receiptData);
            const sigNote = signatureToUse ? ' (with signature)' : ' (no signature selected)';
            alert(`Test receipt generated for: ${testRow.person} ($${testRow.amount.toFixed(2)})${sigNote}. Review it before generating all ${batchData.length} receipts.`);
        });

        async function sendReceiptEmail({ to, subject, html, pdfBase64, filename, test }) {
            const url = (document.getElementById('receiptFunctionUrl')?.value || '').trim();
            if (!url) throw new Error('Missing Receipt Email Function URL');
            const token = (document.getElementById('receiptFunctionToken')?.value || '').trim();

            const resp = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    ...(token ? { 'x-receipt-token': token } : {})
                },
                body: JSON.stringify({ to, subject, html, pdfBase64, filename, test: !!test })
            });

            const data = await resp.json().catch(() => ({}));
            if (!resp.ok || !data.ok) {
                throw new Error(data.error || `Email send failed (${resp.status})`);
            }
        }

        function buildReceiptEmailHtml({ donorName, donationDateFormatted, donationValueFormatted, donationType, donationDescription }) {
            const safe = (s) => String(s || '').replace(/[&<>"]/g, (c) => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;' }[c]));
            const desc = (donationDescription && donationDescription.trim()) ? donationDescription.trim() : '';
            let summary;
            if (donationType === 'cash') {
                summary = desc
                    ? `Monetary contribution of <strong>$${safe(donationValueFormatted)}</strong> on <strong>${safe(donationDateFormatted)}</strong> (designated for ${safe(desc)}).`
                    : `Monetary contribution of <strong>$${safe(donationValueFormatted)}</strong> on <strong>${safe(donationDateFormatted)}</strong>.`;
            } else {
                summary = desc
                    ? `In-kind donation on <strong>${safe(donationDateFormatted)}</strong> valued at <strong>$${safe(donationValueFormatted)}</strong> (${safe(desc)}).`
                    : `In-kind contribution on <strong>${safe(donationDateFormatted)}</strong> valued at <strong>$${safe(donationValueFormatted)}</strong>.`;
            }
            return `
                <div style="font-family: Arial, sans-serif; color: #111827; line-height: 1.5;">
                    <p>Dear ${safe(donorName)},</p>
                    <p>Please find your donation acknowledgment letter attached.</p>
                    <p style="margin: 12px 0; padding: 10px 12px; background: #f3f4f6; border-radius: 8px;">
                        ${summary}
                    </p>
                    <p>Thank you for your support in fighting food insecurity in our community.</p>
                    <p style="color:#6b7280; font-size: 12px;">No goods or services were provided in exchange for this contribution.</p>
                </div>
            `;
        }

        // Batch test email handler (first row only)
        document.getElementById('batchTestSendBtn').addEventListener('click', async function(e) {
            e.preventDefault();

            if (batchData.length === 0) {
                alert('Please upload an Excel file first.');
                return;
            }

            const signerName = document.getElementById('batchSignerName').value;
            const signerTitle = document.getElementById('batchSignerTitle').value;
            const ein = document.getElementById('batchOrganizationEIN').value;
            const address = document.getElementById('batchOrganizationAddress').value;
            const donationDescription = document.getElementById('batchDonationDescription').value;
            const letterDate = document.getElementById('batchLetterDate').value;
            const donationType = document.querySelector('input[name="batchDonationType"]:checked').value;

            if (!signerName || !signerTitle || !ein || !address || !letterDate) {
                alert('Please fill in all required fields before sending a test email.');
                return;
            }

            const testRow = batchData[0];
            const to = (document.getElementById('testEmailOverride').value || testRow.email || '').trim();
            if (!to) {
                alert('No email available. Provide Test Email Override or ensure the spreadsheet has an email column.');
                return;
            }

            const receiptData = {
                donorName: testRow.person,
                donationDate: testRow.date,
                letterDate: letterDate,
                donationDescription: donationDescription,
                donationValue: testRow.amount,
                ein: ein,
                address: address,
                signerName: signerName,
                signerTitle: signerTitle,
                donationType: donationType,
                signatureImage: batchSignatureImageData
            };

            const btn = document.getElementById('batchTestSendBtn');
            const original = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'Sending test email...';

            try {
                const donationDateFormatted = (testRow.date instanceof Date ? testRow.date : new Date(testRow.date))
                    .toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                const donationValueFormatted = parseFloat(testRow.amount).toFixed(2);
                const subject = `Donation Receipt - ${testRow.person} - ${donationDateFormatted} - $${donationValueFormatted}`;
                const html = buildReceiptEmailHtml({ donorName: testRow.person, donationDateFormatted, donationValueFormatted, donationType, donationDescription });

                const { pdfBase64, filename } = await generateReceiptPDF(receiptData, { mode: 'email' });
                await sendReceiptEmail({ to, subject, html, pdfBase64, filename, test: true });
                alert(`Test email sent to ${to}. Please confirm it looks right before sending all ${batchData.length}.`);
            } catch (err) {
                alert('Test email failed: ' + err.message);
            } finally {
                btn.disabled = false;
                btn.textContent = original;
            }
        });

        // Send all emails (no downloads)
        document.getElementById('batchSendAllBtn').addEventListener('click', async function(e) {
            e.preventDefault();

            if (batchData.length === 0) {
                alert('Please upload an Excel file first.');
                return;
            }

            const signerName = document.getElementById('batchSignerName').value;
            const signerTitle = document.getElementById('batchSignerTitle').value;
            const ein = document.getElementById('batchOrganizationEIN').value;
            const address = document.getElementById('batchOrganizationAddress').value;
            const donationDescription = document.getElementById('batchDonationDescription').value;
            const letterDate = document.getElementById('batchLetterDate').value;
            const donationType = document.querySelector('input[name="batchDonationType"]:checked').value;

            if (!signerName || !signerTitle || !ein || !address || !letterDate) {
                alert('Please fill in all required fields before sending.');
                return;
            }

            const confirmSend = confirm(`This will email ${batchData.length} receipt(s). Continue?`);
            if (!confirmSend) return;

            const btn = document.getElementById('batchSendAllBtn');
            const original = btn.textContent;
            btn.disabled = true;

            let sent = 0;
            let skipped = 0;
            const failures = [];

            for (let i = 0; i < batchData.length; i++) {
                const row = batchData[i];
                const to = (row.email || '').trim();
                if (!to) {
                    skipped++;
                    continue;
                }

                btn.textContent = `Sending emails... (${i + 1}/${batchData.length})`;

                const receiptData = {
                    donorName: row.person,
                    donationDate: row.date,
                    letterDate: letterDate,
                    donationDescription: donationDescription,
                    donationValue: row.amount,
                    ein: ein,
                    address: address,
                    signerName: signerName,
                    signerTitle: signerTitle,
                    donationType: donationType,
                    signatureImage: batchSignatureImageData
                };

                try {
                    const donationDateFormatted = (row.date instanceof Date ? row.date : new Date(row.date))
                        .toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                    const donationValueFormatted = parseFloat(row.amount).toFixed(2);
                    const subject = `Donation Receipt - ${row.person} - ${donationDateFormatted} - $${donationValueFormatted}`;
                    const html = buildReceiptEmailHtml({ donorName: row.person, donationDateFormatted, donationValueFormatted, donationType, donationDescription });

                    const { pdfBase64, filename } = await generateReceiptPDF(receiptData, { mode: 'email' });
                    await sendReceiptEmail({ to, subject, html, pdfBase64, filename, test: false });
                    sent++;
                } catch (err) {
                    failures.push({ row: i + 1, person: row.person, email: to, error: err.message });
                }

                // small delay to avoid hammering
                await new Promise(r => setTimeout(r, 250));
            }

            btn.disabled = false;
            btn.textContent = original;

            if (failures.length) {
                console.error('Email send failures:', failures);
                alert(`Done. Sent: ${sent}. Skipped (missing email): ${skipped}. Failed: ${failures.length}. Check console for details.`);
            } else {
                alert(`Done. Sent: ${sent}. Skipped (missing email): ${skipped}.`);
            }
        });

        // Batch form handler
        document.getElementById('batchForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            if (batchData.length === 0) {
                alert('Please upload an Excel file first.');
                return;
            }

            const signerName = document.getElementById('batchSignerName').value;
            const signerTitle = document.getElementById('batchSignerTitle').value;
            const ein = document.getElementById('batchOrganizationEIN').value;
            const address = document.getElementById('batchOrganizationAddress').value;
            const donationDescription = document.getElementById('batchDonationDescription').value;
            const letterDate = document.getElementById('batchLetterDate').value;
            const donationType = document.querySelector('input[name="batchDonationType"]:checked').value;

            // Disable button and show progress
            const btn = document.getElementById('batchGenerateBtn');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = `Generating ${batchData.length} PDFs...`;

            let generated = 0;
            const total = batchData.length;

            // Generate PDFs one by one (with small delay to avoid browser blocking)
            for (let i = 0; i < batchData.length; i++) {
                const row = batchData[i];
                
                const receiptData = {
                    donorName: row.person,
                    donationDate: row.date,
                    letterDate: letterDate,
                    donationDescription: donationDescription,
                    donationValue: row.amount,
                    ein: ein,
                    address: address,
                    signerName: signerName,
                    signerTitle: signerTitle,
                    donationType: donationType,
                    signatureImage: batchSignatureImageData
                };

                // Wait for PDF to be generated and saved
                await generateReceiptPDF(receiptData);
                
                // Small delay between PDFs to avoid browser blocking downloads
                if (i < batchData.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 300));
                }
                
                generated++;
            }

            // Re-enable button
            btn.disabled = false;
            btn.textContent = originalText;
            alert(`Successfully generated ${generated} PDF receipt(s)!`);
        });
    </script>
</body>
</html>
