<!doctype html>
<html lang="en">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Event Planning Dashboard</title>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics-compat.js"></script>
  <!-- Google Maps API -->
  <script>
    // Global callback for Google Maps
    window.initMap = function() {
      // Map will be initialized when renderMapView is called
      console.log('Google Maps API loaded');
    };
  </script>
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAB6O8WSqMSNJJv4wDG_8HTNpnegR1hBYo&callback=initMap&loading=async" onerror="console.warn('Google Maps API failed to load')"></script>
  <style>
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #f5f7fa;
      color: #2d3748;
      min-height: 100%;
    }

    *, *::before, *::after {
      box-sizing: border-box;
    }

    .dashboard-container {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Header */
    .dashboard-header {
      background: #236383;
      color: white;
      padding: 20px 32px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      flex-shrink: 0;
    }

    .dashboard-header h1 {
      margin: 0;
      font-size: 28px;
      font-weight: 600;
    }

    /* Tabs */
    .tabs-container {
      background: white;
      border-bottom: 2px solid #e2e8f0;
      padding: 0 32px;
      display: flex;
      gap: 8px;
      flex-shrink: 0;
    }

    .tab-button {
      background: none;
      border: none;
      padding: 16px 24px;
      font-size: 15px;
      font-weight: 500;
      color: #64748b;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
      position: relative;
    }

    .tab-button:hover {
      color: #236383;
      background: #f8fafc;
    }

    .tab-button.active {
      color: #236383;
      border-bottom-color: #fbad3f;
    }

    .tab-badge {
      display: inline-block;
      background: #a31c41;
      color: white;
      font-size: 11px;
      font-weight: 600;
      padding: 2px 8px;
      border-radius: 12px;
      margin-left: 8px;
      min-width: 20px;
      text-align: center;
    }

    .staffing-subtab-button {
      background: none;
      border: none;
      padding: 12px 24px;
      font-size: 15px;
      font-weight: 500;
      color: #64748b;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
    }

    .staffing-subtab-button:hover {
      color: #236383;
      background: #f8fafc;
    }

    .staffing-subtab-button.active {
      color: #236383;
      border-bottom-color: #fbad3f;
    }

    .staffing-subtab-content {
      display: block;
    }

    /* Main content area */
    .main-content {
      flex: 1;
      overflow-y: auto;
      padding: 32px;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Action button */
    .action-button {
      background: #fbad3f;
      color: #1a202c;
      border: none;
      padding: 12px 24px;
      font-size: 15px;
      font-weight: 600;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 2px 4px rgba(251, 173, 63, 0.3);
    }

    .action-button:hover {
      background: #f59e0b;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(251, 173, 63, 0.4);
    }

    .action-button:disabled {
      background: #cbd5e0;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    /* Cards */
    .attention-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 24px;
      margin-bottom: 32px;
    }

    .attention-card {
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      border-left: 4px solid #236383;
    }

    .attention-card.warning {
      border-left-color: #fbad3f;
    }

    .attention-card.urgent {
      border-left-color: #a31c41;
    }

    .attention-card h3 {
      margin: 0 0 16px 0;
      font-size: 18px;
      font-weight: 600;
      color: #1a202c;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .card-count {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: #236383;
      color: white;
      font-size: 13px;
      font-weight: 600;
      padding: 4px 10px;
      border-radius: 12px;
      min-width: 28px;
    }

    .attention-card.warning .card-count {
      background: #fbad3f;
      color: #1a202c;
    }

    .attention-card.urgent .card-count {
      background: #a31c41;
    }

    .event-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
      max-height: 400px;
      overflow-y: auto;
    }

    .event-item {
      background: #f8fafc;
      padding: 16px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid #e2e8f0;
    }

    .event-item:hover {
      background: #f1f5f9;
      border-color: #236383;
      transform: translateX(4px);
    }

    .event-item-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
    }

    .event-item-title {
      font-weight: 600;
      color: #1a202c;
      font-size: 15px;
    }

    .event-item-subtitle {
      font-size: 13px;
      color: #64748b;
      font-weight: 500;
      margin-top: 2px;
    }

    .event-item-meta {
      font-size: 13px;
      color: #64748b;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 4px;
    }

    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .status-new {
      background: #dbeafe;
      color: #1e40af;
    }

    .status-in-process {
      background: #fef3c7;
      color: #92400e;
    }

    .status-scheduled {
      background: #d1fae5;
      color: #065f46;
    }

    .status-completed {
      background: #e0e7ff;
      color: #3730a3;
    }

    .status-canceled {
      background: #fee2e2;
      color: #991b1b;
    }

    .missing-icons {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }

    .missing-icon {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      color: #a31c41;
      background: #fee;
      padding: 4px 8px;
      border-radius: 6px;
    }

    .empty-state {
      text-align: center;
      padding: 48px 24px;
      color: #64748b;
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    /* Modal/Detail Panel */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 16px;
      width: 100%;
      max-width: 800px;
      max-height: 90%;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }

    .modal-header {
      background: #236383;
      color: white;
      padding: 24px 32px;
      border-radius: 16px 16px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h2 {
      margin: 0;
      font-size: 24px;
      font-weight: 600;
    }

    .modal-close {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      font-size: 24px;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .modal-close:hover {
      background: rgba(255,255,255,0.3);
    }

    .modal-body {
      padding: 32px;
    }

    .form-section {
      margin-bottom: 32px;
    }

    .form-section h3 {
      margin: 0 0 16px 0;
      font-size: 18px;
      font-weight: 600;
      color: #236383;
      border-bottom: 2px solid #e2e8f0;
      padding-bottom: 8px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px;
    }

    .form-field {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .form-field label {
      font-size: 13px;
      font-weight: 600;
      color: #475569;
    }

    .form-field input,
    .form-field select,
    .form-field textarea {
      padding: 10px 12px;
      border: 1px solid #cbd5e0;
      border-radius: 6px;
      font-size: 14px;
      font-family: inherit;
      transition: all 0.2s;
    }

    .form-field input:focus,
    .form-field select:focus,
    .form-field textarea:focus {
      outline: none;
      border-color: #236383;
      box-shadow: 0 0 0 3px rgba(35, 99, 131, 0.1);
    }

    .form-field textarea {
      resize: vertical;
      min-height: 80px;
    }

    .checkbox-field {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
    }

    .checkbox-field input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .checkbox-field label {
      font-size: 14px;
      cursor: pointer;
    }

    .button-group {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }

    .button-secondary {
      background: #e2e8f0;
      color: #1a202c;
      border: none;
      padding: 12px 24px;
      font-size: 15px;
      font-weight: 600;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .button-secondary:hover {
      background: #cbd5e0;
    }

    .button-danger {
      background: #a31c41;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 15px;
      font-weight: 600;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .button-danger:hover {
      background: #881736;
    }

    /* Pipeline view */
    .pipeline-controls {
      background: white;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .filter-row {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      align-items: center;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .filter-group label {
      font-size: 13px;
      font-weight: 600;
      color: #475569;
    }

    .pipeline-table {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .table-wrapper {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead {
      background: #f8fafc;
      border-bottom: 2px solid #e2e8f0;
    }

    th {
      text-align: left;
      padding: 16px;
      font-size: 13px;
      font-weight: 600;
      color: #475569;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    td {
      padding: 16px;
      border-bottom: 1px solid #f1f5f9;
      font-size: 14px;
    }

    tbody tr {
      cursor: pointer;
      transition: background 0.2s;
    }

    tbody tr:hover {
      background: #f8fafc;
    }

    .completeness-indicators {
      display: flex;
      gap: 6px;
    }

    .indicator-icon {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 600;
    }

    .indicator-icon.complete {
      background: #d1fae5;
      color: #065f46;
    }

    .indicator-icon.incomplete {
      background: #fee2e2;
      color: #991b1b;
    }

    /* Reports */
    .reports-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 24px;
    }

    .report-card {
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .report-card h3 {
      margin: 0 0 20px 0;
      font-size: 18px;
      font-weight: 600;
      color: #1a202c;
    }

    .stat-large {
      font-size: 48px;
      font-weight: 700;
      color: #236383;
      margin: 16px 0;
    }

    .stat-label {
      font-size: 14px;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
    }

    .chart-bar {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .chart-label {
      min-width: 120px;
      font-size: 14px;
      color: #475569;
      font-weight: 500;
    }

    .chart-bar-fill {
      flex: 1;
      height: 32px;
      background: #236383;
      border-radius: 6px;
      display: flex;
      align-items: center;
      padding: 0 12px;
      color: white;
      font-weight: 600;
      font-size: 13px;
      transition: all 0.3s;
    }

    .loading-spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: #1a202c;
      color: white;
      padding: 16px 24px;
      border-radius: 8px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.3);
      z-index: 2000;
      display: none;
      align-items: center;
      gap: 12px;
      max-width: 400px;
    }

    .toast.show {
      display: flex;
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .toast.success {
      background: #047857;
    }

    .toast.error {
      background: #a31c41;
    }

    /* Next 7 Days Calendar */
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 16px;
    }

    .calendar-day {
      background: #f8fafc;
      border-radius: 8px;
      padding: 16px;
      border: 2px solid #e2e8f0;
      transition: all 0.2s;
    }

    .calendar-day.has-events {
      border-color: #236383;
      background: #f0f9ff;
    }

    .calendar-day.today {
      border-color: #fbad3f;
      background: #fffbeb;
    }

    .calendar-day-header {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid #e2e8f0;
    }

    .calendar-day-name {
      font-size: 13px;
      font-weight: 600;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .calendar-day-date {
      font-size: 20px;
      font-weight: 700;
      color: #1a202c;
    }

    .calendar-day-events {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 300px;
      overflow-y: auto;
    }

    .calendar-event-item {
      background: white;
      padding: 8px;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
      border-left: 3px solid #236383;
    }

    .calendar-event-item:hover {
      transform: translateX(2px);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .calendar-event-item.status-new {
      border-left-color: #3b82f6;
    }

    .calendar-event-item.status-in-process {
      border-left-color: #f59e0b;
    }

    .calendar-event-item.status-scheduled {
      border-left-color: #10b981;
    }

    .calendar-event-name {
      font-weight: 600;
      color: #1a202c;
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .calendar-event-time {
      font-size: 11px;
      color: #64748b;
    }

    .calendar-event-count {
      font-size: 11px;
      color: #64748b;
      margin-top: 2px;
    }

    .calendar-no-events {
      text-align: center;
      color: #94a3b8;
      font-size: 13px;
      padding: 12px 0;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body>
  <div class="dashboard-container"><!-- Header -->
   <header class="dashboard-header">
    <h1 id="dashboard-title">Event Planning Dashboard</h1>
   </header><!-- Tabs -->
   <nav class="tabs-container"><button class="tab-button active" data-tab="attention"> <span id="attention-tab-label">Attention Needed</span> <span class="tab-badge" id="attention-badge">0</span> </button> <button class="tab-button" data-tab="pipeline"> <span id="pipeline-tab-label">Pipeline &amp; Calendar</span> </button> <button class="tab-button" data-tab="staffing"> <span id="staffing-tab-label">Staffing</span> <span class="tab-badge" id="staffing-badge">0</span> </button> <button class="tab-button" data-tab="map"> <span id="map-tab-label">üìç Map</span> </button> <button class="tab-button" data-tab="calendar"> <span id="calendar-tab-label">üìÖ Calendar</span> </button> <button class="tab-button" data-tab="completed"> <span id="completed-tab-label">Completed Events</span> <span class="tab-badge" id="completed-badge">0</span> </button> <button class="tab-button" data-tab="reports"> <span id="reports-tab-label">Reports &amp; Trends</span> </button>
   </nav><!-- Main Content -->
   <main class="main-content"><!-- Attention Needed Tab -->
    <div class="tab-content active" id="attention-tab">
     <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
      <h2 style="margin: 0; font-size: 24px; color: #1a202c;">Daily Check</h2>
      <div style="display: flex; gap: 12px;"><button class="button-secondary" onclick="document.getElementById('excel-import').click()">üìä Import Excel</button> <button class="button-secondary" onclick="openRoleManagementModal()">üë• Manage Roles</button> <button class="action-button" onclick="openNewEventModal()">+ New Event</button>
      </div>
     </div><input type="file" id="excel-import" accept=".xlsx,.xls" style="display: none;" onchange="handleExcelImport(event)"> <!-- Next 7 Days Quick View -->
     <div style="background: white; border-radius: 12px; padding: 24px; margin-bottom: 32px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
       <h3 style="margin: 0; font-size: 20px; font-weight: 600; color: #1a202c; display: flex; align-items: center; gap: 12px;"><span>üìÖ Next 7 Days</span> <span class="card-count" style="background: #236383;" id="next-7-days-count">0</span></h3>
       <div style="display: flex; align-items: center; gap: 8px;">
        <button onclick="changeWeek(-1)" style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; padding: 8px 12px; cursor: pointer; font-size: 16px; color: #236383; transition: all 0.2s;" onmouseover="this.style.background='#e2e8f0'" onmouseout="this.style.background='#f8fafc'">‚Üê</button>
        <button onclick="changeWeek(0)" style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; padding: 8px 16px; cursor: pointer; font-size: 14px; color: #236383; font-weight: 500; transition: all 0.2s;" onmouseover="this.style.background='#e2e8f0'" onmouseout="this.style.background='#f8fafc'">Today</button>
        <button onclick="changeWeek(1)" style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; padding: 8px 12px; cursor: pointer; font-size: 16px; color: #236383; transition: all 0.2s;" onmouseover="this.style.background='#e2e8f0'" onmouseout="this.style.background='#f8fafc'">‚Üí</button>
       </div>
      </div>
      <div id="next-7-days-calendar"></div>
     </div>
     <div class="attention-grid"><!-- New Requests -->
      <div class="attention-card">
       <h3><span>üÜï New Requests</span> <span class="card-count" id="new-requests-count">0</span></h3>
       <div class="event-list" id="new-requests-list"></div>
      </div><!-- Stalled Events -->
      <div class="attention-card warning">
       <h3><span>‚è∏Ô∏è Stalled (7+ days)</span> <span class="card-count" id="stalled-count">0</span></h3>
       <div class="event-list" id="stalled-list"></div>
      </div><!-- Upcoming Missing Info -->
      <div class="attention-card urgent">
       <h3><span>‚ö†Ô∏è Upcoming Missing Info</span> <span class="card-count" id="upcoming-missing-count">0</span></h3>
       <div class="event-list" id="upcoming-missing-list"></div>
      </div>
     </div>
    </div><!-- Pipeline Tab -->
    <div class="tab-content" id="pipeline-tab">
     <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
      <h2 style="margin: 0; font-size: 24px; color: #1a202c;">Event Pipeline</h2><button class="action-button" onclick="openNewEventModal()">+ New Event</button>
     </div>
     <div class="pipeline-controls">
      <div class="filter-row">
       <div class="filter-group"><label for="filter-status">Status</label> <select id="filter-status" onchange="applyPipelineFilters()"> <option value="">All Statuses</option> <option value="New">New</option> <option value="In Process">In Process</option> <option value="Scheduled">Scheduled</option> <option value="Completed">Completed</option> <option value="Canceled">Canceled</option> </select>
       </div>
       <div class="filter-group"><label for="filter-tsp">TSP Contact</label> <select id="filter-tsp" onchange="applyPipelineFilters()"> <option value="">All Contacts</option> </select>
       </div>
       <div class="filter-group"><label for="filter-date-start">From Date</label> <input type="date" id="filter-date-start" onchange="applyPipelineFilters()">
       </div>
       <div class="filter-group"><label for="filter-date-end">To Date</label> <input type="date" id="filter-date-end" onchange="applyPipelineFilters()">
       </div>
      </div>
     </div>
     <div id="pipeline-bulk-actions" style="display: none; margin-bottom: 16px; padding: 12px; background: #f8fafc; border-radius: 8px; display: flex; align-items: center; gap: 12px;">
      <span id="pipeline-selected-count" style="font-weight: 600; color: #1a202c;">0 events selected</span>
      <select id="bulk-status-change" style="padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 14px;">
       <option value="">Change status to...</option>
       <option value="New">New</option>
       <option value="In Process">In Process</option>
       <option value="Scheduled">Scheduled</option>
       <option value="Completed">Completed</option>
       <option value="Canceled">Canceled</option>
      </select>
      <button class="action-button" onclick="applyBulkStatusChange()" style="padding: 8px 16px; font-size: 14px;">Apply</button>
      <button class="button-secondary" onclick="clearPipelineSelection()" style="padding: 8px 16px; font-size: 14px;">Clear Selection</button>
     </div>
     <div class="pipeline-table">
      <div class="table-wrapper">
       <table>
        <thead>
         <tr>
          <th style="width: 40px;"><input type="checkbox" id="select-all-pipeline" onchange="toggleSelectAllPipeline()" title="Select All"></th>
          <th>Date</th>
          <th>Group / Department</th>
          <th>Status</th>
          <th>TSP Contact</th>
          <th>Sandwiches</th>
          <th>Completeness</th>
         </tr>
        </thead>
        <tbody id="pipeline-table-body"></tbody>
       </table>
      </div>
     </div>
    </div><!-- Staffing Tab -->
    <div class="tab-content" id="staffing-tab">
     <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
      <h2 style="margin: 0; font-size: 24px; color: #1a202c;">Staffing Needs</h2>
     </div>
     <div style="display: flex; gap: 8px; margin-bottom: 24px; border-bottom: 2px solid #e2e8f0; padding-bottom: 0;">
      <button class="staffing-subtab-button" id="staffing-subtab-drivers" onclick="switchStaffingSubTab('drivers')" style="background: none; border: none; padding: 12px 24px; font-size: 15px; font-weight: 500; color: #64748b; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.2s;">üöó Drivers <span class="tab-badge" id="drivers-badge">0</span></button>
      <button class="staffing-subtab-button" id="staffing-subtab-speakers" onclick="switchStaffingSubTab('speakers')" style="background: none; border: none; padding: 12px 24px; font-size: 15px; font-weight: 500; color: #64748b; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.2s;">üé§ Speakers <span class="tab-badge" id="speakers-badge">0</span></button>
      <button class="staffing-subtab-button" id="staffing-subtab-volunteers" onclick="switchStaffingSubTab('volunteers')" style="background: none; border: none; padding: 12px 24px; font-size: 15px; font-weight: 500; color: #64748b; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.2s;">üë§ Volunteers <span class="tab-badge" id="volunteers-badge">0</span></button>
     </div>
     <div id="staffing-content-drivers" class="staffing-subtab-content">
      <div class="pipeline-table">
       <div class="table-wrapper">
        <table>
         <thead>
          <tr>
           <th style="cursor: pointer;" onclick="sortStaffingNeeds('date')">Date ‚Üï</th>
           <th>Time</th>
           <th>Group / Department</th>
           <th style="cursor: pointer;" onclick="sortStaffingNeeds('area')">Area/Zip ‚Üï</th>
           <th>Address</th>
           <th>Sandwiches</th>
           <th>Destination</th>
           <th>Action</th>
          </tr>
         </thead>
         <tbody id="drivers-table-body"></tbody>
        </table>
       </div>
      </div>
     </div>
     <div id="staffing-content-speakers" class="staffing-subtab-content" style="display: none;">
      <div class="pipeline-table">
       <div class="table-wrapper">
        <table>
         <thead>
          <tr>
           <th style="cursor: pointer;" onclick="sortStaffingNeeds('date')">Date ‚Üï</th>
           <th>Time</th>
           <th>Group / Department</th>
           <th style="cursor: pointer;" onclick="sortStaffingNeeds('area')">Area/Zip ‚Üï</th>
           <th>Address</th>
           <th>Sandwiches</th>
           <th>Destination</th>
           <th>Action</th>
          </tr>
         </thead>
         <tbody id="speakers-table-body"></tbody>
        </table>
       </div>
      </div>
     </div>
     <div id="staffing-content-volunteers" class="staffing-subtab-content" style="display: none;">
      <div class="pipeline-table">
       <div class="table-wrapper">
        <table>
         <thead>
          <tr>
           <th style="cursor: pointer;" onclick="sortStaffingNeeds('date')">Date ‚Üï</th>
           <th>Time</th>
           <th>Group / Department</th>
           <th style="cursor: pointer;" onclick="sortStaffingNeeds('area')">Area/Zip ‚Üï</th>
           <th>Address</th>
           <th>Sandwiches</th>
           <th>Destination</th>
           <th>Action</th>
          </tr>
         </thead>
         <tbody id="volunteers-table-body"></tbody>
        </table>
       </div>
      </div>
     </div>
    </div><!-- Completed Events Tab -->
    <div class="tab-content" id="completed-tab">
     <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
      <h2 style="margin: 0; font-size: 24px; color: #1a202c;">Completed Events History</h2>
     </div>
     <div class="pipeline-controls">
      <div class="filter-row">
       <div class="filter-group"><label for="completed-filter-tsp">TSP Contact</label> <select id="completed-filter-tsp" onchange="applyCompletedFilters()"> <option value="">All Contacts</option> </select>
       </div>
       <div class="filter-group"><label for="completed-filter-date-start">From Date</label> <input type="date" id="completed-filter-date-start" onchange="applyCompletedFilters()">
       </div>
       <div class="filter-group"><label for="completed-filter-date-end">To Date</label> <input type="date" id="completed-filter-date-end" onchange="applyCompletedFilters()">
       </div>
       <div class="filter-group"><label for="completed-filter-group">Group Name</label> <input type="text" id="completed-filter-group" placeholder="Search groups..." oninput="applyCompletedFilters()">
       </div>
      </div>
     </div>
     <div class="pipeline-table">
      <div class="table-wrapper">
       <table>
        <thead>
         <tr>
          <th>Date</th>
          <th>Group / Department</th>
          <th>TSP Contact</th>
          <th>Sandwiches (Planned)</th>
          <th>Sandwiches (Actual)</th>
          <th>Destination</th>
          <th>Follow-up</th>
         </tr>
        </thead>
        <tbody id="completed-table-body"></tbody>
       </table>
      </div>
     </div>
    </div><!-- Map Tab -->
    <div class="tab-content" id="map-tab">
     <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
      <h2 style="margin: 0; font-size: 24px; color: #1a202c;">üìç Event Map</h2>
      <div style="display: flex; gap: 12px; align-items: center;">
       <label style="display: flex; align-items: center; gap: 8px; font-size: 14px; color: #64748b;">
        <input type="checkbox" id="map-filter-scheduled" checked onchange="renderMapView()" style="cursor: pointer;">
        Scheduled Events
       </label>
       <label style="display: flex; align-items: center; gap: 8px; font-size: 14px; color: #64748b;">
        <input type="checkbox" id="map-filter-upcoming" checked onchange="renderMapView()" style="cursor: pointer;">
        Upcoming (Next 30 Days)
       </label>
      </div>
     </div>
     <div id="map-container" style="width: 100%; height: 600px; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.08); background: #f5f7fa; display: flex; align-items: center; justify-content: center;">
      <div style="text-align: center; color: #64748b;">
       <div style="font-size: 48px; margin-bottom: 16px;">üó∫Ô∏è</div>
       <div>Loading map...</div>
      </div>
     </div>
     <div id="map-legend" style="margin-top: 16px; padding: 16px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
      <div style="font-weight: 600; margin-bottom: 12px; color: #1a202c;">Legend:</div>
      <div style="display: flex; flex-wrap: wrap; gap: 16px; font-size: 14px;">
       <div style="display: flex; align-items: center; gap: 8px;"><span style="color: #236383; font-weight: 600;">‚óè</span> Scheduled</div>
       <div style="display: flex; align-items: center; gap: 8px;"><span style="color: #fbad3f; font-weight: 600;">‚óè</span> In Process</div>
       <div style="display: flex; align-items: center; gap: 8px;"><span style="color: #059669; font-weight: 600;">‚óè</span> Completed</div>
       <div style="display: flex; align-items: center; gap: 8px;"><span style="color: #a31c41; font-weight: 600;">‚óè</span> Needs Staffing</div>
      </div>
     </div>
    </div><!-- Calendar Tab -->
    <div class="tab-content" id="calendar-tab">
     <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
      <h2 style="margin: 0; font-size: 24px; color: #1a202c;">üìÖ Event Calendar</h2>
      <div style="display: flex; gap: 12px; align-items: center;">
       <button onclick="changeCalendarMonth(-1)" style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; padding: 8px 12px; cursor: pointer; font-size: 16px; color: #236383;">‚Üê</button>
       <button onclick="changeCalendarMonth(0)" style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; padding: 8px 16px; cursor: pointer; font-size: 14px; color: #236383; font-weight: 500;">Today</button>
       <button onclick="changeCalendarMonth(1)" style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; padding: 8px 12px; cursor: pointer; font-size: 16px; color: #236383;">‚Üí</button>
      </div>
     </div>
     <div id="calendar-view-container" style="background: white; border-radius: 12px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
      <div id="calendar-month-header" style="text-align: center; font-size: 20px; font-weight: 600; color: #1a202c; margin-bottom: 24px;"></div>
      <div id="calendar-grid-container"></div>
     </div>
    </div><!-- Reports Tab -->
    <div class="tab-content" id="reports-tab">
     <h2 style="margin: 0 0 24px 0; font-size: 24px; color: #1a202c;">Reports &amp; Trends</h2>
     <div class="reports-grid"><!-- Total Events -->
      <div class="report-card">
       <h3>Total Events</h3>
       <div class="stat-large" id="total-events-stat">
        0
       </div>
       <div class="stat-label">
        All Time
       </div>
      </div><!-- Conversion Funnel -->
      <div class="report-card">
       <h3>Conversion Funnel</h3>
       <div class="chart-bar">
        <div class="chart-label">
         Requests
        </div>
        <div class="chart-bar-fill" id="funnel-requests" style="background: #236383;">
         0
        </div>
       </div>
       <div class="chart-bar">
        <div class="chart-label">
         Scheduled
        </div>
        <div class="chart-bar-fill" id="funnel-scheduled" style="background: #007e8c;">
         0
        </div>
       </div>
       <div class="chart-bar">
        <div class="chart-label">
         Completed
        </div>
        <div class="chart-bar-fill" id="funnel-completed" style="background: #47b3cb;">
         0
        </div>
       </div>
      </div><!-- Events by TSP Contact -->
      <div class="report-card">
       <h3>Events by TSP Contact</h3>
       <div id="tsp-chart"></div>
      </div><!-- Top Destinations -->
      <div class="report-card">
       <h3>Top Destinations</h3>
       <div id="destinations-chart"></div>
      </div><!-- Sandwich Totals -->
      <div class="report-card">
       <h3>Total Sandwiches</h3>
       <div class="chart-bar">
        <div class="chart-label">
         Planned
        </div>
        <div class="chart-bar-fill" id="sandwiches-planned" style="background: #fbad3f; color: #1a202c;">
         0
        </div>
       </div>
       <div class="chart-bar">
        <div class="chart-label">
         Actual
        </div>
        <div class="chart-bar-fill" id="sandwiches-actual" style="background: #a31c41;">
         0
        </div>
       </div>
      </div><!-- Repeat Groups -->
      <div class="report-card">
       <h3>Group Engagement</h3>
       <div class="chart-bar">
        <div class="chart-label">
         New Groups
        </div>
        <div class="chart-bar-fill" id="groups-new" style="background: #236383;">
         0
        </div>
       </div>
       <div class="chart-bar">
        <div class="chart-label">
         Repeat Groups
        </div>
        <div class="chart-bar-fill" id="groups-repeat" style="background: #007e8c;">
         0
        </div>
       </div>
      </div>
     </div>
    </div>
   </main>
  </div><!-- Event Detail Modal -->
  <div class="modal-overlay" id="event-modal">
   <div class="modal-content">
    <div class="modal-header">
     <h2 id="modal-title">Event Details</h2><button class="modal-close" onclick="closeEventModal()">√ó</button>
    </div>
    <div class="modal-body">
     <form id="event-form" onsubmit="saveEvent(event)"><!-- Core Info -->
      <div class="form-section">
       <h3>Event Information</h3>
       <div class="form-grid">
        <div class="form-field"><label for="event-status">Status *</label> <select id="event-status" required onchange="updateAllAssignmentStates()"> <option value="New">New</option> <option value="In Process">In Process</option> <option value="Scheduled">Scheduled</option> <option value="Completed">Completed</option> <option value="Canceled">Canceled</option> </select>
        </div>
        <div class="form-field"><label for="event-date">Event Date *</label> <input type="date" id="event-date" required>
        </div>
        <div class="form-field"><label for="event-start-time">Start Time</label> <input type="time" id="event-start-time">
        </div>
        <div class="form-field"><label for="event-end-time">End Time</label> <input type="time" id="event-end-time">
        </div>
        <div class="form-field"><label for="pickup-time">Pickup Time</label> <input type="time" id="pickup-time">
        </div>
       </div>
      </div><!-- Group Info -->
      <div class="form-section">
       <h3>Group Contact</h3>
       <div class="form-grid">
        <div class="form-field"><label for="group-name">Group Name *</label> <input type="text" id="group-name" required>
        </div>
        <div class="form-field"><label for="department-name">Department Name</label> <input type="text" id="department-name" placeholder="e.g., HR, Marketing, Sales">
        </div>
        <div class="form-field"><label for="group-contact-name">Contact Name</label> <input type="text" id="group-contact-name">
        </div>
        <div class="form-field"><label for="group-contact-email">Email</label> <input type="email" id="group-contact-email">
        </div>
        <div class="form-field"><label for="group-contact-phone">Phone</label> <input type="tel" id="group-contact-phone">
        </div>
       </div>
      </div><!-- Location -->
      <div class="form-section">
       <h3>Event Location</h3>
       <div class="form-grid">
        <div class="form-field" style="grid-column: 1 / -1;"><label for="event-address">Address</label> <input type="text" id="event-address">
        </div>
        <div class="form-field"><label for="event-city">City</label> <input type="text" id="event-city">
        </div>
        <div class="form-field"><label for="event-state">State</label> <input type="text" id="event-state" maxlength="2">
        </div>
        <div class="form-field"><label for="event-zip">Zip</label> <input type="text" id="event-zip">
        </div>
       </div>
      </div><!-- Sandwiches -->
      <div class="form-section">
       <h3>Sandwiches</h3>
       <div class="form-grid">
        <div class="form-field"><label for="sandwich-type">Type</label> <input type="text" id="sandwich-type" placeholder="e.g., Turkey, Ham, Veggie">
        </div>
        <div class="form-field"><label for="sandwich-count-planned">Planned Count</label> <input type="text" id="sandwich-count-planned" placeholder="e.g., 50 or 50-100">
        </div>
        <div class="form-field"><label for="sandwich-count-actual">Actual Count</label> <input type="text" id="sandwich-count-actual" placeholder="e.g., 50 or 50-100">
        </div>
       </div>
      </div><!-- Destination -->
      <div class="form-section">
       <h3>Destination</h3>
       <div class="form-grid">
        <div class="form-field"><label for="destination-name">Organization Name</label> <input type="text" id="destination-name" placeholder="e.g., City Shelter, Community Center">
        </div>
        <div class="form-field" style="grid-column: 1 / -1;"><label for="destination-address">Address (optional)</label> <input type="text" id="destination-address" placeholder="Full address if needed">
        </div>
       </div>
      </div><!-- Assignments -->
      <div class="form-section">
       <h3>Team Assignments</h3>
       <div class="form-grid">
        <div class="form-field"><label for="tsp-contact">TSP Contact</label> <input type="text" id="tsp-contact">
        </div>
       </div><!-- Driver Section -->
       <div style="margin-top: 20px; padding: 16px; background: #f8fafc; border-radius: 8px;">
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;"><strong style="font-size: 15px;">üöó Driver</strong> <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;"> <input type="checkbox" id="driver-needed" onchange="toggleDriverSection()"> <span>Driver Needed</span> </label> <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; margin-left: 16px;"> <input type="checkbox" id="self-transport" onchange="toggleSelfTransport()"> <span style="color: #059669; font-weight: 600;">üöö Self-Transport</span> </label>
        </div>
        <div id="driver-details" style="display: none;">
         <div class="form-grid">
          <div class="form-field"><label for="driver-count">Number of Drivers</label> <input type="number" id="driver-count" min="1" value="1" onchange="updateDriverAssignmentState()">
          </div>
          <div class="form-field"><label style="display: flex; align-items: center; gap: 6px; cursor: pointer; margin-top: 24px;"> <input type="checkbox" id="refrigerated-van-needed"> <span style="font-weight: 600; color: #a31c41;">‚ùÑÔ∏è Refrigerated Van Required</span> </label>
          </div>
         </div>
         <div class="form-field" style="margin-top: 12px;" id="driver-assignment-field">
          <label for="driver-name-select">Assign Driver</label>
          <div style="display: flex; gap: 8px; align-items: flex-start;">
           <select id="driver-name-select" style="flex: 1; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
            <option value="">-- Select Driver --</option>
           </select>
           <button type="button" class="button-secondary" onclick="assignDriver()" style="padding: 8px 16px; white-space: nowrap;">Assign</button>
          </div>
          <div id="driver-assigned-list" style="margin-top: 12px; min-height: 40px;">
           <!-- Assigned drivers will appear here -->
          </div>
          <input type="hidden" id="driver-name" value="">
         </div>
         <div class="checkbox-field" style="margin-top: 8px; display: none;" id="driver-attendance-field"><input type="checkbox" id="driver-present"> <label for="driver-present">Driver(s) Attended Event</label>
         </div>
        </div>
       </div><!-- Speaker Section -->
       <div style="margin-top: 16px; padding: 16px; background: #f8fafc; border-radius: 8px;">
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;"><strong style="font-size: 15px;">üé§ Speaker</strong> <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;"> <input type="checkbox" id="speaker-needed" onchange="toggleSpeakerSection()"> <span>Speaker Needed</span> </label>
        </div>
        <div id="speaker-details" style="display: none;">
         <div class="form-grid">
          <div class="form-field"><label for="speaker-count">Number of Speakers</label> <input type="number" id="speaker-count" min="1" value="1" onchange="updateSpeakerAssignmentState()">
          </div>
         </div>
         <div class="form-field" style="margin-top: 12px;" id="speaker-assignment-field">
          <label for="speaker-name-select">Assign Speaker</label>
          <div style="display: flex; gap: 8px; align-items: flex-start;">
           <select id="speaker-name-select" style="flex: 1; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
            <option value="">-- Select Speaker --</option>
           </select>
           <button type="button" class="button-secondary" onclick="assignSpeaker()" style="padding: 8px 16px; white-space: nowrap;">Assign</button>
          </div>
          <div id="speaker-assigned-list" style="margin-top: 12px; min-height: 40px;">
           <!-- Assigned speakers will appear here -->
          </div>
          <input type="hidden" id="speaker-name" value="">
         </div>
         <div class="checkbox-field" style="margin-top: 8px; display: none;" id="speaker-attendance-field"><input type="checkbox" id="speaker-present"> <label for="speaker-present">Speaker(s) Attended Event</label>
         </div>
        </div>
       </div><!-- Volunteer Section -->
       <div style="margin-top: 16px; padding: 16px; background: #f8fafc; border-radius: 8px;">
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;"><strong style="font-size: 15px;">üôã Volunteers</strong> <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;"> <input type="checkbox" id="volunteer-needed" onchange="toggleVolunteerSection()"> <span>Volunteers Needed</span> </label>
        </div>
        <div id="volunteer-details" style="display: none;">
         <div class="form-grid">
          <div class="form-field"><label for="volunteer-count">Number of Volunteers</label> <input type="number" id="volunteer-count" min="1" value="1" onchange="updateVolunteerAssignmentState()">
          </div>
         </div>
         <div class="form-field" style="margin-top: 12px;" id="volunteer-assignment-field">
          <label for="volunteer-name-select">Assign Volunteer</label>
          <div style="display: flex; gap: 8px; align-items: flex-start;">
           <select id="volunteer-name-select" style="flex: 1; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
            <option value="">-- Select Volunteer --</option>
           </select>
           <button type="button" class="button-secondary" onclick="assignVolunteer()" style="padding: 8px 16px; white-space: nowrap;">Assign</button>
          </div>
          <div id="volunteer-assigned-list" style="margin-top: 12px; min-height: 40px;">
           <!-- Assigned volunteers will appear here -->
          </div>
          <input type="hidden" id="volunteer-name" value="">
         </div>
         <div class="checkbox-field" style="margin-top: 8px; display: none;" id="volunteer-attendance-field"><input type="checkbox" id="volunteer-present"> <label for="volunteer-present">Volunteer(s) Attended Event</label>
         </div>
        </div>
       </div>
      </div><!-- Follow-up -->
      <div class="form-section">
       <h3>Follow-up</h3>
       <div class="form-grid">
        <div class="form-field"><label for="collection-log-link">Collection Log Link</label> <input type="url" id="collection-log-link" placeholder="https://">
        </div>
        <div class="form-field">
         <div class="checkbox-field"><input type="checkbox" id="photo-followup"> <label for="photo-followup">Photo Follow-up Done</label>
         </div>
         <div class="checkbox-field"><input type="checkbox" id="final-count-recorded"> <label for="final-count-recorded">Final Count Recorded</label>
         </div>
        </div>
       </div>
      </div><!-- Notes -->
      <div class="form-section">
       <h3>Notes</h3>
       <div class="form-field"><textarea id="event-notes" placeholder="Add any notes about this event..."></textarea>
       </div>
      </div><!-- Group History -->
      <div class="form-section" id="group-history-section" style="display: none;">
       <h3>Group History</h3>
       <div id="group-history-content"></div>
      </div><!-- Actions -->
      <div class="button-group"><button type="submit" class="action-button" id="save-button"> <span id="save-button-text">Save Event</span> </button> <button type="button" class="button-secondary" onclick="closeEventModal()">Cancel</button> <button type="button" class="button-danger" id="delete-button" onclick="deleteEvent()" style="margin-left: auto; display: none;">Delete Event</button>
      </div>
     </form>
    </div>
   </div>
  </div><!-- Role Management Modal -->
  <div class="modal-overlay" id="role-management-modal">
   <div class="modal-content" style="max-width: 800px;">
    <div class="modal-header">
     <h2>Manage Role Lists</h2><button class="modal-close" onclick="closeRoleManagementModal()">√ó</button>
    </div>
    <div class="modal-body">
     <div style="margin-bottom: 24px;">
      <p style="color: #64748b; margin-bottom: 16px;">Manage lists of people for each role. You can paste names (one per line) or import from a file.</p>
      <div style="display: flex; gap: 12px; margin-bottom: 16px;">
       <button class="button-secondary" onclick="exportRoleLists()">üì• Export Lists</button>
       <button class="button-secondary" onclick="document.getElementById('role-import-file').click()">üìä Import from File</button>
       <input type="file" id="role-import-file" accept=".txt,.csv" style="display: none;" onchange="importRoleListsFromFile(event)">
      </div>
     </div>
     <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 24px;">
      <div>
       <h3 style="margin: 0 0 12px 0; font-size: 18px;">üöó Drivers</h3>
       <textarea id="drivers-list" placeholder="Enter driver names, one per line..." style="width: 100%; min-height: 200px; padding: 12px; border: 1px solid #e2e8f0; border-radius: 6px; font-family: inherit; font-size: 14px;"></textarea>
       <button class="button-secondary" style="margin-top: 8px; width: 100%;" onclick="saveRoleList('drivers')">Save Drivers</button>
      </div>
      <div>
       <h3 style="margin: 0 0 12px 0; font-size: 18px;">üé§ Speakers</h3>
       <textarea id="speakers-list" placeholder="Enter speaker names, one per line..." style="width: 100%; min-height: 200px; padding: 12px; border: 1px solid #e2e8f0; border-radius: 6px; font-family: inherit; font-size: 14px;"></textarea>
       <button class="button-secondary" style="margin-top: 8px; width: 100%;" onclick="saveRoleList('speakers')">Save Speakers</button>
      </div>
      <div>
       <h3 style="margin: 0 0 12px 0; font-size: 18px;">üôã Volunteers</h3>
       <textarea id="volunteers-list" placeholder="Enter volunteer names, one per line..." style="width: 100%; min-height: 200px; padding: 12px; border: 1px solid #e2e8f0; border-radius: 6px; font-family: inherit; font-size: 14px;"></textarea>
       <button class="button-secondary" style="margin-top: 8px; width: 100%;" onclick="saveRoleList('volunteers')">Save Volunteers</button>
      </div>
     </div>
     <div class="button-group" style="margin-top: 24px;"><button class="action-button" onclick="closeRoleManagementModal()">Done</button>
     </div>
    </div>
   </div>
  </div><!-- Import Confirmation Modal -->
  <div class="modal-overlay" id="import-modal">
   <div class="modal-content" style="max-width: 600px;">
    <div class="modal-header">
     <h2>Import Excel File</h2><button class="modal-close" onclick="closeImportModal()">√ó</button>
    </div>
    <div class="modal-body">
     <div id="import-preview"></div>
     <div class="button-group" style="margin-top: 24px;"><button class="action-button" id="confirm-import-button" onclick="confirmImport()"> <span id="import-button-text">Import Events</span> </button> <button type="button" class="button-secondary" onclick="closeImportModal()">Cancel</button>
     </div>
    </div>
   </div>
  </div><!-- Toast Notification -->
  <div class="toast" id="toast"><span id="toast-message"></span>
  </div>
  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAB6O8WSqMSNJJv4wDG_8HTNpnegR1hBYo",
      authDomain: "tsp-event-planner.firebaseapp.com",
      databaseURL: "https://tsp-event-planner-default-rtdb.firebaseio.com", // Add your Realtime Database URL here
      projectId: "tsp-event-planner",
      storageBucket: "tsp-event-planner.firebasestorage.app",
      messagingSenderId: "336619975760",
      appId: "1:336619975760:web:e5333b61193f83be980d55",
      measurementId: "G-Y03DLYT5P6"
    };

    // Initialize Firebase
    let database;
    let analytics;
    if (typeof firebase !== 'undefined') {
      try {
        firebase.initializeApp(firebaseConfig);
        database = firebase.database();
        // Analytics is optional - only initialize if available
        if (firebase.analytics) {
          analytics = firebase.analytics();
        }
        console.log('‚úì Firebase initialized with Realtime Database');
      } catch (error) {
        console.error('Firebase initialization error:', error);
      }
    } else {
      console.warn('Firebase SDK not loaded');
    }

    // Global state
    let allEvents = [];
    let currentEvent = null;
    let currentTab = 'attention';
    let weekOffset = 0; // 0 = current week, 1 = next week, -1 = previous week, etc.
    let staffingSubTab = 'drivers'; // 'drivers', 'speakers', or 'volunteers'
    let mapInstance = null;
    let mapMarkers = [];
    let calendarMonthOffset = 0; // 0 = current month, 1 = next month, etc.
    let driverSortField = 'date';
    let driverSortAsc = true;
    let pendingImportData = [];
    
    // Role lists
    let roleLists = {
      drivers: [],
      speakers: [],
      volunteers: []
    };

    // Default config
    const defaultConfig = {
      dashboard_title: "Event Planning Dashboard",
      attention_section_title: "Attention Needed",
      pipeline_section_title: "Pipeline & Calendar",
      driver_section_title: "Driver Needs",
      completed_section_title: "Completed Events",
      reports_section_title: "Reports & Trends"
    };

    // Load events from Firebase Realtime Database
    function loadEventsFromFirebase() {
      if (!database) {
        console.warn('Firebase database not available');
        return;
      }

      console.log('Loading events from Firebase...');
      database.ref('events').once('value')
        .then(snapshot => {
          const data = snapshot.val();
          allEvents = [];
          
          if (data) {
            // Convert Firebase object to array
            Object.keys(data).forEach(key => {
              allEvents.push({
                __backendId: key,
                ...data[key]
              });
            });
          }
          
          console.log('=== DATA LOADED FROM FIREBASE ===');
          console.log('Total events:', allEvents.length);
          if (allEvents.length > 0) {
            console.log('Sample event:', allEvents[0]);
          }
          
          autoCompletePassedEvents();
          renderCurrentView();
        })
        .catch(error => {
          console.error('Error loading events from Firebase:', error);
          showToast('Error loading events. Please refresh the page.', 'error');
        });
    }

    // Set up real-time listener for events
    function setupFirebaseListener() {
      if (!database) {
        console.warn('Firebase database not available');
        return;
      }

      database.ref('events').on('value', (snapshot) => {
        const data = snapshot.val();
        allEvents = [];
        
        if (data) {
          Object.keys(data).forEach(key => {
            allEvents.push({
              __backendId: key,
              ...data[key]
            });
          });
        }
        
        // Don't auto-complete on listener updates to avoid infinite loops
        // Auto-complete only runs on initial load
        renderCurrentView();
      });
    }

    // Auto-complete events that have passed (only runs once on initial load)
    let autoCompleteHasRun = false;
    async function autoCompletePassedEvents() {
      // Only run once to avoid infinite loops
      if (autoCompleteHasRun) {
        return;
      }
      autoCompleteHasRun = true;

      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      const eventsToComplete = allEvents.filter(e => {
        if (e.status === 'Completed' || e.status === 'Canceled') return false;
        if (!e.event_date) return false;
        
        const eventDate = new Date(e.event_date);
        eventDate.setHours(0, 0, 0, 0);
        
        return eventDate < today;
      });

      if (eventsToComplete.length === 0) {
        console.log('No past events to auto-complete');
        return;
      }

      if (!database) {
        console.warn('Firebase database not available, skipping auto-complete');
        return;
      }

      console.log(`Auto-completing ${eventsToComplete.length} past event(s)...`);

      let completedCount = 0;
      let failedCount = 0;
      const failedEvents = [];

      for (const event of eventsToComplete) {
        await new Promise(resolve => setTimeout(resolve, 100));

        const updatedEvent = {
          ...event,
          status: 'Completed',
          status_completed_at: new Date().toISOString(),
          last_activity_at: new Date().toISOString()
        };

        try {
          // Remove __backendId before updating
          const { __backendId, ...eventData } = updatedEvent;
          await database.ref(`events/${__backendId}`).update(eventData);
          completedCount++;
          
          // Only log every 50th event to reduce console spam
          if (completedCount % 50 === 0) {
            console.log(`  Progress: ${completedCount}/${eventsToComplete.length} completed...`);
          }
        } catch (error) {
          failedCount++;
          failedEvents.push(`${event.group_name} - ${formatDate(event.event_date)}`);
          console.error(`‚úó Failed to auto-complete: ${event.group_name}`, error);
        }
      }
      
      console.log(`‚úì Auto-complete finished: ${completedCount} completed, ${failedCount} failed`);
      if (failedEvents.length > 0) {
        console.log('Failed events:', failedEvents);
      }
    }

    // Initialize SDKs with retry logic
    async function initApp() {
      console.log('=== INITIALIZING APP ===');
      
      // Initialize Element SDK FIRST and SYNCHRONOUSLY (if available)
      if (window.elementSdk) {
        console.log('Initializing Element SDK...');
        window.elementSdk.init({
          defaultConfig,
          onConfigChange: async (config) => {
            document.getElementById('dashboard-title').textContent = config.dashboard_title || defaultConfig.dashboard_title;
            document.getElementById('attention-tab-label').textContent = config.attention_section_title || defaultConfig.attention_section_title;
            document.getElementById('pipeline-tab-label').textContent = config.pipeline_section_title || defaultConfig.pipeline_section_title;
            // Staffing tab label is now fixed, but keep for compatibility
            if (document.getElementById('staffing-tab-label')) {
              document.getElementById('staffing-tab-label').textContent = 'Staffing';
            }
            document.getElementById('completed-tab-label').textContent = config.completed_section_title || defaultConfig.completed_section_title;
            document.getElementById('reports-tab-label').textContent = config.reports_section_title || defaultConfig.reports_section_title;
          },
          mapToCapabilities: (config) => ({
            recolorables: [],
            borderables: [],
            fontEditable: undefined,
            fontSizeable: undefined
          }),
          mapToEditPanelValues: (config) => new Map([
            ["dashboard_title", config.dashboard_title || defaultConfig.dashboard_title],
            ["attention_section_title", config.attention_section_title || defaultConfig.attention_section_title],
            ["pipeline_section_title", config.pipeline_section_title || defaultConfig.pipeline_section_title],
            ["driver_section_title", config.driver_section_title || defaultConfig.driver_section_title],
            ["completed_section_title", config.completed_section_title || defaultConfig.completed_section_title],
            ["reports_section_title", config.reports_section_title || defaultConfig.reports_section_title]
          ])
        });
        console.log('‚úì Element SDK initialized');
      }
      // Element SDK is optional - no warning needed if not available

      // Load data from Firebase Realtime Database
      if (database) {
        console.log('Loading events from Firebase...');
        loadEventsFromFirebase();
        setupFirebaseListener();
        console.log('‚úì Firebase data loading initialized');
      } else {
        console.warn('Firebase database not available');
      }
      
      console.log('=== APP READY ===');
    }

    // Initialize immediately
    initApp();

    // Tab switching
    document.querySelectorAll('.tab-button').forEach(button => {
      button.addEventListener('click', () => {
        const tab = button.dataset.tab;
        switchTab(tab);
      });
    });

    function switchTab(tab) {
      currentTab = tab;
      
      document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      
      document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
      document.getElementById(`${tab}-tab`).classList.add('active');
      
      // Initialize staffing sub-tabs when switching to staffing tab
      if (tab === 'staffing') {
        staffingSubTab = 'drivers';
        document.querySelectorAll('.staffing-subtab-button').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.staffing-subtab-content').forEach(content => content.style.display = 'none');
        document.getElementById('staffing-subtab-drivers').classList.add('active');
        document.getElementById('staffing-content-drivers').style.display = 'block';
      }
      
      renderCurrentView();
    }

    function renderCurrentView() {
      switch(currentTab) {
        case 'attention':
          renderAttentionNeeded();
          break;
        case 'pipeline':
          renderPipeline();
          break;
        case 'staffing':
          renderStaffingNeeds();
          break;
        case 'map':
          renderMapView();
          break;
        case 'calendar':
          renderCalendarView();
          break;
        case 'completed':
          renderCompletedEvents();
          break;
        case 'reports':
          renderReports();
          break;
      }
    }

    // Attention Needed View
    function renderAttentionNeeded() {
      const now = new Date();
      const sevenDaysAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
      const fourteenDaysFromNow = new Date(now.getTime() + 14 * 24 * 60 * 60 * 1000);

      // Render next 7 days calendar
      renderNext7Days();

      // New requests not assigned
      const newRequests = allEvents.filter(e => 
        e.status === 'New' && (!e.tsp_contact || e.tsp_contact.trim() === '')
      );

      // Stalled events
      const stalledEvents = allEvents.filter(e => {
        if (e.status !== 'In Process') return false;
        const lastActivity = e.last_activity_at ? new Date(e.last_activity_at) : new Date(e.created_at);
        return lastActivity < sevenDaysAgo;
      });

      // Upcoming missing info
      const upcomingMissing = allEvents.filter(e => {
        if (e.status !== 'Scheduled') return false;
        const eventDate = new Date(e.event_date);
        if (eventDate > fourteenDaysFromNow || eventDate < now) return false;
        
        const missingDriver = e.driver_needed && !e.driver_name_assigned;
        const missingSpeaker = e.speaker_needed && !e.speaker_name_assigned;
        const missingVolunteer = e.volunteer_needed && !e.volunteer_name_assigned;
        
        return missingDriver || missingSpeaker || missingVolunteer || !e.event_address || !e.sandwich_type;
      });

      // Update badges
      const totalAttention = newRequests.length + stalledEvents.length + upcomingMissing.length;
      document.getElementById('attention-badge').textContent = totalAttention;
      document.getElementById('new-requests-count').textContent = newRequests.length;
      document.getElementById('stalled-count').textContent = stalledEvents.length;
      document.getElementById('upcoming-missing-count').textContent = upcomingMissing.length;

      // Render lists
      renderEventList('new-requests-list', newRequests, renderNewRequestItem);
      renderEventList('stalled-list', stalledEvents, renderStalledItem);
      renderEventList('upcoming-missing-list', upcomingMissing, renderUpcomingMissingItem);
    }

    function changeWeek(offset) {
      if (offset === 0) {
        weekOffset = 0; // Reset to current week
      } else {
        weekOffset += offset;
      }
      renderNext7Days();
    }

    function renderNext7Days() {
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      // Calculate the start date based on week offset
      const weekStart = new Date(today.getTime() + weekOffset * 7 * 24 * 60 * 60 * 1000);
      const weekEnd = new Date(weekStart.getTime() + 7 * 24 * 60 * 60 * 1000);

      // Get events in the selected week (excluding canceled)
      const upcomingEvents = allEvents.filter(e => {
        if (e.status === 'Canceled') return false;
        if (!e.event_date) return false;
        
        const eventDate = new Date(e.event_date);
        eventDate.setHours(0, 0, 0, 0);
        
        return eventDate >= weekStart && eventDate < weekEnd;
      });

      // Update count badge
      document.getElementById('next-7-days-count').textContent = upcomingEvents.length;

      // Group events by date
      const eventsByDate = {};
      upcomingEvents.forEach(event => {
        const dateKey = event.event_date;
        if (!eventsByDate[dateKey]) {
          eventsByDate[dateKey] = [];
        }
        eventsByDate[dateKey].push(event);
      });

      // Sort events within each day by start time
      Object.keys(eventsByDate).forEach(dateKey => {
        eventsByDate[dateKey].sort((a, b) => {
          const timeA = a.event_start_time || '00:00';
          const timeB = b.event_start_time || '00:00';
          return timeA.localeCompare(timeB);
        });
      });

      // Generate 7 days
      const days = [];
      for (let i = 0; i < 7; i++) {
        const date = new Date(weekStart.getTime() + i * 24 * 60 * 60 * 1000);
        const dateKey = date.toISOString().split('T')[0];
        const dayEvents = eventsByDate[dateKey] || [];
        
        // Check if this date is today
        const todayCheck = new Date();
        todayCheck.setHours(0, 0, 0, 0);
        const isToday = dateKey === todayCheck.toISOString().split('T')[0];
        
        days.push({
          date: date,
          dateKey: dateKey,
          events: dayEvents,
          isToday: isToday
        });
      }

      // Render calendar
      const container = document.getElementById('next-7-days-calendar');
      
      if (upcomingEvents.length === 0) {
        const weekLabel = weekOffset === 0 ? 'the next 7 days' : weekOffset === 1 ? 'next week' : weekOffset === -1 ? 'last week' : `week ${weekOffset > 0 ? '+' : ''}${weekOffset}`;
        container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üìÖ</div><div>No events scheduled in ${weekLabel}</div></div>`;
        return;
      }

      container.innerHTML = `
        <div class="calendar-grid">
          ${days.map(day => renderCalendarDay(day)).join('')}
        </div>
      `;
    }

    function renderCalendarDay(day) {
      const dayName = day.date.toLocaleDateString('en-US', { weekday: 'short' });
      const dayNumber = day.date.getDate();
      const hasEvents = day.events.length > 0;
      
      const dayClasses = ['calendar-day'];
      if (hasEvents) dayClasses.push('has-events');
      if (day.isToday) dayClasses.push('today');

      return `
        <div class="${dayClasses.join(' ')}">
          <div class="calendar-day-header">
            <div class="calendar-day-name">${dayName}</div>
            <div class="calendar-day-date">${dayNumber}</div>
          </div>
          <div class="calendar-day-events">
            ${hasEvents 
              ? day.events.map(event => renderCalendarEvent(event)).join('')
              : '<div class="calendar-no-events">‚Äî</div>'
            }
          </div>
        </div>
      `;
    }

    // Convert military time (HH:MM) to 12-hour format (h:MM AM/PM)
    function formatTime12Hour(timeString) {
      if (!timeString || timeString.trim() === '') return '';
      const time = timeString.substring(0, 5); // Get HH:MM part
      const [hours, minutes] = time.split(':').map(Number);
      if (isNaN(hours) || isNaN(minutes)) return timeString;
      
      const period = hours >= 12 ? 'PM' : 'AM';
      const hours12 = hours === 0 ? 12 : (hours > 12 ? hours - 12 : hours);
      return `${hours12}:${String(minutes).padStart(2, '0')} ${period}`;
    }

    function renderCalendarEvent(event) {
      const statusClass = event.status.toLowerCase().replace(' ', '-');
      
      // Build time display: start time and (end time OR pickup time)
      let timeDisplay = '';
      if (event.event_start_time) {
        const startTime = formatTime12Hour(event.event_start_time);
        const endTime = event.event_end_time ? formatTime12Hour(event.event_end_time) : null;
        const pickupTime = event.pickup_time ? formatTime12Hour(event.pickup_time) : null;
        
        if (endTime) {
          timeDisplay = `${startTime} - ${endTime}`;
        } else if (pickupTime) {
          timeDisplay = `${startTime} (Pickup: ${pickupTime})`;
        } else {
          timeDisplay = startTime;
        }
      }
      
      const groupName = event.group_name || 'Unnamed Event';
      const sandwichCount = event.sandwich_count_planned || '?';
      const needsRefrigeratedVan = event.refrigerated_van_needed;

      // Parse assigned people
      const assignedDrivers = event.driver_name_assigned ? event.driver_name_assigned.split(',').map(s => s.trim()).filter(s => s) : [];
      const assignedSpeakers = event.speaker_name_assigned ? event.speaker_name_assigned.split(',').map(s => s.trim()).filter(s => s) : [];
      const assignedVolunteers = event.volunteer_name_assigned ? event.volunteer_name_assigned.split(',').map(s => s.trim()).filter(s => s) : [];

      // Check for unmet needs
      const unmetNeeds = [];
      if (event.driver_needed && !event.self_transport && (!event.driver_name_assigned || event.driver_name_assigned.trim() === '')) {
        unmetNeeds.push('üöó');
      }
      if (event.speaker_needed && (!event.speaker_name_assigned || event.speaker_name_assigned.trim() === '')) {
        unmetNeeds.push('üé§');
      }
      if (event.volunteer_needed && (!event.volunteer_name_assigned || event.volunteer_name_assigned.trim() === '')) {
        unmetNeeds.push('üë§');
      }

      // Build assigned people display
      const assignedPeople = [];
      if (assignedDrivers.length > 0) {
        assignedPeople.push(`üöó ${assignedDrivers.join(', ')}`);
      }
      if (assignedSpeakers.length > 0) {
        assignedPeople.push(`üé§ ${assignedSpeakers.join(', ')}`);
      }
      if (assignedVolunteers.length > 0) {
        assignedPeople.push(`üôã ${assignedVolunteers.join(', ')}`);
      }

      return `
        <div class="calendar-event-item status-${statusClass}" onclick="openEventDetail('${event.__backendId}')">
          <div class="calendar-event-name" title="${escapeHtml(groupName)}">${escapeHtml(groupName)}</div>
          ${timeDisplay ? `<div class="calendar-event-time">‚è∞ ${timeDisplay}</div>` : ''}
          <div class="calendar-event-count">ü•™ ${sandwichCount}</div>
          ${needsRefrigeratedVan ? '<div style="font-size: 11px; color: #a31c41; font-weight: 600; margin-top: 2px;">‚ùÑÔ∏è Fridge Van</div>' : ''}
          ${unmetNeeds.length > 0 ? `<div style="font-size: 12px; color: #A31C41; font-weight: 600; margin-top: 4px;">${unmetNeeds.join(' ')}</div>` : ''}
          ${assignedPeople.length > 0 ? `<div style="font-size: 11px; color: #475569; margin-top: 4px; line-height: 1.4;">${assignedPeople.join('<br>')}</div>` : ''}
        </div>
      `;
    }

    function renderEventList(containerId, events, renderFunc) {
      const container = document.getElementById(containerId);
      
      if (events.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚úì</div><div>All clear!</div></div>';
        return;
      }

      container.innerHTML = events.map(renderFunc).join('');
    }

    function renderNewRequestItem(event) {
      const deptDisplay = event.department_name ? `<div class="event-item-subtitle">${escapeHtml(event.department_name)}</div>` : '';
      return `
        <div class="event-item" onclick="openEventDetail('${event.__backendId}')">
          <div class="event-item-header">
            <div>
              <div class="event-item-title">${escapeHtml(event.group_name)}</div>
              ${deptDisplay}
            </div>
            <span class="status-badge status-new">New</span>
          </div>
          <div class="event-item-meta">
            <span>üìÖ ${formatDate(event.event_date)}</span>
            <span>ü•™ ${event.sandwich_count_planned || '?'} sandwiches</span>
          </div>
        </div>
      `;
    }

    function renderStalledItem(event) {
      const lastActivity = event.last_activity_at ? new Date(event.last_activity_at) : new Date(event.created_at);
      const daysAgo = Math.floor((new Date() - lastActivity) / (1000 * 60 * 60 * 24));
      const deptDisplay = event.department_name ? `<div class="event-item-subtitle">${escapeHtml(event.department_name)}</div>` : '';
      
      return `
        <div class="event-item" onclick="openEventDetail('${event.__backendId}')">
          <div class="event-item-header">
            <div>
              <div class="event-item-title">${escapeHtml(event.group_name)}</div>
              ${deptDisplay}
            </div>
            <span class="status-badge status-in-process">In Process</span>
          </div>
          <div class="event-item-meta">
            <span>üìÖ ${formatDate(event.event_date)}</span>
            <span style="color: #a31c41; font-weight: 600;">‚è∞ ${daysAgo} days ago</span>
          </div>
        </div>
      `;
    }

    function renderUpcomingMissingItem(event) {
      const missing = [];
      if (event.driver_needed && !event.driver_name_assigned && !event.self_transport) {
        const count = event.driver_count > 1 ? ` (${event.driver_count})` : '';
        missing.push(`Driver${count}`);
      }
      if (event.speaker_needed && !event.speaker_name_assigned) {
        const count = event.speaker_count > 1 ? ` (${event.speaker_count})` : '';
        missing.push(`Speaker${count}`);
      }
      if (event.volunteer_needed && !event.volunteer_name_assigned) {
        const count = event.volunteer_count > 1 ? ` (${event.volunteer_count})` : '';
        missing.push(`Volunteer${count}`);
      }
      if (!event.event_address) missing.push('Address');
      if (!event.sandwich_type) missing.push('Sandwich Type');
      // Destination removed from missing info - not required before event happens

      const deptDisplay = event.department_name ? `<div class="event-item-subtitle">${escapeHtml(event.department_name)}</div>` : '';

      return `
        <div class="event-item" onclick="openEventDetail('${event.__backendId}')">
          <div class="event-item-header">
            <div>
              <div class="event-item-title">${escapeHtml(event.group_name)}</div>
              ${deptDisplay}
            </div>
            <span class="status-badge status-scheduled">Scheduled</span>
          </div>
          <div class="event-item-meta">
            <span>üìÖ ${formatDate(event.event_date)}</span>
            ${event.refrigerated_van_needed ? '<span style="color: #a31c41; font-weight: 600;">‚ùÑÔ∏è Fridge Van</span>' : ''}
            ${event.self_transport ? '<span style="color: #059669; font-weight: 600;">üöö Self-Transport</span>' : ''}
          </div>
          <div class="missing-icons">
            ${missing.map(m => `<span class="missing-icon">‚ö†Ô∏è ${m}</span>`).join('')}
          </div>
        </div>
      `;
    }

    // Pipeline View
    function renderPipeline() {
      populateTSPFilter();
      applyPipelineFilters();
    }

    function populateTSPFilter() {
      const tspContacts = [...new Set(allEvents.map(e => e.tsp_contact).filter(Boolean))].sort();
      const select = document.getElementById('filter-tsp');
      const currentValue = select.value;
      
      select.innerHTML = '<option value="">All Contacts</option>' + 
        tspContacts.map(tsp => `<option value="${escapeHtml(tsp)}">${escapeHtml(tsp)}</option>`).join('');
      
      select.value = currentValue;
    }

    function applyPipelineFilters() {
      const statusFilter = document.getElementById('filter-status').value;
      const tspFilter = document.getElementById('filter-tsp').value;
      const dateStart = document.getElementById('filter-date-start').value;
      const dateEnd = document.getElementById('filter-date-end').value;

      let filtered = allEvents.filter(e => {
        // Exclude canceled events from pipeline view
        if (e.status === 'Canceled') return false;
        
        if (statusFilter && e.status !== statusFilter) return false;
        if (tspFilter && e.tsp_contact !== tspFilter) return false;
        if (dateStart && e.event_date < dateStart) return false;
        if (dateEnd && e.event_date > dateEnd) return false;
        return true;
      });

      filtered.sort((a, b) => {
        // Handle missing dates - put them at the end
        if (!a.event_date && !b.event_date) return 0;
        if (!a.event_date) return 1;
        if (!b.event_date) return -1;
        
        // For YYYY-MM-DD format, string comparison works perfectly
        // This is more reliable than Date object comparison
        if (a.event_date < b.event_date) return -1;
        if (a.event_date > b.event_date) return 1;
        return 0;
      });

      const tbody = document.getElementById('pipeline-table-body');
      
      if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 48px; color: #64748b;">No events match your filters</td></tr>';
        return;
      }

      tbody.innerHTML = filtered.map(event => {
        const hasDriver = event.self_transport ? true : (event.driver_needed ? !!event.driver_name_assigned : true);
        const hasSpeaker = event.speaker_needed ? !!event.speaker_name_assigned : true;
        const hasVolunteer = event.volunteer_needed ? !!event.volunteer_name_assigned : true;
        const hasDestination = !!event.destination_name;
        const hasAddress = !!event.event_address;
        const hasSandwich = !!event.sandwich_type;

        const groupDisplay = event.department_name 
          ? `<strong>${escapeHtml(event.group_name)}</strong><br><span style="font-size: 12px; color: #64748b;">${escapeHtml(event.department_name)}</span>`
          : `<strong>${escapeHtml(event.group_name)}</strong>`;

        return `
          <tr>
            <td onclick="event.stopPropagation()"><input type="checkbox" class="pipeline-event-checkbox" value="${event.__backendId}" onchange="updatePipelineBulkActions()" onclick="event.stopPropagation()"></td>
            <td onclick="openEventDetail('${event.__backendId}')">
              ${formatDate(event.event_date)}<br>
              <span style="font-size: 12px; color: #64748b;">
                ${event.event_start_time ? formatTime12Hour(event.event_start_time) : '‚Äî'} - ${event.event_end_time ? formatTime12Hour(event.event_end_time) : '‚Äî'}
                ${event.pickup_time ? `<br>Pickup: ${formatTime12Hour(event.pickup_time)}` : ''}
              </span>
              ${event.refrigerated_van_needed ? '<br><span style="font-size: 11px; color: #a31c41; font-weight: 600;">‚ùÑÔ∏è Fridge Van</span>' : ''}
              ${event.self_transport ? '<br><span style="font-size: 11px; color: #059669; font-weight: 600;">üöö Self-Transport</span>' : ''}
            </td>
            <td onclick="openEventDetail('${event.__backendId}')">${groupDisplay}</td>
            <td onclick="openEventDetail('${event.__backendId}')"><span class="status-badge status-${event.status.toLowerCase().replace(' ', '-')}">${event.status}</span></td>
            <td onclick="openEventDetail('${event.__backendId}')">${escapeHtml(event.tsp_contact || '‚Äî')}</td>
            <td onclick="openEventDetail('${event.__backendId}')">${event.sandwich_count_planned || '?'}</td>
            <td onclick="openEventDetail('${event.__backendId}')">
              <div class="completeness-indicators">
                ${event.self_transport ? `<span class="indicator-icon complete" title="Self-Transport">üöö</span>` : (event.driver_needed ? `<span class="indicator-icon ${hasDriver ? 'complete' : 'incomplete'}" title="Driver">üöó</span>` : '')}
                ${event.speaker_needed ? `<span class="indicator-icon ${hasSpeaker ? 'complete' : 'incomplete'}" title="Speaker">üé§</span>` : ''}
                ${event.volunteer_needed ? `<span class="indicator-icon ${hasVolunteer ? 'complete' : 'incomplete'}" title="Volunteer">üôã</span>` : ''}
                <span class="indicator-icon ${hasDestination ? 'complete' : 'incomplete'}" title="Destination">üìç</span>
                <span class="indicator-icon ${hasAddress ? 'complete' : 'incomplete'}" title="Address">üè¢</span>
                <span class="indicator-icon ${hasSandwich ? 'complete' : 'incomplete'}" title="Sandwich Info">ü•™</span>
              </div>
            </td>
          </tr>
        `;
      }).join('');
      
      // Update select all checkbox state
      updateSelectAllCheckbox();
    }

    // Bulk editing functions for pipeline
    function toggleSelectAllPipeline() {
      const selectAll = document.getElementById('select-all-pipeline').checked;
      const checkboxes = document.querySelectorAll('.pipeline-event-checkbox');
      checkboxes.forEach(cb => cb.checked = selectAll);
      updatePipelineBulkActions();
    }

    function updateSelectAllCheckbox() {
      const checkboxes = document.querySelectorAll('.pipeline-event-checkbox');
      const selectAll = document.getElementById('select-all-pipeline');
      if (checkboxes.length === 0) {
        selectAll.checked = false;
        selectAll.indeterminate = false;
        return;
      }
      const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
      selectAll.checked = checkedCount === checkboxes.length;
      selectAll.indeterminate = checkedCount > 0 && checkedCount < checkboxes.length;
    }

    function updatePipelineBulkActions() {
      const checkboxes = document.querySelectorAll('.pipeline-event-checkbox:checked');
      const bulkActions = document.getElementById('pipeline-bulk-actions');
      const selectedCount = document.getElementById('pipeline-selected-count');
      
      if (checkboxes.length > 0) {
        bulkActions.style.display = 'flex';
        selectedCount.textContent = `${checkboxes.length} event${checkboxes.length !== 1 ? 's' : ''} selected`;
      } else {
        bulkActions.style.display = 'none';
      }
      
      updateSelectAllCheckbox();
    }

    function clearPipelineSelection() {
      const checkboxes = document.querySelectorAll('.pipeline-event-checkbox');
      checkboxes.forEach(cb => cb.checked = false);
      document.getElementById('select-all-pipeline').checked = false;
      document.getElementById('select-all-pipeline').indeterminate = false;
      document.getElementById('bulk-status-change').value = '';
      updatePipelineBulkActions();
    }

    async function applyBulkStatusChange() {
      const newStatus = document.getElementById('bulk-status-change').value;
      if (!newStatus) {
        showToast('Please select a status to apply', 'error');
        return;
      }

      const checkboxes = document.querySelectorAll('.pipeline-event-checkbox:checked');
      if (checkboxes.length === 0) {
        showToast('Please select at least one event', 'error');
        return;
      }

      if (!database) {
        showToast('Firebase database is not available. Please refresh the page and try again.', 'error');
        return;
      }

      const selectedIds = Array.from(checkboxes).map(cb => cb.value);
      const now = new Date().toISOString();
      
      // Determine which timestamp field to update based on status
      let timestampField = '';
      if (newStatus === 'New') timestampField = 'status_new_at';
      else if (newStatus === 'In Process') timestampField = 'status_in_process_at';
      else if (newStatus === 'Scheduled') timestampField = 'status_scheduled_at';
      else if (newStatus === 'Completed') timestampField = 'status_completed_at';

      const updatePromises = selectedIds.map(async (id) => {
        const event = allEvents.find(e => e.__backendId === id);
        if (!event) return;

        const updateData = {
          status: newStatus,
          last_activity_at: now
        };

        // Only update timestamp if status changed
        if (event.status !== newStatus && timestampField) {
          updateData[timestampField] = now;
        }

        try {
          await database.ref(`events/${id}`).update(updateData);
        } catch (error) {
          console.error(`Error updating event ${id}:`, error);
          throw error;
        }
      });

      try {
        await Promise.all(updatePromises);
        showToast(`Successfully updated ${selectedIds.length} event${selectedIds.length !== 1 ? 's' : ''} to "${newStatus}"`, 'success');
        clearPipelineSelection();
        document.getElementById('bulk-status-change').value = '';
      } catch (error) {
        console.error('Error in bulk status update:', error);
        showToast('Error updating events. Some may have been updated. Please refresh and try again.', 'error');
      }
    }

    // Driver Needs View
    function switchStaffingSubTab(subTab) {
      staffingSubTab = subTab;
      
      // Update sub-tab buttons
      document.querySelectorAll('.staffing-subtab-button').forEach(btn => btn.classList.remove('active'));
      document.getElementById(`staffing-subtab-${subTab}`).classList.add('active');
      
      // Update sub-tab content
      document.querySelectorAll('.staffing-subtab-content').forEach(content => content.style.display = 'none');
      document.getElementById(`staffing-content-${subTab}`).style.display = 'block';
      
      renderStaffingNeeds();
    }

    function renderStaffingNeeds() {
      // Update main staffing badge with total needs
      const needsDriver = allEvents.filter(e => 
        e.status === 'Scheduled' && e.driver_needed && !e.self_transport && (!e.driver_name_assigned || e.driver_name_assigned.trim() === '')
      );
      const needsSpeaker = allEvents.filter(e => 
        e.status === 'Scheduled' && e.speaker_needed && (!e.speaker_name_assigned || e.speaker_name_assigned.trim() === '')
      );
      const needsVolunteer = allEvents.filter(e => 
        e.status === 'Scheduled' && e.volunteer_needed && (!e.volunteer_name_assigned || e.volunteer_name_assigned.trim() === '')
      );
      
      const totalNeeds = needsDriver.length + needsSpeaker.length + needsVolunteer.length;
      document.getElementById('staffing-badge').textContent = totalNeeds;
      document.getElementById('drivers-badge').textContent = needsDriver.length;
      document.getElementById('speakers-badge').textContent = needsSpeaker.length;
      document.getElementById('volunteers-badge').textContent = needsVolunteer.length;

      // Render the active sub-tab
      if (staffingSubTab === 'drivers') {
        renderDriverNeeds();
      } else if (staffingSubTab === 'speakers') {
        renderSpeakerNeeds();
      } else if (staffingSubTab === 'volunteers') {
        renderVolunteerNeeds();
      }
    }

    function renderDriverNeeds() {
      let needsDriver = allEvents.filter(e => 
        e.status === 'Scheduled' && e.driver_needed && !e.self_transport && (!e.driver_name_assigned || e.driver_name_assigned.trim() === '')
      );

      // Sort
      needsDriver.sort((a, b) => {
        if (driverSortField === 'date') {
          const dateA = new Date(a.event_date);
          const dateB = new Date(b.event_date);
          return driverSortAsc ? dateA - dateB : dateB - dateA;
        } else if (driverSortField === 'area') {
          const areaA = a.event_zip || a.event_city || '';
          const areaB = b.event_zip || b.event_city || '';
          return driverSortAsc ? areaA.localeCompare(areaB) : areaB.localeCompare(areaA);
        }
        return 0;
      });

      const tbody = document.getElementById('drivers-table-body');
      
      if (needsDriver.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 48px; color: #64748b;">All scheduled events have drivers assigned! üéâ</td></tr>';
        return;
      }

      tbody.innerHTML = needsDriver.map(event => {
        const groupDisplay = event.department_name 
          ? `<strong>${escapeHtml(event.group_name)}</strong><br><span style="font-size: 12px; color: #64748b;">${escapeHtml(event.department_name)}</span>`
          : `<strong>${escapeHtml(event.group_name)}</strong>`;

        const driverCount = event.driver_count || 1;
        const needsRefrigeratedVan = event.refrigerated_van_needed;

        return `
          <tr>
            <td>
              ${formatDate(event.event_date)}
              ${needsRefrigeratedVan ? '<br><span style="font-size: 11px; color: #a31c41; font-weight: 600;">‚ùÑÔ∏è Fridge Van</span>' : ''}
            </td>
            <td>
              ${event.event_start_time ? formatTime12Hour(event.event_start_time) : '‚Äî'} - ${event.event_end_time ? formatTime12Hour(event.event_end_time) : '‚Äî'}
              ${event.pickup_time ? `<br><span style="font-size: 11px; color: #64748b;">Pickup: ${formatTime12Hour(event.pickup_time)}</span>` : ''}
            </td>
            <td>
              ${groupDisplay}
              ${driverCount > 1 ? `<br><span style="font-size: 11px; color: #236383; font-weight: 600;">üöó Need ${driverCount} drivers</span>` : ''}
            </td>
            <td>${escapeHtml(event.event_city || '')} ${escapeHtml(event.event_zip || '')}</td>
            <td>${escapeHtml(event.event_address || '‚Äî')}</td>
            <td>${event.sandwich_count_planned || '?'}</td>
            <td>${escapeHtml(event.destination_name || 'TBD')}</td>
            <td><button class="button-secondary" style="padding: 8px 16px; font-size: 13px;" onclick="openEventDetail('${event.__backendId}'); event.stopPropagation();">Assign</button></td>
          </tr>
        `;
      }).join('');
    }

    function sortStaffingNeeds(field) {
      if (driverSortField === field) {
        driverSortAsc = !driverSortAsc;
      } else {
        driverSortField = field;
        driverSortAsc = true;
      }
      renderStaffingNeeds();
    }

    function renderSpeakerNeeds() {
      let needsSpeaker = allEvents.filter(e => 
        e.status === 'Scheduled' && e.speaker_needed && (!e.speaker_name_assigned || e.speaker_name_assigned.trim() === '')
      );

      // Sort
      needsSpeaker.sort((a, b) => {
        if (driverSortField === 'date') {
          const dateA = new Date(a.event_date);
          const dateB = new Date(b.event_date);
          return driverSortAsc ? dateA - dateB : dateB - dateA;
        } else if (driverSortField === 'area') {
          const areaA = a.event_zip || a.event_city || '';
          const areaB = b.event_zip || b.event_city || '';
          return driverSortAsc ? areaA.localeCompare(areaB) : areaB.localeCompare(areaA);
        }
        return 0;
      });

      const tbody = document.getElementById('speakers-table-body');
      
      if (needsSpeaker.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 48px; color: #64748b;">All scheduled events have speakers assigned! üéâ</td></tr>';
        return;
      }

      tbody.innerHTML = needsSpeaker.map(event => {
        const groupDisplay = event.department_name 
          ? `<strong>${escapeHtml(event.group_name)}</strong><br><span style="font-size: 12px; color: #64748b;">${escapeHtml(event.department_name)}</span>`
          : `<strong>${escapeHtml(event.group_name)}</strong>`;

        return `
          <tr>
            <td>
              ${formatDate(event.event_date)}
            </td>
            <td>
              ${event.event_start_time ? formatTime12Hour(event.event_start_time) : '‚Äî'} - ${event.event_end_time ? formatTime12Hour(event.event_end_time) : '‚Äî'}
              ${event.pickup_time ? `<br><span style="font-size: 11px; color: #64748b;">Pickup: ${formatTime12Hour(event.pickup_time)}</span>` : ''}
            </td>
            <td>
              ${groupDisplay}
            </td>
            <td>${escapeHtml(event.event_city || '')} ${escapeHtml(event.event_zip || '')}</td>
            <td>${escapeHtml(event.event_address || '‚Äî')}</td>
            <td>${event.sandwich_count_planned || '?'}</td>
            <td>${escapeHtml(event.destination_name || 'TBD')}</td>
            <td><button class="button-secondary" style="padding: 8px 16px; font-size: 13px;" onclick="openEventDetail('${event.__backendId}'); event.stopPropagation();">Assign</button></td>
          </tr>
        `;
      }).join('');
    }

    function renderVolunteerNeeds() {
      let needsVolunteer = allEvents.filter(e => 
        e.status === 'Scheduled' && e.volunteer_needed && (!e.volunteer_name_assigned || e.volunteer_name_assigned.trim() === '')
      );

      // Sort
      needsVolunteer.sort((a, b) => {
        if (driverSortField === 'date') {
          const dateA = new Date(a.event_date);
          const dateB = new Date(b.event_date);
          return driverSortAsc ? dateA - dateB : dateB - dateA;
        } else if (driverSortField === 'area') {
          const areaA = a.event_zip || a.event_city || '';
          const areaB = b.event_zip || b.event_city || '';
          return driverSortAsc ? areaA.localeCompare(areaB) : areaB.localeCompare(areaA);
        }
        return 0;
      });

      const tbody = document.getElementById('volunteers-table-body');
      
      if (needsVolunteer.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 48px; color: #64748b;">All scheduled events have volunteers assigned! üéâ</td></tr>';
        return;
      }

      tbody.innerHTML = needsVolunteer.map(event => {
        const groupDisplay = event.department_name 
          ? `<strong>${escapeHtml(event.group_name)}</strong><br><span style="font-size: 12px; color: #64748b;">${escapeHtml(event.department_name)}</span>`
          : `<strong>${escapeHtml(event.group_name)}</strong>`;

        return `
          <tr>
            <td>
              ${formatDate(event.event_date)}
            </td>
            <td>
              ${event.event_start_time ? formatTime12Hour(event.event_start_time) : '‚Äî'} - ${event.event_end_time ? formatTime12Hour(event.event_end_time) : '‚Äî'}
              ${event.pickup_time ? `<br><span style="font-size: 11px; color: #64748b;">Pickup: ${formatTime12Hour(event.pickup_time)}</span>` : ''}
            </td>
            <td>
              ${groupDisplay}
            </td>
            <td>${escapeHtml(event.event_city || '')} ${escapeHtml(event.event_zip || '')}</td>
            <td>${escapeHtml(event.event_address || '‚Äî')}</td>
            <td>${event.sandwich_count_planned || '?'}</td>
            <td>${escapeHtml(event.destination_name || 'TBD')}</td>
            <td><button class="button-secondary" style="padding: 8px 16px; font-size: 13px;" onclick="openEventDetail('${event.__backendId}'); event.stopPropagation();">Assign</button></td>
          </tr>
        `;
      }).join('');
    }

    // Completed Events View
    function renderCompletedEvents() {
      const completedEvents = allEvents.filter(e => e.status === 'Completed');
      
      // Update badge
      document.getElementById('completed-badge').textContent = completedEvents.length;

      // Populate TSP filter
      const tspContacts = [...new Set(completedEvents.map(e => e.tsp_contact).filter(Boolean))].sort();
      const select = document.getElementById('completed-filter-tsp');
      const currentValue = select.value;
      
      select.innerHTML = '<option value="">All Contacts</option>' + 
        tspContacts.map(tsp => `<option value="${escapeHtml(tsp)}">${escapeHtml(tsp)}</option>`).join('');
      
      select.value = currentValue;

      applyCompletedFilters();
    }

    function applyCompletedFilters() {
      const tspFilter = document.getElementById('completed-filter-tsp').value;
      const dateStart = document.getElementById('completed-filter-date-start').value;
      const dateEnd = document.getElementById('completed-filter-date-end').value;
      const groupFilter = document.getElementById('completed-filter-group').value.toLowerCase();

      let filtered = allEvents.filter(e => {
        if (e.status !== 'Completed') return false;
        if (tspFilter && e.tsp_contact !== tspFilter) return false;
        if (dateStart && e.event_date < dateStart) return false;
        if (dateEnd && e.event_date > dateEnd) return false;
        if (groupFilter && !e.group_name.toLowerCase().includes(groupFilter)) return false;
        return true;
      });

      // Sort by date descending (most recent first)
      filtered.sort((a, b) => {
        const dateA = new Date(a.event_date);
        const dateB = new Date(b.event_date);
        return dateB - dateA;
      });

      const tbody = document.getElementById('completed-table-body');
      
      if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 48px; color: #64748b;">No completed events match your filters</td></tr>';
        return;
      }

      tbody.innerHTML = filtered.map(event => {
        const hasPhoto = event.photo_followup_done;
        const hasFinalCount = event.final_sandwich_count_recorded;
        const followupStatus = hasPhoto && hasFinalCount ? '‚úÖ Complete' : 
                              hasPhoto ? 'üì∏ Photo only' : 
                              hasFinalCount ? 'üî¢ Count only' : 
                              '‚ö†Ô∏è Missing';

        const groupDisplay = event.department_name 
          ? `<strong>${escapeHtml(event.group_name)}</strong><br><span style="font-size: 12px; color: #64748b;">${escapeHtml(event.department_name)}</span>`
          : `<strong>${escapeHtml(event.group_name)}</strong>`;

        return `
          <tr onclick="openEventDetail('${event.__backendId}')">
            <td>${formatDate(event.event_date)}</td>
            <td>${groupDisplay}</td>
            <td>${escapeHtml(event.tsp_contact || '‚Äî')}</td>
            <td>${event.sandwich_count_planned || '‚Äî'}</td>
            <td>${event.sandwich_count_actual || '‚Äî'}</td>
            <td>${escapeHtml(event.destination_name || '‚Äî')}</td>
            <td>${followupStatus}</td>
          </tr>
        `;
      }).join('');
    }

    // Reports View
    // Map View
    function renderMapView() {
      const container = document.getElementById('map-container');
      if (!container) return;

      // Filter events
      const showScheduled = document.getElementById('map-filter-scheduled')?.checked !== false;
      const showUpcoming = document.getElementById('map-filter-upcoming')?.checked !== false;
      
      let eventsToShow = allEvents.filter(e => {
        if (e.status === 'Canceled') return false;
        if (!e.event_address && !e.event_city) return false;
        
        if (showScheduled && e.status === 'Scheduled') return true;
        if (showUpcoming) {
          if (!e.event_date) return false;
          const eventDate = new Date(e.event_date);
          const thirtyDaysFromNow = new Date();
          thirtyDaysFromNow.setDate(thirtyDaysFromNow.getDate() + 30);
          return eventDate <= thirtyDaysFromNow && eventDate >= new Date();
        }
        return false;
      });

      // Check if Google Maps API is available and working
      if (!window.google || !window.google.maps) {
        // API not loaded yet or failed - show list view instead
        renderMapAsList();
        return;
      }

      // Try to initialize map, but catch errors if API is not activated
      try {
        // Initialize map if needed
        if (!mapInstance) {
          mapInstance = new google.maps.Map(container, {
            zoom: 10,
            center: { lat: 33.7490, lng: -84.3880 }, // Default to Atlanta
            mapTypeControl: true,
            streetViewControl: true,
            fullscreenControl: true
          });
        }
      } catch (error) {
        // If map initialization fails (e.g., API not activated), show list view
        console.warn('Google Maps initialization failed, using list view:', error);
        renderMapAsList();
        return;
      }

      // Clear existing markers
      mapMarkers.forEach(marker => marker.setMap(null));
      mapMarkers = [];

      if (eventsToShow.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: #64748b; padding: 48px;"><div style="font-size: 48px; margin-bottom: 16px;">üìç</div><div>No events to display on the map</div></div>';
        return;
      }

      const bounds = new google.maps.LatLngBounds();
      const geocoder = new google.maps.Geocoder();
      let processedCount = 0;

      // Count events that have addresses to geocode
      const eventsWithAddresses = eventsToShow.filter(e => {
        const addr = `${e.event_address || ''} ${e.event_city || ''} ${e.event_zip || ''}`.trim();
        return addr.length > 0;
      });
      const totalToGeocode = eventsWithAddresses.length;

      if (totalToGeocode === 0) {
        // No events have addresses, just show Atlanta area
        return;
      }

      eventsWithAddresses.forEach((event, index) => {
        const address = `${event.event_address || ''} ${event.event_city || ''} ${event.event_zip || ''}`.trim();

        geocoder.geocode({ address: address }, (results, status) => {
          processedCount++;

          if (status === 'OK' && results[0] && window.google && window.google.maps) {
            const location = results[0].geometry.location;

            // Determine marker color based on status and needs
            let markerColor = '#236383'; // Default: Scheduled
            if (event.status === 'In Process') markerColor = '#fbad3f';
            else if (event.status === 'Completed') markerColor = '#059669';

            // Red if needs staffing
            const needsStaffing = (event.driver_needed && !event.self_transport && !event.driver_name_assigned) ||
                                  (event.speaker_needed && !event.speaker_name_assigned) ||
                                  (event.volunteer_needed && !event.volunteer_name_assigned);
            if (needsStaffing && event.status === 'Scheduled') markerColor = '#a31c41';

            const marker = new google.maps.Marker({
              position: location,
              map: mapInstance,
              title: event.group_name,
              icon: {
                path: google.maps.SymbolPath.CIRCLE,
                scale: 8,
                fillColor: markerColor,
                fillOpacity: 1,
                strokeColor: '#ffffff',
                strokeWeight: 2
              }
            });

            // Build info window content
            const needsList = [];
            if (event.driver_needed && !event.self_transport && !event.driver_name_assigned) needsList.push('üöó Driver');
            if (event.speaker_needed && !event.speaker_name_assigned) needsList.push('üé§ Speaker');
            if (event.volunteer_needed && !event.volunteer_name_assigned) needsList.push('üë§ Volunteer');

            const infoContent = `
              <div style="padding: 8px; min-width: 200px;">
                <div style="font-weight: 600; font-size: 16px; margin-bottom: 8px; color: #1a202c;">${escapeHtml(event.group_name)}</div>
                <div style="font-size: 13px; color: #64748b; margin-bottom: 4px;">üìÖ ${formatDate(event.event_date)}</div>
                ${event.event_start_time ? `<div style="font-size: 13px; color: #64748b; margin-bottom: 4px;">‚è∞ ${formatTime12Hour(event.event_start_time)}${event.event_end_time ? ` - ${formatTime12Hour(event.event_end_time)}` : ''}</div>` : ''}
                <div style="font-size: 13px; color: #64748b; margin-bottom: 4px;">üìç ${escapeHtml(address)}</div>
                ${needsList.length > 0 ? `<div style="font-size: 13px; color: #a31c41; font-weight: 600; margin-top: 8px; padding-top: 8px; border-top: 1px solid #e2e8f0;">Needs: ${needsList.join(', ')}</div>` : ''}
                <button onclick="openEventDetail('${event.__backendId}'); google.maps.event.trigger(arguments[0].target, 'closeclick');" style="margin-top: 8px; padding: 6px 12px; background: #236383; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">View Details</button>
              </div>
            `;

            const infoWindow = new google.maps.InfoWindow({
              content: infoContent
            });

            marker.addListener('click', () => {
              infoWindow.open(mapInstance, marker);
            });

            mapMarkers.push(marker);
            bounds.extend(location);
          }

          // Adjust map bounds when all geocoding attempts are complete
          if (processedCount === totalToGeocode) {
            if (mapMarkers.length > 0) {
              mapInstance.fitBounds(bounds);
              // Don't zoom in too much if there's only one marker
              if (mapMarkers.length === 1) {
                mapInstance.setZoom(13);
              }
            }
          }
        });
      });
    }

    // Fallback list view when Maps API is not available
    function renderMapAsList() {
      const container = document.getElementById('map-container');
      if (!container) return;

      const showScheduled = document.getElementById('map-filter-scheduled')?.checked !== false;
      const showUpcoming = document.getElementById('map-filter-upcoming')?.checked !== false;
      
      let eventsToShow = allEvents.filter(e => {
        if (e.status === 'Canceled') return false;
        if (!e.event_address && !e.event_city) return false;
        
        if (showScheduled && e.status === 'Scheduled') return true;
        if (showUpcoming) {
          if (!e.event_date) return false;
          const eventDate = new Date(e.event_date);
          const thirtyDaysFromNow = new Date();
          thirtyDaysFromNow.setDate(thirtyDaysFromNow.getDate() + 30);
          return eventDate <= thirtyDaysFromNow && eventDate >= new Date();
        }
        return false;
      });

      // Show helpful message at the top
      let html = `
        <div style="margin-bottom: 16px; padding: 16px; background: #fef3c7; border-left: 4px solid #fbad3f; border-radius: 8px;">
          <div style="font-weight: 600; margin-bottom: 8px; color: #1a202c;">üìç Map View Unavailable</div>
          <div style="font-size: 14px; color: #64748b; margin-bottom: 12px;">
            Google Maps API is not enabled. Showing events in list format instead.
          </div>
          <details style="font-size: 13px; color: #64748b;">
            <summary style="cursor: pointer; color: #236383; font-weight: 600;">How to enable map view</summary>
            <ol style="margin-top: 8px; padding-left: 20px; line-height: 1.8;">
              <li>Go to <a href="https://console.cloud.google.com/apis/library" target="_blank" style="color: #236383;">Google Cloud Console ‚Üí APIs & Services ‚Üí Library</a></li>
              <li>Search for "Maps JavaScript API"</li>
              <li>Click on it and press "Enable"</li>
              <li>Wait a few minutes, then refresh this page</li>
            </ol>
          </details>
        </div>
      `;

      if (eventsToShow.length === 0) {
        html += '<div style="text-align: center; color: #64748b; padding: 48px;"><div style="font-size: 48px; margin-bottom: 16px;">üìç</div><div>No events to display</div></div>';
        container.innerHTML = html;
        return;
      }

      // Sort by date
      eventsToShow.sort((a, b) => {
        const dateA = new Date(a.event_date);
        const dateB = new Date(b.event_date);
        return dateA - dateB;
      });

      html += '<div style="display: flex; flex-direction: column; gap: 12px; max-height: 600px; overflow-y: auto; padding: 8px;">';
      
      eventsToShow.forEach(event => {
        const address = `${event.event_address || ''} ${event.event_city || ''} ${event.event_zip || ''}`.trim();
        const needsList = [];
        if (event.driver_needed && !event.self_transport && !event.driver_name_assigned) needsList.push('üöó Driver');
        if (event.speaker_needed && !event.speaker_name_assigned) needsList.push('üé§ Speaker');
        if (event.volunteer_needed && !event.volunteer_name_assigned) needsList.push('üë§ Volunteer');
        
        const statusColor = event.status === 'Scheduled' ? '#236383' : event.status === 'In Process' ? '#fbad3f' : '#059669';
        const needsIndicator = needsList.length > 0 ? `<div style="color: #a31c41; font-weight: 600; font-size: 12px; margin-top: 4px;">Needs: ${needsList.join(', ')}</div>` : '';
        
        html += `
          <div onclick="openEventDetail('${event.__backendId}')" style="padding: 16px; background: white; border-left: 4px solid ${statusColor}; border-radius: 8px; cursor: pointer; transition: all 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.1);" onmouseover="this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)'" onmouseout="this.style.boxShadow='0 1px 3px rgba(0,0,0,0.1)'">
            <div style="font-weight: 600; font-size: 16px; color: #1a202c; margin-bottom: 8px;">${escapeHtml(event.group_name)}</div>
            <div style="font-size: 13px; color: #64748b; margin-bottom: 4px;">üìÖ ${formatDate(event.event_date)}</div>
            ${event.event_start_time ? `<div style="font-size: 13px; color: #64748b; margin-bottom: 4px;">‚è∞ ${formatTime12Hour(event.event_start_time)}${event.event_end_time ? ` - ${formatTime12Hour(event.event_end_time)}` : ''}</div>` : ''}
            <div style="font-size: 13px; color: #64748b; margin-bottom: 4px;">üìç ${escapeHtml(address)}</div>
            ${needsIndicator}
          </div>
        `;
      });
      
      html += '</div>';
      container.innerHTML = html;
    }

    // Calendar View
    function changeCalendarMonth(offset) {
      if (offset === 0) {
        calendarMonthOffset = 0;
      } else {
        calendarMonthOffset += offset;
      }
      renderCalendarView();
    }

    function renderCalendarView() {
      const container = document.getElementById('calendar-grid-container');
      const header = document.getElementById('calendar-month-header');
      if (!container || !header) return;

      const today = new Date();
      const currentMonth = new Date(today.getFullYear(), today.getMonth() + calendarMonthOffset, 1);
      
      // Set header
      const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
      header.textContent = `${monthNames[currentMonth.getMonth()]} ${currentMonth.getFullYear()}`;

      // Get first day of month and number of days
      const firstDay = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1).getDay();
      const daysInMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 0).getDate();
      
      // Get events for this month
      const monthEvents = allEvents.filter(e => {
        if (e.status === 'Canceled') return false;
        if (!e.event_date) return false;
        const eventDate = new Date(e.event_date);
        return eventDate.getMonth() === currentMonth.getMonth() && 
               eventDate.getFullYear() === currentMonth.getFullYear();
      });

      // Group events by date
      const eventsByDate = {};
      monthEvents.forEach(event => {
        const dateKey = event.event_date;
        if (!eventsByDate[dateKey]) {
          eventsByDate[dateKey] = [];
        }
        eventsByDate[dateKey].push(event);
      });

      // Build calendar grid
      let html = '<div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: #e2e8f0; border-radius: 8px; overflow: hidden;">';
      
      // Day headers
      const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
      dayHeaders.forEach(day => {
        html += `<div style="background: #f8fafc; padding: 16px; text-align: center; font-weight: 600; font-size: 16px; color: #64748b; text-transform: uppercase;">${day}</div>`;
      });

      // Empty cells for days before month starts
      for (let i = 0; i < firstDay; i++) {
        html += '<div style="background: white; min-height: 150px; padding: 12px;"></div>';
      }

      // Days of the month
      for (let day = 1; day <= daysInMonth; day++) {
        const dateKey = `${currentMonth.getFullYear()}-${String(currentMonth.getMonth() + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const dayEvents = eventsByDate[dateKey] || [];
        const isToday = calendarMonthOffset === 0 && day === today.getDate() && currentMonth.getMonth() === today.getMonth();
        
        html += `<div style="background: white; min-height: 150px; padding: 12px; ${isToday ? 'border: 3px solid #236383;' : ''}">`;
        html += `<div style="font-weight: ${isToday ? '700' : '600'}; font-size: 18px; color: ${isToday ? '#236383' : '#1a202c'}; margin-bottom: 10px;">${day}</div>`;
        
        // Show up to 3 events, then "+X more"
        const eventsToShow = dayEvents.slice(0, 3);
        const moreCount = dayEvents.length - 3;
        
        eventsToShow.forEach(event => {
          const needsList = [];
          if (event.driver_needed && !event.self_transport && !event.driver_name_assigned) needsList.push('üöó');
          if (event.speaker_needed && !event.speaker_name_assigned) needsList.push('üé§');
          if (event.volunteer_needed && !event.volunteer_name_assigned) needsList.push('üë§');
          
          const statusColor = event.status === 'Scheduled' ? '#236383' : event.status === 'In Process' ? '#fbad3f' : '#059669';
          const needsIndicator = needsList.length > 0 ? `<span style="color: #a31c41; font-weight: 700; font-size: 16px;">${needsList.join('')}</span>` : '';
          
          html += `<div onclick="openEventDetail('${event.__backendId}')" style="font-size: 15px; padding: 8px 10px; margin-bottom: 6px; background: ${statusColor}15; border-left: 4px solid ${statusColor}; border-radius: 4px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='${statusColor}25'; this.style.transform='scale(1.02)'" onmouseout="this.style.background='${statusColor}15'; this.style.transform='scale(1)'">`;
          html += `<div style="font-weight: 600; color: #1a202c; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 15px; margin-bottom: 4px;">${escapeHtml(event.group_name)}</div>`;
          if (event.event_start_time) {
            html += `<div style="color: #64748b; font-size: 13px; margin-bottom: 2px;">${formatTime12Hour(event.event_start_time)}</div>`;
          }
          html += needsIndicator;
          html += '</div>';
        });
        
        if (moreCount > 0) {
          html += `<div style="font-size: 14px; color: #64748b; font-weight: 600; margin-top: 6px;">+${moreCount} more</div>`;
        }
        
        html += '</div>';
      }

      // Fill remaining cells to complete the grid
      const totalCells = firstDay + daysInMonth;
      const remainingCells = 42 - totalCells; // 6 rows * 7 days
      for (let i = 0; i < remainingCells && i < 14; i++) {
        html += '<div style="background: white; min-height: 120px; padding: 8px;"></div>';
      }

      html += '</div>';
      container.innerHTML = html;
    }

    function renderReports() {
      const totalEvents = allEvents.length;
      document.getElementById('total-events-stat').textContent = totalEvents;

      // Conversion funnel
      const totalRequests = allEvents.length;
      const scheduled = allEvents.filter(e => e.status === 'Scheduled' || e.status === 'Completed').length;
      const completed = allEvents.filter(e => e.status === 'Completed').length;

      const maxWidth = 100;
      const scheduledWidth = totalRequests > 0 ? (scheduled / totalRequests) * maxWidth : 0;
      const completedWidth = totalRequests > 0 ? (completed / totalRequests) * maxWidth : 0;

      document.getElementById('funnel-requests').textContent = totalRequests;
      document.getElementById('funnel-requests').style.width = '100%';
      
      document.getElementById('funnel-scheduled').textContent = `${scheduled} (${totalRequests > 0 ? Math.round(scheduledWidth) : 0}%)`;
      document.getElementById('funnel-scheduled').style.width = `${scheduledWidth}%`;
      
      document.getElementById('funnel-completed').textContent = `${completed} (${totalRequests > 0 ? Math.round(completedWidth) : 0}%)`;
      document.getElementById('funnel-completed').style.width = `${completedWidth}%`;

      // Events by TSP
      const tspCounts = {};
      allEvents.forEach(e => {
        const tsp = e.tsp_contact || 'Unassigned';
        tspCounts[tsp] = (tspCounts[tsp] || 0) + 1;
      });

      const tspEntries = Object.entries(tspCounts).sort((a, b) => b[1] - a[1]).slice(0, 5);
      const maxTsp = Math.max(...tspEntries.map(e => e[1]), 1);

      document.getElementById('tsp-chart').innerHTML = tspEntries.map(([tsp, count]) => {
        const width = (count / maxTsp) * 100;
        return `
          <div class="chart-bar">
            <div class="chart-label">${escapeHtml(tsp)}</div>
            <div class="chart-bar-fill" style="width: ${width}%; background: #236383;">${count}</div>
          </div>
        `;
      }).join('') || '<div style="color: #64748b; padding: 20px;">No data yet</div>';

      // Destinations
      const destCounts = {};
      allEvents.forEach(e => {
        if (e.destination_name) {
          destCounts[e.destination_name] = (destCounts[e.destination_name] || 0) + 1;
        }
      });

      const destEntries = Object.entries(destCounts).sort((a, b) => b[1] - a[1]).slice(0, 5);
      const maxDest = Math.max(...destEntries.map(e => e[1]), 1);

      document.getElementById('destinations-chart').innerHTML = destEntries.map(([dest, count]) => {
        const width = (count / maxDest) * 100;
        return `
          <div class="chart-bar">
            <div class="chart-label">${escapeHtml(dest)}</div>
            <div class="chart-bar-fill" style="width: ${width}%; background: #007e8c;">${count}</div>
          </div>
        `;
      }).join('') || '<div style="color: #64748b; padding: 20px;">No destinations recorded yet</div>';

      // Sandwiches - handle ranges by using average or first number
      const parseCountForTotal = (count) => {
        if (!count) return 0;
        const str = String(count).trim();
        // If range like "50-100", use average
        const rangeMatch = str.match(/^(\d+)-(\d+)$/);
        if (rangeMatch) {
          const min = parseInt(rangeMatch[1]);
          const max = parseInt(rangeMatch[2]);
          return Math.round((min + max) / 2);
        }
        // If single number
        const num = parseInt(str);
        return isNaN(num) ? 0 : num;
      };
      
      const totalPlanned = allEvents.reduce((sum, e) => sum + parseCountForTotal(e.sandwich_count_planned), 0);
      const totalActual = allEvents.reduce((sum, e) => sum + parseCountForTotal(e.sandwich_count_actual), 0);

      const maxSandwich = Math.max(totalPlanned, totalActual, 1);
      const plannedWidth = (totalPlanned / maxSandwich) * 100;
      const actualWidth = (totalActual / maxSandwich) * 100;

      document.getElementById('sandwiches-planned').textContent = totalPlanned;
      document.getElementById('sandwiches-planned').style.width = `${plannedWidth}%`;
      
      document.getElementById('sandwiches-actual').textContent = totalActual;
      document.getElementById('sandwiches-actual').style.width = `${actualWidth}%`;

      // Repeat groups
      const groupCounts = {};
      allEvents.forEach(e => {
        const groupId = e.group_id || e.group_name;
        groupCounts[groupId] = (groupCounts[groupId] || 0) + 1;
      });

      const newGroups = Object.values(groupCounts).filter(count => count === 1).length;
      const repeatGroups = Object.values(groupCounts).filter(count => count > 1).length;
      const totalGroups = newGroups + repeatGroups;

      const newWidth = totalGroups > 0 ? (newGroups / totalGroups) * 100 : 50;
      const repeatWidth = totalGroups > 0 ? (repeatGroups / totalGroups) * 100 : 50;

      document.getElementById('groups-new').textContent = newGroups;
      document.getElementById('groups-new').style.width = `${newWidth}%`;
      
      document.getElementById('groups-repeat').textContent = repeatGroups;
      document.getElementById('groups-repeat').style.width = `${repeatWidth}%`;
    }

    // Toggle functions for role sections
    function toggleDriverSection() {
      const needed = document.getElementById('driver-needed').checked;
      const selfTransport = document.getElementById('self-transport').checked;
      
      // If self-transport is checked, uncheck driver needed
      if (selfTransport && needed) {
        document.getElementById('driver-needed').checked = false;
        needed = false;
      }
      
      document.getElementById('driver-details').style.display = needed ? 'block' : 'none';
      updateDriverAssignmentState();
    }
    
    function toggleSelfTransport() {
      const selfTransport = document.getElementById('self-transport').checked;
      const driverNeeded = document.getElementById('driver-needed');
      const driverDetails = document.getElementById('driver-details');
      
      if (selfTransport) {
        // Uncheck driver needed and hide driver details
        driverNeeded.checked = false;
        driverDetails.style.display = 'none';
      }
      updateDriverAssignmentState();
    }

    function toggleSpeakerSection() {
      const needed = document.getElementById('speaker-needed').checked;
      document.getElementById('speaker-details').style.display = needed ? 'block' : 'none';
      updateSpeakerAssignmentState();
    }

    function toggleVolunteerSection() {
      const needed = document.getElementById('volunteer-needed').checked;
      document.getElementById('volunteer-details').style.display = needed ? 'block' : 'none';
      updateVolunteerAssignmentState();
    }

    // Update all assignment states when status changes
    function updateAllAssignmentStates() {
      updateDriverAssignmentState();
      updateSpeakerAssignmentState();
      updateVolunteerAssignmentState();
    }

    // Update assignment field states based on event status and need
    function updateDriverAssignmentState() {
      const status = document.getElementById('event-status').value;
      const needed = document.getElementById('driver-needed').checked;
      const selfTransport = document.getElementById('self-transport').checked;
      const driverNameInput = document.getElementById('driver-name');
      const driverAttendanceField = document.getElementById('driver-attendance-field');
      
      const canAssign = needed && !selfTransport && (status === 'In Process' || status === 'Scheduled' || status === 'Completed');
      const isCompleted = status === 'Completed';
      
      driverNameInput.disabled = !canAssign;
      
      // Show attendance checkbox only when event is completed and driver is needed (not self-transport)
      if (needed && !selfTransport && isCompleted) {
        driverAttendanceField.style.display = 'flex';
      } else {
        driverAttendanceField.style.display = 'none';
      }
      
      // Note: placeholder removed for select elements
    }

    function updateSpeakerAssignmentState() {
      const status = document.getElementById('event-status').value;
      const needed = document.getElementById('speaker-needed').checked;
      const speakerNameInput = document.getElementById('speaker-name');
      const speakerAttendanceField = document.getElementById('speaker-attendance-field');
      
      const canAssign = needed && (status === 'In Process' || status === 'Scheduled' || status === 'Completed');
      const isCompleted = status === 'Completed';
      
      speakerNameInput.disabled = !canAssign;
      
      // Show attendance checkbox only when event is completed
      if (needed && isCompleted) {
        speakerAttendanceField.style.display = 'flex';
      } else {
        speakerAttendanceField.style.display = 'none';
      }
      
      // Note: placeholder removed for select elements
    }

    function updateVolunteerAssignmentState() {
      const status = document.getElementById('event-status').value;
      const needed = document.getElementById('volunteer-needed').checked;
      const volunteerNameInput = document.getElementById('volunteer-name');
      const volunteerAttendanceField = document.getElementById('volunteer-attendance-field');
      
      const canAssign = needed && (status === 'In Process' || status === 'Scheduled' || status === 'Completed');
      const isCompleted = status === 'Completed';
      
      volunteerNameInput.disabled = !canAssign;
      
      // Show attendance checkbox only when event is completed
      if (needed && isCompleted) {
        volunteerAttendanceField.style.display = 'flex';
      } else {
        volunteerAttendanceField.style.display = 'none';
      }
      
      // Note: placeholder removed for select elements
    }

    // Event Modal
    function openNewEventModal() {
      currentEvent = null;
      document.getElementById('modal-title').textContent = 'New Event';
      document.getElementById('event-form').reset();
      document.getElementById('delete-button').style.display = 'none';
      document.getElementById('group-history-section').style.display = 'none';
      
      // Populate role dropdowns
      populateRoleDropdowns();
      
      // Reset assigned lists
      assignedDrivers = [];
      assignedSpeakers = [];
      assignedVolunteers = [];
      updateDriverAssignedList();
      updateSpeakerAssignedList();
      updateVolunteerAssignedList();
      
      // Reset role sections
      document.getElementById('driver-needed').checked = false;
      document.getElementById('self-transport').checked = false;
      document.getElementById('speaker-needed').checked = false;
      document.getElementById('volunteer-needed').checked = false;
      toggleDriverSection();
      toggleSpeakerSection();
      toggleVolunteerSection();
      updateAllAssignmentStates();
      
      document.getElementById('event-modal').classList.add('active');
    }

    function openEventDetail(backendId) {
      currentEvent = allEvents.find(e => e.__backendId === backendId);
      if (!currentEvent) return;

      const titleDisplay = currentEvent.department_name 
        ? `${currentEvent.group_name} (${currentEvent.department_name}) - ${formatDate(currentEvent.event_date)}`
        : `${currentEvent.group_name} - ${formatDate(currentEvent.event_date)}`;

      document.getElementById('modal-title').textContent = titleDisplay;
      
      // Populate form
      document.getElementById('event-status').value = currentEvent.status || 'New';
      document.getElementById('event-date').value = currentEvent.event_date || '';
      document.getElementById('event-start-time').value = currentEvent.event_start_time || '';
      document.getElementById('event-end-time').value = currentEvent.event_end_time || '';
      document.getElementById('pickup-time').value = currentEvent.pickup_time || '';
      document.getElementById('group-name').value = currentEvent.group_name || '';
      document.getElementById('department-name').value = currentEvent.department_name || '';
      document.getElementById('group-contact-name').value = currentEvent.group_contact_name || '';
      document.getElementById('group-contact-email').value = currentEvent.group_contact_email || '';
      document.getElementById('group-contact-phone').value = currentEvent.group_contact_phone || '';
      document.getElementById('event-address').value = currentEvent.event_address || '';
      document.getElementById('event-city').value = currentEvent.event_city || '';
      document.getElementById('event-state').value = currentEvent.event_state || '';
      document.getElementById('event-zip').value = currentEvent.event_zip || '';
      document.getElementById('sandwich-type').value = currentEvent.sandwich_type || '';
      document.getElementById('sandwich-count-planned').value = currentEvent.sandwich_count_planned || '';
      document.getElementById('sandwich-count-actual').value = currentEvent.sandwich_count_actual || '';
      document.getElementById('destination-name').value = currentEvent.destination_name || '';
      document.getElementById('destination-address').value = currentEvent.destination_address || '';
      document.getElementById('tsp-contact').value = currentEvent.tsp_contact || '';
      
      // Driver section
      document.getElementById('driver-needed').checked = currentEvent.driver_needed || false;
      document.getElementById('self-transport').checked = currentEvent.self_transport || false;
      document.getElementById('driver-count').value = currentEvent.driver_count || 1;
      document.getElementById('refrigerated-van-needed').checked = currentEvent.refrigerated_van_needed || false;
      // Load assigned drivers
      const driverNames = currentEvent.driver_name_assigned || '';
      assignedDrivers = Array.isArray(driverNames) ? driverNames : (driverNames ? driverNames.split(',').map(s => s.trim()).filter(s => s) : []);
      updateDriverAssignedList();
      document.getElementById('driver-present').checked = currentEvent.driver_present || false;
      toggleDriverSection();
      
      // Speaker section
      document.getElementById('speaker-needed').checked = currentEvent.speaker_needed || false;
      document.getElementById('speaker-count').value = currentEvent.speaker_count || 1;
      // Load assigned speakers
      const speakerNames = currentEvent.speaker_name_assigned || '';
      assignedSpeakers = Array.isArray(speakerNames) ? speakerNames : (speakerNames ? speakerNames.split(',').map(s => s.trim()).filter(s => s) : []);
      updateSpeakerAssignedList();
      document.getElementById('speaker-present').checked = currentEvent.speaker_present || false;
      toggleSpeakerSection();
      
      // Volunteer section
      document.getElementById('volunteer-needed').checked = currentEvent.volunteer_needed || false;
      document.getElementById('volunteer-count').value = currentEvent.volunteer_count || 1;
      // Load assigned volunteers
      const volunteerNames = currentEvent.volunteer_name_assigned || '';
      assignedVolunteers = Array.isArray(volunteerNames) ? volunteerNames : (volunteerNames ? volunteerNames.split(',').map(s => s.trim()).filter(s => s) : []);
      updateVolunteerAssignedList();
      document.getElementById('volunteer-present').checked = currentEvent.volunteer_present || false;
      toggleVolunteerSection();
      
      document.getElementById('collection-log-link').value = currentEvent.collection_log_link || '';
      document.getElementById('photo-followup').checked = currentEvent.photo_followup_done || false;
      document.getElementById('final-count-recorded').checked = currentEvent.final_sandwich_count_recorded || false;
      document.getElementById('event-notes').value = currentEvent.notes || '';

      document.getElementById('delete-button').style.display = 'block';

      // Show group history
      showGroupHistory(currentEvent.group_id || currentEvent.group_name);

      // Update assignment states based on current status
      updateAllAssignmentStates();

      document.getElementById('event-modal').classList.add('active');
    }

    function showGroupHistory(groupId) {
      const groupEvents = allEvents.filter(e => 
        (e.group_id === groupId || e.group_name === groupId) && 
        e.__backendId !== (currentEvent ? currentEvent.__backendId : null)
      );

      if (groupEvents.length === 0) {
        document.getElementById('group-history-section').style.display = 'none';
        return;
      }

      groupEvents.sort((a, b) => new Date(b.event_date) - new Date(a.event_date));

      const historyHtml = `
        <div style="background: #f8fafc; padding: 16px; border-radius: 8px;">
          <p style="margin: 0 0 12px 0; font-weight: 600; color: #475569;">
            ${groupEvents.length} previous event${groupEvents.length !== 1 ? 's' : ''} with this group
          </p>
          ${groupEvents.slice(0, 5).map(e => `
            <div style="padding: 8px 0; border-bottom: 1px solid #e2e8f0; font-size: 14px;">
              <span style="font-weight: 600;">${formatDate(e.event_date)}</span> - 
              <span class="status-badge status-${e.status.toLowerCase().replace(' ', '-')}" style="font-size: 11px;">${e.status}</span> - 
              ${e.sandwich_count_actual || e.sandwich_count_planned || '?'} sandwiches
              ${e.department_name ? `<br><span style="color: #64748b; font-size: 12px;">Dept: ${escapeHtml(e.department_name)}</span>` : ''}
            </div>
          `).join('')}
        </div>
      `;

      document.getElementById('group-history-content').innerHTML = historyHtml;
      document.getElementById('group-history-section').style.display = 'block';
    }

    function closeEventModal() {
      document.getElementById('event-modal').classList.remove('active');
      currentEvent = null;
    }

    async function saveEvent(e) {
      e.preventDefault();

      // Check if Firebase database is available
      if (!database) {
        showToast('Firebase database is not available. Please refresh the page and try again.', 'error');
        console.error('Firebase database not available when attempting to save event');
        return;
      }

      const saveButton = document.getElementById('save-button');
      const saveButtonText = document.getElementById('save-button-text');
      saveButton.disabled = true;
      saveButtonText.innerHTML = '<span class="loading-spinner"></span> Saving...';

      const formData = {
        event_id: currentEvent ? currentEvent.event_id : generateId(),
        group_name: document.getElementById('group-name').value,
        department_name: document.getElementById('department-name').value,
        group_contact_name: document.getElementById('group-contact-name').value,
        group_contact_email: document.getElementById('group-contact-email').value,
        group_contact_phone: document.getElementById('group-contact-phone').value,
        event_date: document.getElementById('event-date').value,
        event_start_time: document.getElementById('event-start-time').value,
        event_end_time: document.getElementById('event-end-time').value,
        pickup_time: document.getElementById('pickup-time').value,
        event_address: document.getElementById('event-address').value,
        event_city: document.getElementById('event-city').value,
        event_state: document.getElementById('event-state').value,
        event_zip: document.getElementById('event-zip').value,
        sandwich_type: document.getElementById('sandwich-type').value,
        sandwich_count_planned: document.getElementById('sandwich-count-planned').value.trim() || '',
        sandwich_count_actual: document.getElementById('sandwich-count-actual').value.trim() || '',
        destination_name: document.getElementById('destination-name').value,
        destination_address: document.getElementById('destination-address').value,
        tsp_contact: document.getElementById('tsp-contact').value,
        driver_needed: document.getElementById('driver-needed').checked,
        self_transport: document.getElementById('self-transport').checked,
        driver_count: parseInt(document.getElementById('driver-count').value) || 1,
        refrigerated_van_needed: document.getElementById('refrigerated-van-needed').checked,
        driver_name_assigned: Array.from(document.getElementById('driver-name').selectedOptions).map(opt => opt.value).filter(v => v).join(', '),
        driver_present: document.getElementById('driver-present').checked,
        speaker_needed: document.getElementById('speaker-needed').checked,
        speaker_count: parseInt(document.getElementById('speaker-count').value) || 1,
        speaker_name_assigned: document.getElementById('speaker-name').value,
        speaker_present: document.getElementById('speaker-present').checked,
        volunteer_needed: document.getElementById('volunteer-needed').checked,
        volunteer_count: parseInt(document.getElementById('volunteer-count').value) || 1,
        volunteer_name_assigned: document.getElementById('volunteer-name').value,
        volunteer_present: document.getElementById('volunteer-present').checked,
        status: document.getElementById('event-status').value,
        photo_followup_done: document.getElementById('photo-followup').checked,
        final_sandwich_count_recorded: document.getElementById('final-count-recorded').checked,
        collection_log_link: document.getElementById('collection-log-link').value,
        notes: document.getElementById('event-notes').value,
        group_id: document.getElementById('group-name').value.toLowerCase().replace(/\s+/g, '-'),
        event_area: document.getElementById('event-city').value || document.getElementById('event-zip').value,
        last_activity_at: new Date().toISOString()
      };

      // Set status timestamps
      const newStatus = formData.status;
      if (currentEvent) {
        formData.created_at = currentEvent.created_at;
        formData.status_new_at = currentEvent.status_new_at || null;
        formData.status_in_process_at = currentEvent.status_in_process_at || null;
        formData.status_scheduled_at = currentEvent.status_scheduled_at || null;
        formData.status_completed_at = currentEvent.status_completed_at || null;

        if (newStatus !== currentEvent.status) {
          const now = new Date().toISOString();
          if (newStatus === 'New') formData.status_new_at = now;
          else if (newStatus === 'In Process') formData.status_in_process_at = now;
          else if (newStatus === 'Scheduled') formData.status_scheduled_at = now;
          else if (newStatus === 'Completed') formData.status_completed_at = now;
        }
      } else {
        const now = new Date().toISOString();
        formData.created_at = now;
        formData.status_new_at = now;
        formData.status_in_process_at = null;
        formData.status_scheduled_at = null;
        formData.status_completed_at = null;
      }

      // Helper function to remove undefined values (Firebase doesn't allow undefined)
      const cleanData = (obj) => {
        const cleaned = {};
        Object.keys(obj).forEach(key => {
          if (obj[key] !== undefined) {
            cleaned[key] = obj[key] === undefined ? null : obj[key];
          }
        });
        return cleaned;
      };

      try {
        if (currentEvent) {
          // Update existing event
          const { __backendId, ...eventData } = formData;
          const cleanedData = cleanData(eventData);
          await database.ref(`events/${currentEvent.__backendId}`).update(cleanedData);
          showToast('Event updated successfully', 'success');
        } else {
          // Create new event
          if (allEvents.length >= 999) {
            showToast('Maximum limit of 999 events reached. Please delete some events first.', 'error');
            saveButton.disabled = false;
            saveButtonText.textContent = 'Save Event';
            return;
          }
          const cleanedData = cleanData(formData);
          await database.ref('events').push(cleanedData);
          showToast('Event created successfully', 'success');
        }
        
        // Explicitly refresh the view to ensure updates are visible
        renderCurrentView();
        closeEventModal();
      } catch (error) {
        console.error('Error saving event:', error);
        showToast('Failed to save event. Please try again.', 'error');
      }

      saveButton.disabled = false;
      saveButtonText.textContent = 'Save Event';
    }

    async function deleteEvent() {
      if (!currentEvent) return;

      // Check if Firebase database is available
      if (!database) {
        showToast('Firebase database is not available. Please refresh the page and try again.', 'error');
        console.error('Firebase database not available when attempting to delete event');
        return;
      }

      const deleteButton = document.getElementById('delete-button');
      deleteButton.disabled = true;
      deleteButton.innerHTML = '<span class="loading-spinner"></span> Deleting...';

      try {
        await database.ref(`events/${currentEvent.__backendId}`).remove();
        showToast('Event deleted successfully', 'success');
        // Explicitly refresh the view to ensure updates are visible
        renderCurrentView();
        closeEventModal();
      } catch (error) {
        console.error('Error deleting event:', error);
        showToast('Failed to delete event. Please try again.', 'error');
      }

      deleteButton.disabled = false;
      deleteButton.textContent = 'Delete Event';
    }

    // Utility functions
    function generateId() {
      return 'evt_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    function formatDate(dateStr) {
      if (!dateStr) return '‚Äî';
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      const toastMessage = document.getElementById('toast-message');
      
      toastMessage.textContent = message;
      toast.className = `toast ${type} show`;
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // Excel Import Functions
    function handleExcelImport(event) {
      const file = event.target.files[0];
      if (!file) return;

      // Check if SheetJS library is loaded
      if (typeof XLSX === 'undefined') {
        showToast('Excel library not loaded. Please refresh the page and try again.', 'error');
        console.error('SheetJS (XLSX) library is not loaded');
        event.target.value = '';
        return;
      }

      // Validate file type
      const validTypes = [
        'application/vnd.ms-excel',
        'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
        'application/vnd.ms-excel.sheet.macroEnabled.12'
      ];
      
      const fileExtension = file.name.split('.').pop().toLowerCase();
      if (!['xls', 'xlsx', 'xlsm'].includes(fileExtension)) {
        showToast('Please upload a valid Excel file (.xls or .xlsx)', 'error');
        event.target.value = '';
        return;
      }

      console.log('Reading Excel file:', file.name, 'Size:', file.size, 'bytes');

      const reader = new FileReader();
      
      reader.onerror = function(error) {
        showToast('Failed to read file. Please try again.', 'error');
        console.error('FileReader error:', error);
        event.target.value = '';
      };
      
      reader.onload = function(e) {
        try {
          console.log('File loaded, parsing Excel data...');
          
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array', cellDates: true });
          
          console.log('Workbook loaded. Sheets:', workbook.SheetNames);
          
          if (!workbook.SheetNames || workbook.SheetNames.length === 0) {
            showToast('No sheets found in Excel file', 'error');
            return;
          }
          
          // Get first sheet
          const firstSheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[firstSheetName];
          
          console.log('Reading sheet:', firstSheetName);
          
          if (!worksheet) {
            showToast('Could not read worksheet data', 'error');
            return;
          }
          
          // Convert to JSON with better options
          const jsonData = XLSX.utils.sheet_to_json(worksheet, { 
            raw: false,
            defval: '',
            blankrows: false
          });
          
          console.log('Parsed rows:', jsonData.length);
          
          if (jsonData.length === 0) {
            showToast('No data rows found in Excel file. Make sure your file has headers and data.', 'error');
            return;
          }

          // Log first row to help debug column names
          console.log('=== EXCEL COLUMN DETECTION ===');
          console.log('First row columns:', Object.keys(jsonData[0]));
          console.log('Sample data:', jsonData[0]);
          console.log('All column names (case-sensitive):', Object.keys(jsonData[0]).map(k => `"${k}"`).join(', '));

          // Parse and prepare data
          pendingImportData = parseExcelData(jsonData);
          
          if (pendingImportData.length === 0) {
            showToast('No valid events found. Check that your Excel has "Group Name" and "Event Date" columns.', 'error');
            return;
          }

          console.log('Successfully parsed', pendingImportData.length, 'events');

          // Show preview
          showImportPreview(pendingImportData);
          
        } catch (error) {
          showToast('Error reading Excel file: ' + error.message, 'error');
          console.error('Import error details:', error);
          console.error('Error stack:', error.stack);
        }
      };
      
      reader.readAsArrayBuffer(file);
      event.target.value = ''; // Reset input
    }

    function parseExcelData(jsonData) {
      const events = [];
      const errors = [];
      
      jsonData.forEach((row, index) => {
        // Skip completely empty rows
        const hasAnyData = Object.values(row).some(val => val !== null && val !== undefined && val !== '');
        if (!hasAnyData) return;

        // Skip rows without minimum required data
        if (!row['Group Name'] || !row['Event Date']) {
          errors.push(`Row ${index + 2}: Missing Group Name or Event Date`);
          return;
        }

        try {
          // Parse date - handle various Excel date formats
          let eventDate = '';
          if (row['Event Date']) {
            const dateValue = row['Event Date'];
            if (typeof dateValue === 'number') {
              // Excel serial date
              const excelDate = XLSX.SSF.parse_date_code(dateValue);
              eventDate = `${excelDate.y}-${String(excelDate.m).padStart(2, '0')}-${String(excelDate.d).padStart(2, '0')}`;
            } else if (typeof dateValue === 'string') {
              // Try to parse string date (MM/DD/YYYY, YYYY-MM-DD, etc.)
              const parsed = new Date(dateValue);
              if (!isNaN(parsed)) {
                eventDate = parsed.toISOString().split('T')[0];
              } else {
                // Try manual parsing for common formats
                const parts = dateValue.split(/[-\/]/);
                if (parts.length === 3) {
                  // Assume MM/DD/YYYY or YYYY-MM-DD
                  if (parts[0].length === 4) {
                    eventDate = `${parts[0]}-${String(parts[1]).padStart(2, '0')}-${String(parts[2]).padStart(2, '0')}`;
                  } else {
                    const year = parts[2].length === 2 ? '20' + parts[2] : parts[2];
                    eventDate = `${year}-${String(parts[0]).padStart(2, '0')}-${String(parts[1]).padStart(2, '0')}`;
                  }
                }
              }
            }
          }

          if (!eventDate) {
            errors.push(`Row ${index + 2}: Invalid date format`);
            return;
          }

          // Helper function to find column value (case-insensitive, handles variations)
          const getColumnValue = (possibleNames) => {
            for (const name of possibleNames) {
              // Try exact match first
              if (row[name] !== undefined && row[name] !== null && row[name] !== '') {
                return row[name];
              }
              // Try case-insensitive match
              const rowKeys = Object.keys(row);
              const matchedKey = rowKeys.find(key => key.toLowerCase().trim() === name.toLowerCase().trim());
              if (matchedKey && row[matchedKey] !== undefined && row[matchedKey] !== null && row[matchedKey] !== '') {
                return row[matchedKey];
              }
            }
            return null;
          };

          // Parse numbers safely - using actual Excel column names
          const sandwichPlanned = getColumnValue(['Estimate # sandwiches', 'Estimate # Sandwiches', 'Estimate sandwiches', 'Sandwich Count (Planned)', 'Sandwich Count Planned', 'Planned Count', 'Planned', 'Sandwiches Planned', 'Planned Sandwiches', 'Sandwich Count', 'Count (Planned)', 'Count Planned']);
          const sandwichActual = getColumnValue(['Final # sandwiches made', 'Final # Sandwiches Made', 'Final sandwiches made', 'Sandwich Count (Actual)', 'Sandwich Count Actual', 'Actual Count', 'Actual', 'Sandwiches Actual', 'Actual Sandwiches', 'Count (Actual)', 'Count Actual']);
          
          // Debug logging for first row
          if (index === 0) {
            console.log('üîç DEBUG: Looking for sandwich count columns...');
            console.log('  Available columns:', Object.keys(row));
            console.log('  Sandwich Planned value:', sandwichPlanned, 'Type:', typeof sandwichPlanned);
            console.log('  Sandwich Actual value:', sandwichActual, 'Type:', typeof sandwichActual);
          }
          
          // Parse to number or range (e.g., "50", "50-100", "50 to 100")
          const parseSandwichCount = (value) => {
            if (!value || value === null || value === undefined) return null;
            const str = String(value).trim();
            if (!str) return null;
            
            // Check for range patterns: "50-100", "50 to 100", "50 - 100", etc.
            const rangeMatch = str.match(/^(\d+)\s*(?:-|to)\s*(\d+)$/i);
            if (rangeMatch) {
              const min = parseInt(rangeMatch[1]);
              const max = parseInt(rangeMatch[2]);
              if (!isNaN(min) && !isNaN(max) && min <= max) {
                return `${min}-${max}`;
              }
            }
            
            // Try to parse as single number
            const numMatch = str.match(/^\d+$/);
            if (numMatch) {
              return numMatch[0];
            }
            
            // If it contains numbers, try to extract first number as fallback
            const numExtract = str.match(/\d+/);
            if (numExtract) {
              return numExtract[0];
            }
            
            return null;
          };
          
          let sandwichPlannedNum = parseSandwichCount(sandwichPlanned);
          let sandwichActualNum = parseSandwichCount(sandwichActual);
          
          if (index === 0) {
            console.log('  Parsed Planned:', sandwichPlannedNum, 'from:', sandwichPlanned);
            console.log('  Parsed Actual:', sandwichActualNum, 'from:', sandwichActual);
          }

          // Parse booleans - handle various formats
          const parseBoolean = (val) => {
            if (!val) return false;
            const str = String(val).toLowerCase().trim();
            if (str === 'true' || str === 'yes' || str === '1' || str === 'y' || val === true || val === 1) {
              return true;
            }
            return false;
          };

          const driverNeeded = parseBoolean(getColumnValue(['Driver Needed', 'Needs Driver', 'Driver Required']));
          const driverCount = parseInt(String(getColumnValue(['Driver Count', 'Number of Drivers', 'Drivers']) || '1').replace(/[^0-9]/g, '')) || 1;
          const refrigeratedVanNeeded = parseBoolean(getColumnValue(['Van Booked?', 'Refrigerated Van Needed', 'Refrigerated Van', 'Van Needed', 'Cooler Van']));
          const driverPresent = parseBoolean(getColumnValue(['Driver Present', 'Driver Attended', 'Driver Showed Up']));
          
          const speakerNeeded = parseBoolean(getColumnValue(['Speaker Needed', 'Needs Speaker', 'Speaker Required']));
          const speakerCount = parseInt(String(getColumnValue(['Speaker Count', 'Number of Speakers', 'Speakers']) || '1').replace(/[^0-9]/g, '')) || 1;
          const speakerPresent = parseBoolean(getColumnValue(['Speaker Present', 'Speaker Attended', 'Speaker Showed Up']));
          
          const volunteerNeeded = parseBoolean(getColumnValue(['Volunteer Needed', 'Volunteers Needed', 'Needs Volunteers', 'Volunteers Required']));
          const volunteerCount = parseInt(String(getColumnValue(['Volunteer Count', 'Number of Volunteers', 'Volunteers']) || '1').replace(/[^0-9]/g, '')) || 1;
          const volunteerPresent = parseBoolean(getColumnValue(['Volunteer Present', 'Volunteers Present', 'Volunteer Attended']));
          
          const photoFollowup = parseBoolean(getColumnValue(['Photo Follow-up Done', 'Photo Followup Done', 'Photo Follow Up', 'Photos Done']));
          const finalCountRecorded = parseBoolean(getColumnValue(['Final Sandwich Count Recorded', 'Final Count Recorded', 'Count Recorded']));

          // Validate status - check Cancelled column first
          const validStatuses = ['New', 'In Process', 'Scheduled', 'Completed', 'Canceled'];
          let status = 'New';
          const cancelled = getColumnValue(['Cancelled', 'Canceled']);
          if (cancelled && parseBoolean(cancelled)) {
            status = 'Canceled';
          } else {
            const statusValue = getColumnValue(['Status', 'Event Status', 'State']);
            if (statusValue) {
              status = String(statusValue).trim();
              if (!validStatuses.includes(status)) {
                status = 'New';
              }
            }
          }

          const event = {
            event_id: generateId(),
            group_name: String(getColumnValue(['Group Name', 'Group', 'Organization']) || '').trim(),
            department_name: String(getColumnValue(['Department Name', 'Department']) || '').trim(),
            group_contact_name: String(getColumnValue(['Contact Name', 'Group Contact Name', 'Contact']) || '').trim(),
            group_contact_email: String(getColumnValue(['Email Address', 'Group Contact Email', 'Contact Email', 'Email']) || '').trim(),
            group_contact_phone: String(getColumnValue(['Contact Cell Number', 'Group Contact Phone', 'Contact Phone', 'Phone']) || '').trim(),
            event_date: eventDate,
            event_start_time: String(getColumnValue(['Event Start time (MUST when volunteer needed)', 'Event Start Time', 'Start Time', 'Event Time']) || '').trim(),
            event_end_time: String(getColumnValue(['Event end time (MUST when volunteer needed)', 'Event End Time', 'End Time']) || '').trim(),
            pickup_time: String(getColumnValue(['Pick up time', 'Pickup Time', 'Pickup']) || '').trim(),
            event_address: String(getColumnValue(['Address', 'Event Address', 'Event Location']) || '').trim(),
            event_city: String(getColumnValue(['Event City', 'City']) || '').trim(),
            event_state: String(getColumnValue(['Event State', 'State']) || '').trim().toUpperCase().substring(0, 2),
            event_zip: String(getColumnValue(['Event Zip', 'Zip', 'Zip Code']) || '').trim(),
            sandwich_type: String(getColumnValue(['Deli or PBJ?', 'Sandwich Type', 'Type']) || '').trim(),
            sandwich_count_planned: sandwichPlannedNum || '',
            sandwich_count_actual: sandwichActualNum || '',
            destination_name: String(getColumnValue(['Planned Recipient/Host Home', 'Destination Name', 'Destination', 'Delivery Destination']) || '').trim(),
            destination_address: String(getColumnValue(['Destination Address', 'Delivery Address']) || '').trim(),
            tsp_contact: String(getColumnValue(['TSP Contact', 'Contact Person', 'Coordinator']) || '').trim(),
            driver_needed: driverNeeded,
            driver_count: driverCount,
            refrigerated_van_needed: refrigeratedVanNeeded,
            driver_name_assigned: String(getColumnValue(['Driver Name', 'Driver', 'Assigned Driver']) || '').trim(),
            driver_present: driverPresent,
            speaker_needed: speakerNeeded,
            speaker_count: speakerCount,
            speaker_name_assigned: String(getColumnValue(['Speaker Name', 'Speaker', 'Assigned Speaker']) || '').trim(),
            speaker_present: speakerPresent,
            volunteer_needed: volunteerNeeded,
            volunteer_count: volunteerCount,
            volunteer_name_assigned: String(getColumnValue(['Volunteer Name', 'Volunteers', 'Assigned Volunteers']) || '').trim(),
            volunteer_present: volunteerPresent,
            status: status,
            created_at: new Date().toISOString(),
            status_new_at: new Date().toISOString(),
            status_in_process_at: null,
            status_scheduled_at: null,
            status_completed_at: null,
            last_activity_at: new Date().toISOString(),
            photo_followup_done: photoFollowup,
            final_sandwich_count_recorded: finalCountRecorded,
            collection_log_link: String(getColumnValue(['Collection Log Link', 'Log Link', 'Collection Log']) || '').trim(),
            notes: String((getColumnValue(['Notes', 'Note']) || '') + (getColumnValue(['Add\'l Notes', 'Add\'l Notes', 'Additional Notes']) ? '\n\n' + getColumnValue(['Add\'l Notes', 'Add\'l Notes', 'Additional Notes']) : '')).trim(),
            group_id: String(getColumnValue(['Group Name', 'Group', 'Organization']) || '').toLowerCase().replace(/\s+/g, '-'),
            event_area: String(getColumnValue(['Event City', 'City']) || getColumnValue(['Event Zip', 'Zip']) || '').trim()
          };

          events.push(event);
        } catch (error) {
          errors.push(`Row ${index + 2}: ${error.message}`);
          console.error(`Error parsing row ${index + 2}:`, error, row);
        }
      });

      // Log errors for debugging
      if (errors.length > 0) {
        console.log('Import errors:', errors);
      }

      console.log(`=== EXCEL PARSE COMPLETE ===`);
      console.log(`Total rows in Excel: ${jsonData.length}`);
      console.log(`Successfully parsed: ${events.length}`);
      console.log(`Parse errors: ${errors.length}`);

      return events;
    }

    function showImportPreview(events) {
      const previewHtml = `
        <div style="margin-bottom: 20px;">
          <p style="font-size: 16px; font-weight: 600; color: #1a202c; margin-bottom: 8px;">
            Ready to import ${events.length} event${events.length !== 1 ? 's' : ''}
          </p>
          <p style="font-size: 14px; color: #64748b; margin-bottom: 16px;">
            These events will be added to your dashboard. You can review and edit them after import.
          </p>
        </div>
        
        <div style="max-height: 300px; overflow-y: auto; background: #f8fafc; border-radius: 8px; padding: 16px;">
          ${events.slice(0, 10).map(e => `
            <div style="padding: 8px 0; border-bottom: 1px solid #e2e8f0; font-size: 14px;">
              <strong>${escapeHtml(e.group_name)}</strong>${e.department_name ? ` (${escapeHtml(e.department_name)})` : ''} - ${formatDate(e.event_date)} 
              ${e.sandwich_count_planned ? `(${e.sandwich_count_planned} sandwiches)` : ''}
            </div>
          `).join('')}
          ${events.length > 10 ? `
            <div style="padding: 12px 0; color: #64748b; font-size: 13px; text-align: center;">
              ... and ${events.length - 10} more events
            </div>
          ` : ''}
        </div>

        ${(() => {
          // Count new vs existing events
          let newCount = 0;
          let updateCount = 0;
          events.forEach(event => {
            const existing = allEvents.find(e => 
              e.group_name === event.group_name && 
              e.event_date === event.event_date
            );
            if (existing) {
              updateCount++;
            } else {
              newCount++;
            }
          });
          
          if (allEvents.length + newCount > 999) {
            return `
              <div style="margin-top: 16px; padding: 12px; background: #fee2e2; border-left: 4px solid #a31c41; border-radius: 6px;">
                <p style="margin: 0; color: #991b1b; font-weight: 600;">‚ö†Ô∏è Warning: Import would exceed 999 event limit</p>
                <p style="margin: 8px 0 0 0; color: #991b1b; font-size: 13px;">
                  You currently have ${allEvents.length} events. This import will update ${updateCount} existing events and add ${newCount} new events, which would exceed the maximum of 999 events (${allEvents.length + newCount} total).
                  ${updateCount > 0 ? `<br><br>Note: ${updateCount} events will be updated (not counted as new).` : ''}
                </p>
              </div>
            `;
          } else if (updateCount > 0) {
            return `
              <div style="margin-top: 16px; padding: 12px; background: #e0f2fe; border-left: 4px solid #0369a1; border-radius: 6px;">
                <p style="margin: 0; color: #0c4a6e; font-weight: 600;">‚ÑπÔ∏è Import Preview</p>
                <p style="margin: 8px 0 0 0; color: #0c4a6e; font-size: 13px;">
                  ${updateCount} existing events will be updated, ${newCount} new events will be created.
                </p>
              </div>
            `;
          }
          return '';
        })()}
      `;

      document.getElementById('import-preview').innerHTML = previewHtml;
      
      // Disable import button if would exceed limit (only count new events)
      const importButton = document.getElementById('confirm-import-button');
      let newEventCount = 0;
      events.forEach(event => {
        const existing = allEvents.find(e => 
          e.group_name === event.group_name && 
          e.event_date === event.event_date
        );
        if (!existing) {
          newEventCount++;
        }
      });
      
      if (allEvents.length + newEventCount > 999) {
        importButton.disabled = true;
      } else {
        importButton.disabled = false;
      }
      
      document.getElementById('import-modal').classList.add('active');
    }

    function closeImportModal() {
      document.getElementById('import-modal').classList.remove('active');
      pendingImportData = [];
    }

    async function confirmImport() {
      if (pendingImportData.length === 0) return;

      // Count how many events in the import are new vs existing
      let newEventCount = 0;
      for (const event of pendingImportData) {
        const existingEvent = allEvents.find(e => 
          e.group_name === event.group_name && 
          e.event_date === event.event_date
        );
        if (!existingEvent) {
          newEventCount++;
        }
      }

      // Only check limit for NEW events (updates don't count toward limit)
      if (allEvents.length + newEventCount > 999) {
        showToast(`Cannot import: would exceed 999 event limit. ${pendingImportData.length - newEventCount} events will be updated, but ${newEventCount} new events would exceed the limit.`, 'error');
        return;
      }

      // Check if Firebase database is available
      if (!database) {
        showToast('Firebase database is not available. Please refresh the page and try again.', 'error');
        console.error('Firebase database not available');
        return;
      }

      const importButton = document.getElementById('confirm-import-button');
      const importButtonText = document.getElementById('import-button-text');
      importButton.disabled = true;

      console.log(`=== STARTING FIREBASE IMPORT ===`);
      console.log(`Attempting to import ${pendingImportData.length} events`);

      let successCount = 0;
      let errorCount = 0;
      const importErrors = [];

      // Use Firebase batch write for better performance
      const eventsRef = database.ref('events');
      
      for (let i = 0; i < pendingImportData.length; i++) {
        const event = pendingImportData[i];
        
        // Update progress
        importButtonText.innerHTML = `<span class="loading-spinner"></span> Importing ${i + 1}/${pendingImportData.length}...`;
        
        console.log(`[${i + 1}/${pendingImportData.length}] Importing: ${event.group_name} - ${formatDate(event.event_date)}`);
        
        try {
          // Check if event already exists (match by group_name and event_date)
          const existingEvent = allEvents.find(e => 
            e.group_name === event.group_name && 
            e.event_date === event.event_date
          );
          
          if (existingEvent) {
            // Update existing event - merge data, filling in blanks
            console.log(`  üîÑ Found existing event, updating...`);
            const mergedEvent = { ...existingEvent, ...event };
            // Preserve the Firebase ID and timestamps
            mergedEvent.__backendId = existingEvent.__backendId;
            mergedEvent.created_at = existingEvent.created_at;
            mergedEvent.last_activity_at = new Date().toISOString();
            
            // Only update fields that have values in the import (don't overwrite with empty strings)
            const updateData = {};
            Object.keys(event).forEach(key => {
              // Skip internal fields
              if (key === '__backendId' || key === 'event_id' || key === 'created_at') return;
              
              const value = event[key];
              // Update if value is not null/undefined/empty string
              // Allow 0 and false as valid values
              if (value !== null && value !== undefined && value !== '') {
                updateData[key] = value;
              } else if (value === 0 || value === false) {
                // Explicitly allow 0 and false to be updated
                updateData[key] = value;
              }
            });
            
            // Special handling for sandwich counts - always update if they exist in the import (even if 0)
            if (event.sandwich_count_planned !== undefined && event.sandwich_count_planned !== null) {
              updateData.sandwich_count_planned = event.sandwich_count_planned;
            }
            if (event.sandwich_count_actual !== undefined && event.sandwich_count_actual !== null) {
              updateData.sandwich_count_actual = event.sandwich_count_actual;
            }
            
            // Remove any undefined values (Firebase doesn't allow undefined)
            Object.keys(updateData).forEach(key => {
              if (updateData[key] === undefined) {
                delete updateData[key];
              }
            });
            
            console.log(`  üìù Updating ${Object.keys(updateData).length} fields:`, Object.keys(updateData));
            if (updateData.sandwich_count_planned !== undefined || updateData.sandwich_count_actual !== undefined) {
              console.log(`  üìä Sandwich counts - Planned: ${updateData.sandwich_count_planned ?? '(not updating)'}, Actual: ${updateData.sandwich_count_actual ?? '(not updating)'}`);
              console.log(`  üìä Original event had - Planned: ${existingEvent.sandwich_count_planned ?? '?'}, Actual: ${existingEvent.sandwich_count_actual ?? '?'}`);
            }
            
            await database.ref(`events/${existingEvent.__backendId}`).update(updateData);
            successCount++;
            console.log(`  ‚úÖ UPDATED existing event (ID: ${existingEvent.__backendId})`);
          } else {
            // Create new event
            const newEventRef = eventsRef.push();
            await newEventRef.set(event);
            successCount++;
            console.log(`  ‚úÖ CREATED new event (ID: ${newEventRef.key})`);
          }
          
          // Small delay to avoid overwhelming Firebase
          if (i < pendingImportData.length - 1) {
            await new Promise(resolve => setTimeout(resolve, 100));
          }
        } catch (error) {
          errorCount++;
          const errorMsg = `${event.group_name} (${formatDate(event.event_date)}): ${error.message || 'Unknown error'}`;
          importErrors.push(errorMsg);
          console.error(`  ‚ùå FAILED:`, error.message || error);
          console.error(`  Event data:`, event);
        }
      }

      console.log(`=== IMPORT COMPLETE ===`);
      console.log(`‚úÖ Successful: ${successCount}`);
      console.log(`‚ùå Failed: ${errorCount}`);
      
      if (importErrors.length > 0) {
        console.log(`\n=== FAILED EVENTS ===`);
        importErrors.forEach((err, idx) => {
          console.log(`${idx + 1}. ${err}`);
        });
      }

      importButton.disabled = false;
      importButtonText.textContent = 'Import Events';

      closeImportModal();

      if (errorCount === 0) {
        showToast(`Successfully imported ${successCount} event${successCount !== 1 ? 's' : ''}!`, 'success');
      } else {
        showToast(`Imported ${successCount} events, ${errorCount} failed - check console (F12)`, 'error');
      }
    }

    // Role Management Functions
    function openRoleManagementModal() {
      loadRoleLists();
      document.getElementById('role-management-modal').classList.add('active');
    }

    function closeRoleManagementModal() {
      document.getElementById('role-management-modal').classList.remove('active');
    }

    function loadRoleLists() {
      if (!database) {
        // Fallback to localStorage
        const stored = localStorage.getItem('roleLists');
        if (stored) {
          try {
            roleLists = JSON.parse(stored);
          } catch (e) {
            console.error('Error parsing stored role lists:', e);
          }
        }
        populateRoleManagementFields();
        return;
      }

      database.ref('roleLists').once('value')
        .then(snapshot => {
          const data = snapshot.val();
          if (data) {
            roleLists = {
              drivers: data.drivers || [],
              speakers: data.speakers || [],
              volunteers: data.volunteers || []
            };
          }
          populateRoleManagementFields();
          populateRoleDropdowns();
        })
        .catch(error => {
          console.error('Error loading role lists:', error);
          // Fallback to localStorage
          const stored = localStorage.getItem('roleLists');
          if (stored) {
            try {
              roleLists = JSON.parse(stored);
            } catch (e) {
              console.error('Error parsing stored role lists:', e);
            }
          }
          populateRoleManagementFields();
          populateRoleDropdowns();
        });
    }

    function populateRoleManagementFields() {
      document.getElementById('drivers-list').value = roleLists.drivers.join('\n');
      document.getElementById('speakers-list').value = roleLists.speakers.join('\n');
      document.getElementById('volunteers-list').value = roleLists.volunteers.join('\n');
    }

    function populateRoleDropdowns() {
      // Populate driver dropdown
      const driverSelect = document.getElementById('driver-name-select');
      if (driverSelect) {
        driverSelect.innerHTML = '<option value="">-- Select Driver --</option>' +
          roleLists.drivers.map(name => `<option value="${escapeHtml(name)}">${escapeHtml(name)}</option>`).join('');
      }

      // Populate speaker dropdown
      const speakerSelect = document.getElementById('speaker-name-select');
      if (speakerSelect) {
        speakerSelect.innerHTML = '<option value="">-- Select Speaker --</option>' +
          roleLists.speakers.map(name => `<option value="${escapeHtml(name)}">${escapeHtml(name)}</option>`).join('');
      }

      // Populate volunteer dropdown
      const volunteerSelect = document.getElementById('volunteer-name-select');
      if (volunteerSelect) {
        volunteerSelect.innerHTML = '<option value="">-- Select Volunteer --</option>' +
          roleLists.volunteers.map(name => `<option value="${escapeHtml(name)}">${escapeHtml(name)}</option>`).join('');
      }
    }

    // Assignment functions
    let assignedDrivers = [];
    let assignedSpeakers = [];
    let assignedVolunteers = [];

    function assignDriver() {
      const select = document.getElementById('driver-name-select');
      const name = select.value.trim();
      if (!name) {
        showToast('Please select a driver', 'error');
        return;
      }
      if (assignedDrivers.includes(name)) {
        showToast('This driver is already assigned', 'error');
        return;
      }
      assignedDrivers.push(name);
      updateDriverAssignedList();
      select.value = '';
      showToast(`Assigned: ${name}`, 'success');
    }

    function assignSpeaker() {
      const select = document.getElementById('speaker-name-select');
      const name = select.value.trim();
      if (!name) {
        showToast('Please select a speaker', 'error');
        return;
      }
      if (assignedSpeakers.includes(name)) {
        showToast('This speaker is already assigned', 'error');
        return;
      }
      assignedSpeakers.push(name);
      updateSpeakerAssignedList();
      select.value = '';
      showToast(`Assigned: ${name}`, 'success');
    }

    function assignVolunteer() {
      const select = document.getElementById('volunteer-name-select');
      const name = select.value.trim();
      if (!name) {
        showToast('Please select a volunteer', 'error');
        return;
      }
      if (assignedVolunteers.includes(name)) {
        showToast('This volunteer is already assigned', 'error');
        return;
      }
      assignedVolunteers.push(name);
      updateVolunteerAssignedList();
      select.value = '';
      showToast(`Assigned: ${name}`, 'success');
    }

    function removeDriver(name) {
      assignedDrivers = assignedDrivers.filter(n => n !== name);
      updateDriverAssignedList();
    }

    function removeSpeaker(name) {
      assignedSpeakers = assignedSpeakers.filter(n => n !== name);
      updateSpeakerAssignedList();
    }

    function removeVolunteer(name) {
      assignedVolunteers = assignedVolunteers.filter(n => n !== name);
      updateVolunteerAssignedList();
    }

    function updateDriverAssignedList() {
      const listDiv = document.getElementById('driver-assigned-list');
      const hiddenInput = document.getElementById('driver-name');
      const value = assignedDrivers.join(', ');
      hiddenInput.value = value;
      
      if (assignedDrivers.length === 0) {
        listDiv.innerHTML = '<div style="color: #94a3b8; font-size: 13px; padding: 8px;">No drivers assigned</div>';
      } else {
        listDiv.innerHTML = assignedDrivers.map(name => `
          <div style="display: flex; align-items: center; justify-content: space-between; padding: 8px 12px; margin-bottom: 4px; background: #f1f5f9; border-radius: 6px; font-size: 14px;">
            <span>${escapeHtml(name)}</span>
            <button type="button" onclick="removeDriver('${escapeHtml(name)}')" style="background: #ef4444; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;">Remove</button>
          </div>
        `).join('');
      }
    }

    function updateSpeakerAssignedList() {
      const listDiv = document.getElementById('speaker-assigned-list');
      const hiddenInput = document.getElementById('speaker-name');
      const value = assignedSpeakers.join(', ');
      hiddenInput.value = value;
      
      if (assignedSpeakers.length === 0) {
        listDiv.innerHTML = '<div style="color: #94a3b8; font-size: 13px; padding: 8px;">No speakers assigned</div>';
      } else {
        listDiv.innerHTML = assignedSpeakers.map(name => `
          <div style="display: flex; align-items: center; justify-content: space-between; padding: 8px 12px; margin-bottom: 4px; background: #f1f5f9; border-radius: 6px; font-size: 14px;">
            <span>${escapeHtml(name)}</span>
            <button type="button" onclick="removeSpeaker('${escapeHtml(name)}')" style="background: #ef4444; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;">Remove</button>
          </div>
        `).join('');
      }
    }

    function updateVolunteerAssignedList() {
      const listDiv = document.getElementById('volunteer-assigned-list');
      const hiddenInput = document.getElementById('volunteer-name');
      const value = assignedVolunteers.join(', ');
      hiddenInput.value = value;
      
      if (assignedVolunteers.length === 0) {
        listDiv.innerHTML = '<div style="color: #94a3b8; font-size: 13px; padding: 8px;">No volunteers assigned</div>';
      } else {
        listDiv.innerHTML = assignedVolunteers.map(name => `
          <div style="display: flex; align-items: center; justify-content: space-between; padding: 8px 12px; margin-bottom: 4px; background: #f1f5f9; border-radius: 6px; font-size: 14px;">
            <span>${escapeHtml(name)}</span>
            <button type="button" onclick="removeVolunteer('${escapeHtml(name)}')" style="background: #ef4444; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;">Remove</button>
          </div>
        `).join('');
      }
    }

    function saveRoleList(roleType) {
      const textareaId = `${roleType}-list`;
      const textarea = document.getElementById(textareaId);
      const names = textarea.value.split('\n')
        .map(line => line.trim())
        .filter(line => line.length > 0);
      
      roleLists[roleType] = names;
      
      // Save to Firebase
      if (database) {
        database.ref('roleLists').set(roleLists)
          .then(() => {
            showToast(`${roleType.charAt(0).toUpperCase() + roleType.slice(1)} list saved successfully!`, 'success');
            populateRoleDropdowns();
          })
          .catch(error => {
            console.error('Error saving role lists to Firebase:', error);
            // Fallback to localStorage
            localStorage.setItem('roleLists', JSON.stringify(roleLists));
            showToast(`${roleType.charAt(0).toUpperCase() + roleType.slice(1)} list saved locally!`, 'success');
            populateRoleDropdowns();
          });
      } else {
        // Fallback to localStorage
        localStorage.setItem('roleLists', JSON.stringify(roleLists));
        showToast(`${roleType.charAt(0).toUpperCase() + roleType.slice(1)} list saved locally!`, 'success');
        populateRoleDropdowns();
      }
    }

    function exportRoleLists() {
      const data = {
        drivers: roleLists.drivers.join('\n'),
        speakers: roleLists.speakers.join('\n'),
        volunteers: roleLists.volunteers.join('\n')
      };
      
      const content = `DRIVERS\n${data.drivers}\n\nSPEAKERS\n${data.speakers}\n\nVOLUNTEERS\n${data.volunteers}`;
      const blob = new Blob([content], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'role-lists.txt';
      a.click();
      URL.revokeObjectURL(url);
    }

    function importRoleListsFromFile(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        const content = e.target.result;
        const lines = content.split('\n').map(line => line.trim()).filter(line => line.length > 0);
        
        let currentSection = null;
        const imported = { drivers: [], speakers: [], volunteers: [] };
        
        lines.forEach(line => {
          if (line.toUpperCase() === 'DRIVERS') {
            currentSection = 'drivers';
          } else if (line.toUpperCase() === 'SPEAKERS') {
            currentSection = 'speakers';
          } else if (line.toUpperCase() === 'VOLUNTEERS') {
            currentSection = 'volunteers';
          } else if (currentSection) {
            imported[currentSection].push(line);
          }
        });
        
        // If no section headers, assume all lines are for all roles
        if (!imported.drivers.length && !imported.speakers.length && !imported.volunteers.length) {
          imported.drivers = [...lines];
          imported.speakers = [...lines];
          imported.volunteers = [...lines];
        }
        
        roleLists = imported;
        populateRoleManagementFields();
        showToast('Role lists imported! Click "Save" buttons to save each list.', 'success');
      };
      reader.readAsText(file);
    }
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9a6c9564c76d457e',t:'MTc2NDUyOTE4My4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>